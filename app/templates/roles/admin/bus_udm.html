{% extends "roles/admin/_base_admin.html" %}
{% from 'shared/macros/tableaux_components.html' import table_container, status_badge, level_indicator, voyant_indicator, icon_cell, date_cell, money_cell, number_cell %}

{% block title %}Liste des Bus UdM{% endblock %}

{% set active_page = 'bus_udm' %}
{% set page_title = 'Liste des Bus UdM' %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkfHcA21fZyMcJ6r0F/YvC3etwFh0qU6V7qX+6lGJ3j1b8d+6K/Y3GZ3g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modals.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tableaux.css') }}">
    <script src="{{ url_for('static', filename='js/tableaux.js') }}"></script>
    <style>
      /* Styles spécifiques à la page Bus UdM Admin */
      #docFormModal, #addBusModal {
        z-index: 10000;
      }

      /* Styles pour les détails de bus */
      .details-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .details-list li {
        padding: 8px 0;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .details-list li:last-child {
        border-bottom: none;
      }

      .details-label {
        font-weight: 600;
        color: #374151;
        min-width: 120px;
      }

      .details-value {
        color: #6b7280;
        text-align: right;
      }

      .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      .btn-print {
        background: #10b981;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .btn-print:hover {
        background: #059669;
      }

      .close-btn {
        background: #6b7280;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
      }

      .close-btn:hover {
        background: #4b5563;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
      }

      .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .empty-state h5 {
        margin: 0 0 8px 0;
        font-size: 18px;
        font-weight: 600;
      }

      .empty-state p {
        margin: 0;
        font-size: 14px;
      }

      .loading-state {
        text-align: center;
        padding: 20px;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    </style>
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
    <!-- En-tête du tableau avec bouton d'ajout -->
    <div class="table-container" id="busTable">
        <div class="table-header">
            <div class="d-flex justify-content-between align-items-center w-100">
                <div>
                    <h3 class="table-title">
                        <i class="fas fa-bus"></i>
                        Liste des Bus UdM
                    </h3>
                    <p class="table-subtitle">Gestion de la flotte universitaire</p>
                </div>
                <button id="openAddBusModal" class="btn btn-success d-flex align-items-center gap-2" title="Ajouter un Bus UdM">
                    <i class="fas fa-plus"></i>
                    <span>Ajouter un bus</span>
                </button>
            </div>
        </div>
        <div class="table-search">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="form-control search-input" placeholder="Rechercher un bus..." id="searchInput">
            </div>
        </div>

        <table class="table table-striped table-hover sortable">
            <thead>
                <tr>
                    <th>Numéro</th>
                    <th>Immatriculation</th>
                    <th>Kilométrage</th>
                    <th>État</th>
                    <th>Capacité</th>
                    <th class="no-sort">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for bus in bus_list %}
                <tr>
                    <td>{{ number_cell(bus.numero) }}</td>
                    <td>
                        {% if bus.immatriculation %}
                            <strong>{{ bus.immatriculation }}</strong>
                        {% else %}
                            <span class="text-muted">Non défini</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if bus.kilometrage %}
                            {{ icon_cell('tachometer-alt', "{:,}".format(bus.kilometrage) + ' km') }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if bus.etat_vehicule == 'OPERATIONNEL' %}
                            {{ status_badge('Opérationnel', 'success', 'check-circle') }}
                        {% elif bus.etat_vehicule == 'DEFAILLANT' %}
                            {{ status_badge('Défaillant', 'danger', 'exclamation-triangle') }}
                        {% elif bus.etat_vehicule == 'MAINTENANCE' %}
                            {{ status_badge('Maintenance', 'warning', 'wrench') }}
                        {% else %}
                            {{ status_badge(bus.etat_vehicule or 'Inconnu', 'secondary') }}
                        {% endif %}
                    </td>
                    <td>
                        {% if bus.nombre_places %}
                            {{ icon_cell('users', bus.nombre_places|string + ' places') }}
                        {% else %}
                            <span class="text-muted">Non défini</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="table-btn view" onclick="showBusDetails({{ bus.id }})" title="Voir la fiche">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="table-btn action" onclick="openPanneModal('{{ bus.numero }}', '{{ bus.immatriculation|default('', true) }}', {{ bus.kilometrage or 0 }})" title="Déclarer panne">
                                <i class="fas fa-exclamation-triangle"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="table-empty">
                        <i class="fas fa-bus"></i>
                        <h5>Aucun bus enregistré</h5>
                        <p>Cliquez sur le bouton + pour ajouter votre premier bus.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Actions rapides (toutes visibles côté admin) -->
    <div class="quick-actions" style="margin-top:30px;">
        <h2 class="section-title">
            <i class="fas fa-tools"></i>
            Opérations
        </h2>
        <div class="actions-grid">
            <a href="{{ url_for('admin.carburation') }}" class="action-btn">
                <i class="fas fa-gas-pump"></i>
                <span>Carburation</span>
            </a>
            <a href="{{ url_for('admin.vidange') }}" class="action-btn">
                <i class="fas fa-oil-can"></i>
                <span>Vidange</span>
            </a>
            <a href="#" id="declare-panne-btn" class="action-btn">
                <i class="fas fa-triangle-exclamation"></i>
                <span>Déclaration de panne</span>
            </a>
            <a href="/admin/depanage" class="action-btn" id="depanage-btn">
                <i class="fas fa-wrench"></i>
                <span>Dépannage</span>
            </a>
        </div>
    </div>
</div>





{% include 'shared/modals/_declaration_panne_modal.html' %}

{% include 'shared/modals/_add_bus_modal.html' %}
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Ouvrir automatiquement la modale Document si on arrive avec ?open=doc&bus_id=...
  (function(){
    const params = new URLSearchParams(window.location.search);
    if (params.get('open') === 'doc') {
      const bid = params.get('bus_id');
      if (bid) {
        window.selectedBusId = bid;
        $('#docFormModal').addClass('show');
        // Nettoyer l'URL pour éviter ré-ouverture au refresh
        if (window.history && window.history.replaceState) {
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      }
    } else if (params.get('open') === 'panne') {
      // Ouvrir la modale de déclaration de panne
      $('#panneModal').removeAttr('hidden').addClass('show').attr('aria-hidden','false');
      // Nettoyer l'URL pour éviter ré-ouverture au refresh
      if (window.history && window.history.replaceState) {
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }
  })();
  // Gestion de la modale d'ajout de Bus UdM
  $('#openAddBusModal').on('click', function(e) {
    e.preventDefault();
    $('#addBusModal').addClass('show');
  });
  
  $('#closeAddBusModal').on('click', function() {
    $('#addBusModal').removeClass('show');
  });

  // Fermer les modales en cliquant à l'extérieur
  $(document).on('click', function(e) {
    if ($(e.target).hasClass('modal')) {
      $(e.target).removeClass('show');
    }
  });
});

// Fonctions pour la modale de détails
function showBusDetails(busId) {
  // Rediriger vers la page de détails complète
  window.location.href = '/admin/bus/details/' + busId;
}



// Fonction pour ouvrir la modale de panne avec des données pré-remplies
window.openPanneModal = function(numero, immatriculation, kilometrage) {
  $('#numero_bus_udm_panne').val(numero);
  $('#immatriculation_panne').val(immatriculation || '');
  $('#kilometrage_panne').val(kilometrage || '');
  const minKm = (typeof kilometrage !== 'undefined' && kilometrage !== null && kilometrage !== '') ? Number(kilometrage) : 0;
  $('#kilometrage_panne').attr('min', isNaN(minKm) ? 0 : minKm);
  $('#panneModal').removeAttr('hidden').addClass('show').attr('aria-hidden','false');
};
</script>
{% endblock %}
