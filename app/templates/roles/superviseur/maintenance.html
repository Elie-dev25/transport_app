{% set active_page = 'maintenance' %}
{% extends "roles/superviseur/_base_superviseur.html" %}
{% from 'macros/superviseur_components.html' import page_header, table_container, info_card, status_badge %}

{% block title %}Maintenance - Superviseur{% endblock %}

{% block extra_head %}
<link href="{{ url_for('static', filename='css/superviseur.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/tables.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/cards.css') }}" rel="stylesheet">
{% endblock %}

{% block superviseur_content %}
{% call page_header('Vue d\'ensemble Maintenance', 'wrench', 'Consultation et suivi des opérations de maintenance', [{'name': 'Maintenance'}]) %}
    <button class="btn btn-outline-light" onclick="window.print()">
        <i class="fas fa-print me-2"></i>Imprimer
    </button>
{% endcall %}

<!-- Statistiques de maintenance -->
<div class="stats-overview">
    <div class="stat-overview-card">
        <div class="stat-overview-icon">
            <i class="fas fa-wrench"></i>
        </div>
        <div class="stat-overview-value">{{ interventions|length if interventions else 0 }}</div>
        <div class="stat-overview-label">Total Interventions</div>
    </div>
    <div class="stat-overview-card">
        <div class="stat-overview-icon">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-overview-value">{{ interventions|selectattr('statut', 'equalto', 'EN_COURS')|list|length if interventions else 0 }}</div>
        <div class="stat-overview-label">En Cours</div>
    </div>
    <div class="stat-overview-card">
        <div class="stat-overview-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-overview-value">{{ interventions|selectattr('statut', 'equalto', 'TERMINE')|list|length if interventions else 0 }}</div>
        <div class="stat-overview-label">Terminées</div>
    </div>
    <div class="stat-overview-card">
        <div class="stat-overview-icon">
            <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="stat-overview-value">{{ interventions|selectattr('statut', 'equalto', 'PLANIFIE')|list|length if interventions else 0 }}</div>
        <div class="stat-overview-label">Planifiées</div>
    </div>
</div>

<!-- Tableaux de maintenance -->
<div class="content-grid">
    <!-- Pannes récentes -->
    {% call table_container('Pannes Récentes', 'exclamation-triangle', search=false, subtitle='Incidents et réparations en cours') %}
        {% if pannes_recentes %}
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Bus N°</th>
                        <th>Description</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody>
                    {% for panne in pannes_recentes %}
                    <tr>
                        <td>{{ panne.date_heure.strftime('%d/%m %H:%M') if panne.date_heure else 'N/A' }}</td>
                        <td>{{ status_badge((panne.bus_udm.numero if panne.bus_udm else panne.numero_bus_udm) or 'N/A', custom_class='primary') }}</td>
                        <td>{{ panne.description[:50] if panne.description else 'N/A' }}{% if panne.description and panne.description|length > 50 %}...{% endif %}</td>
                        <td>
                            {% if panne.resolu %}
                                {{ status_badge('Résolu', custom_class='success') }}
                            {% else %}
                                {{ status_badge('Ouvert', custom_class='danger') }}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="text-center py-4">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h5 class="text-success">Aucune panne récente</h5>
                <p class="text-muted">Tous les véhicules sont opérationnels.</p>
            </div>
        {% endif %}
    {% endcall %}

    <!-- Vidanges récentes -->
    {% call table_container('Vidanges Récentes', 'oil-can', search=false, subtitle='Dernières opérations de vidange') %}
        {% if vidanges_recentes %}
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Bus N°</th>
                        <th>Type Huile</th>
                        <th>Quantité</th>
                        <th>Coût</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vidange in vidanges_recentes %}
                    <tr>
                        <td>{{ vidange.date_vidange.strftime('%d/%m/%Y') if vidange.date_vidange else 'N/A' }}</td>
                        <td>{{ status_badge((vidange.bus_udm.numero if vidange.bus_udm else vidange.numero_bus_udm) or 'N/A', custom_class='primary') }}</td>
                        <td>{{ vidange.type_huile or 'N/A' }}</td>
                        <td><strong>{{ vidange.quantite_litres or 0 }} L</strong></td>
                        <td><strong class="text-success">{{ vidange.cout_vidange or 0 }} FCFA</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="text-center py-4">
                <i class="fas fa-oil-can fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Aucune vidange récente</h5>
                <p class="text-muted">Les vidanges apparaîtront ici.</p>
            </div>
        {% endif %}
    {% endcall %}
</div>

<!-- Carburations récentes -->
{% call table_container('Carburations Récentes', 'gas-pump', search=false, subtitle='Derniers ravitaillements en carburant') %}
    {% if carburations_recentes %}
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Bus N°</th>
                    <th>Quantité</th>
                    <th>Prix Unitaire</th>
                    <th>Coût Total</th>
                    <th>Station</th>
                </tr>
            </thead>
            <tbody>
                {% for carburation in carburations_recentes %}
                <tr>
                    <td>{{ carburation.date_carburation.strftime('%d/%m/%Y') if carburation.date_carburation else 'N/A' }}</td>
                    <td>{{ status_badge((carburation.bus_udm.numero if carburation.bus_udm else carburation.numero_bus_udm) or 'N/A', custom_class='primary') }}</td>
                    <td><strong>{{ carburation.quantite_litres or 0 }} L</strong></td>
                    <td>{{ carburation.prix_unitaire or 0 }} FCFA/L</td>
                    <td><strong class="text-success">{{ (carburation.quantite_litres * carburation.prix_unitaire) if (carburation.quantite_litres and carburation.prix_unitaire) else 0 }} FCFA</strong></td>
                    <td>{{ carburation.station_service or 'N/A' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="text-center py-4">
            <i class="fas fa-gas-pump fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Aucune carburation récente</h5>
            <p class="text-muted">Les carburations apparaîtront ici.</p>
        </div>
    {% endif %}
{% endcall %}

<!-- Informations complémentaires -->
<div class="content-grid">
    {{ info_card(
        'Maintenance Préventive',
        'calendar-check',
        '<p class="mb-2"><strong>Planification :</strong> Automatisée selon kilométrage</p>
         <p class="mb-2"><strong>Vidanges :</strong> Tous les 10 000 km</p>
         <p class="mb-0"><strong>Révisions :</strong> Contrôles périodiques</p>',
        'info'
    ) }}

    {{ info_card(
        'Gestion des Coûts',
        'chart-line',
        '<p class="mb-2"><strong>Suivi :</strong> Coûts par véhicule</p>
         <p class="mb-2"><strong>Budget :</strong> Optimisation continue</p>
         <p class="mb-0"><strong>Rapports :</strong> Analyses mensuelles</p>',
        'success'
    ) }}
</div>



{% endblock %}
