{% extends "layout.html" %}

{% block head %}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-main.css') }}?v=20250821">
    {% block extra_head %}{% endblock %}
{% endblock %}

{% block content %}
<!-- Mobile Toggle -->
<button class="mobile-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</button>

<!-- Overlay -->
<div class="overlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
{% block sidebar %}
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="logo">
            <img src="{{ url_for('static', filename='img/Logo_Université_des_Montagnes.jpg') }}" alt="UDM Logo" style="height: 50px; width: auto; border-radius: 8px;">
        </div>
        <div class="admin-info">
            <h2>{{ sidebar_title | default('Admin Panel') }}</h2>
            <p>{{ sidebar_subtitle | default('Transport Universitaire') }}</p>
        </div>
    </div>
    <nav class="nav-menu">
        {% block nav_menu %}
        <!-- Navigation items will be defined in child templates -->
        {% endblock %}
        
        <!-- Logout (common to all) -->
        <div class="nav-item" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <a href="{{ url_for('auth.logout') }}" class="nav-link">
                <i class="fas fa-sign-out-alt"></i>
                <span>Déconnexion</span>
            </a>
        </div>
    </nav>
</div>
{% endblock %}

<!-- Top Bar -->
{% block topbar %}
<div class="top-bar">
    <h1 class="page-title">{{ page_title | default('Tableau de Bord') }}</h1>
    <div class="top-bar-actions">
        <div class="notification-bell" onclick="toggleNotifications()">
            <i class="fas fa-bell"></i>
            <span id="alertCount" class="notification-badge" style="display:none;"></span>
        </div>
        <div class="user-menu">
            <div class="user-avatar">{{ current_user.initials | default('U') }}</div>
            <div>
                <div style="font-weight:600;font-size:14px;">
                    {{ ((current_user.nom ~ ' ' ~ current_user.prenom)|trim) or current_user.login | default('Utilisateur') }}
                </div>
                <div style="font-size:12px;color:#64748b;">
                    {{ current_user.login | default('user') }}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Panneau notifications -->
<div id="alertPanel" style="display:none;position:fixed;top:60px;right:25px;z-index:11000;width:300px;background:#fff;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.15);">
    <ul id="alertList" style="list-style:none;margin:0;padding:10px;"></ul>
</div>
{% endblock %}

<!-- Main Content -->
<div class="main-content">
    <div class="dashboard-content">
        {% block dashboard_content %}
        <!-- Page content will be defined in child templates -->
        {% endblock %}
    </div>
</div>

<!-- Common Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Common dashboard functions
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.overlay');
    
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
    document.body.classList.toggle('sidebar-open');
}

function toggleNotifications() {
    $('#alertPanel').toggle();
}

function refreshAlerts() {
    {% if current_user and current_user.role == 'admin' %}
    Promise.all([
        $.get('/admin/documents_alerts_ajax'),
        $.get('/admin/fuel_alerts_ajax')
    ]).then(([docResp, fuelResp]) => {
        const docAlerts = (docResp && docResp.success) ? (docResp.alerts || []) : [];
        const fuelAlerts = (fuelResp && fuelResp.success) ? (fuelResp.alerts || []) : [];
        const total = docAlerts.length + fuelAlerts.length;
        
        $('#alertCount').text(total);
        if (total) {
            $('#alertCount').show();
            const docItems = docAlerts.map(a => {
                const cls = a.status === 'RED' ? 'red' : 'orange';
                return `<li style="margin:8px 0;font-size:14px;"><span class='indicator ${cls}'></span>Bus ${a.numero_aed} – ${a.type_document}<br><small style='color:#64748b'>${a.reste} restant (exp. ${a.date_expiration})</small></li>`;
            });
            const fuelItems = fuelAlerts.map(f => {
                const cls = f.status === 'RED' ? 'red' : (f.status === 'ORANGE' ? 'orange' : 'yellow');
                return `<li style="margin:8px 0;font-size:14px;"><span class='indicator ${cls}'></span>Bus ${f.numero_aed} – ${f.message}</li>`;
            });
            $('#alertList').html([...fuelItems, ...docItems].join(''));
        } else {
            $('#alertCount').hide();
            $('#alertList').html('<li style="padding:10px;color:#64748b">Aucune alerte</li>');
        }
    });
    {% endif %}
}

// Responsive handling
window.addEventListener('resize', function() {
    if (window.innerWidth > 768) {
        document.getElementById('sidebar').classList.remove('active');
        document.querySelector('.overlay').classList.remove('active');
        document.body.classList.remove('sidebar-open');
    }
});

// Initialize
$(function() {
    {% if current_user and current_user.role == 'admin' %}
    refreshAlerts();
    setInterval(refreshAlerts, 30000);
    {% endif %}
});
</script>

{% block extra_scripts %}{% endblock %}
{% endblock %}
