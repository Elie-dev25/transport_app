{% extends "layout.html" %}

{% block head %}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-main.css') }}?v=20250821">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tableaux.css') }}?v=20250907">
    <script src="{{ url_for('static', filename='js/tableaux.js') }}?v=20250907"></script>
    {% block extra_head %}{% endblock %}
{% endblock %}

{% block content %}
<!-- Mobile Toggle -->
<button class="mobile-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</button>

<!-- Overlay -->
<div class="overlay" onclick="toggleSidebar()"></div>

<!-- Mini Sidebar pour tablettes -->
<div class="mini-sidebar">
    <a href="{{ url_for('admin.dashboard') }}" class="mini-nav-item" data-tooltip="Dashboard">
        <i class="fas fa-tachometer-alt"></i>
    </a>
    <a href="{{ url_for('admin.bus') }}" class="mini-nav-item" data-tooltip="Bus UdM">
        <i class="fas fa-bus"></i>
    </a>
    <a href="{{ url_for('admin.carburation') }}" class="mini-nav-item" data-tooltip="Carburation">
        <i class="fas fa-gas-pump"></i>
    </a>
    <a href="{{ url_for('admin.depanage') }}" class="mini-nav-item" data-tooltip="Dépannage">
        <i class="fas fa-wrench"></i>
    </a>
    <a href="{{ url_for('admin.rapports') }}" class="mini-nav-item" data-tooltip="Rapports">
        <i class="fas fa-chart-bar"></i>
    </a>
    <a href="{{ url_for('admin.parametres') }}" class="mini-nav-item" data-tooltip="Paramètres">
        <i class="fas fa-cog"></i>
    </a>
</div>

<!-- Sidebar -->
{% block sidebar %}
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="logo">
            <img src="{{ url_for('static', filename='img/Logo_Université_des_Montagnes.jpg') }}" alt="UDM Logo" style="height: 50px; width: auto; border-radius: 8px;">
        </div>
        <div class="admin-info">
            <h2>{{ sidebar_title | default('Admin Panel') }}</h2>
            <p>{{ sidebar_subtitle | default('TransportUdM') }}</p>
        </div>
    </div>
    <nav class="nav-menu">
        {% block nav_menu %}
        <!-- Navigation items will be defined in child templates -->
        {% endblock %}
        
        <!-- Logout (common to all) -->
        <div class="nav-item" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <a href="{{ url_for('auth.logout') }}" class="nav-link">
                <i class="fas fa-sign-out-alt"></i>
                <span>Déconnexion</span>
            </a>
        </div>
    </nav>
</div>
{% endblock %}

<!-- Top Bar -->
{% block topbar %}
<div class="top-bar">
    <h1 class="page-title">{{ page_title | default('Tableau de Bord') }}</h1>
    <div class="top-bar-actions">
        <div class="user-menu">
            <div class="user-avatar">{{ current_user.initials | default('U') }}</div>
            <div>
                <div style="font-weight:600;font-size:14px;">
                    {{ ((current_user.nom ~ ' ' ~ current_user.prenom)|trim) or current_user.login | default('Utilisateur') }}
                </div>
                <div style="font-size:12px;color:#64748b;">
                    {{ current_user.login | default('user') }}
                    {% if current_user.role == 'RESPONSABLE' %}
                        <span class="badge bg-primary ms-1" style="font-size:10px;">RESPONSABLE</span>
                    {% elif current_user.role == 'ADMIN' %}
                        <span class="badge bg-success ms-1" style="font-size:10px;">ADMIN</span>
                    {% elif current_user.role == 'SUPERVISEUR' %}
                        <span class="badge bg-info ms-1" style="font-size:10px;">SUPERVISEUR</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}

<!-- Main Content -->
<div class="main-content">
    <div class="dashboard-content">
        {% block dashboard_content %}
        <!-- Page content will be defined in child templates -->
        {% endblock %}
    </div>
</div>

<!-- Bottom Navigation pour mobile -->
<div class="bottom-nav">
    <div class="bottom-nav-container">
        <a href="{{ url_for('admin.dashboard') }}" class="bottom-nav-item">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard</span>
        </a>
        <a href="{{ url_for('admin.bus') }}" class="bottom-nav-item">
            <i class="fas fa-bus"></i>
            <span>Bus</span>
        </a>
        <a href="{{ url_for('admin.utilisateurs') }}" class="bottom-nav-item">
            <i class="fas fa-users"></i>
            <span>Users</span>
        </a>
        <a href="{{ url_for('admin.rapports') }}" class="bottom-nav-item">
            <i class="fas fa-chart-bar"></i>
            <span>Reports</span>
        </a>
        <a href="{{ url_for('admin.parametres') }}" class="bottom-nav-item">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </a>
    </div>
</div>

<!-- Common Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{{ url_for('static', filename='js/audit_print.js') }}"></script>
<script>
// Common dashboard functions
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.overlay');
    
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
    document.body.classList.toggle('sidebar-open');
}



// Responsive handling
window.addEventListener('resize', function() {
    if (window.innerWidth > 768) {
        document.getElementById('sidebar').classList.remove('active');
        document.querySelector('.overlay').classList.remove('active');
        document.body.classList.remove('sidebar-open');
    }
});

// Initialize
$(function() {
    {% if current_user and current_user.role == 'admin' %}
    refreshAlerts();
    setInterval(refreshAlerts, 30000);
    {% endif %}
});

// Gestion des états actifs pour mini-sidebar et bottom-nav
document.addEventListener('DOMContentLoaded', function() {
    const currentPath = window.location.pathname;

    // Mini-sidebar
    document.querySelectorAll('.mini-nav-item').forEach(item => {
        if (item.getAttribute('href') === currentPath) {
            item.classList.add('active');
        }
    });

    // Bottom navigation
    document.querySelectorAll('.bottom-nav-item').forEach(item => {
        if (item.getAttribute('href') === currentPath) {
            item.classList.add('active');
        }
    });
});
</script>

{% block extra_scripts %}{% endblock %}
{% endblock %}
