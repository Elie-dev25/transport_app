{% extends "layout.html" %}
{% block title %}Utilisateurs{% endblock %}

{% block head %}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- CSS Modulaire - Architecture optimisée pour la maintenance -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-main.css') }}?v=20250821">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}

{% block content %}
<!-- Mobile Toggle -->
<button class="mobile-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</button>

<!-- Overlay -->
<div class="overlay" onclick="toggleSidebar()"></div>

{% include '_sidebar_admin.html' %}

<div class="main-content">
    {% set page_title = 'Liste des Utilisateurs' %}
{% include '_topbar_admin.html' %}

    <div class="dashboard-content">
        <div style="display:flex;justify-content:flex-end;margin-bottom:12px;">
    <button id="openAddUserModal" style="width:42px;height:42px;border:none;border-radius:50%;background:#2563eb;color:#fff;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;">
        <i class="fas fa-plus"></i>
    </button>
</div>
        <table style="width:100%;background:#fff;border-radius:16px;box-shadow:0 4px 24px rgba(30,64,175,0.07);overflow:hidden;">
            <thead style="background:linear-gradient(90deg,#1e3a8a,#2563eb);color:#fff;">
                <tr>
                    <th style="padding:14px;">Nom d'utilisateur</th>
                    <th>Login</th>
                    <th>Rôle</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for user in user_list %}
                <tr style="text-align:center;">
                    <td style="padding:10px 0;">{{ ((user.prenom ~ ' ' ~ user.nom)|trim) or user.login }}</td>
                    <td>{{ user.login }}</td>
                    <td>{{ user.role or '' }}</td>
                    <td>
                        <button class="delete-user-btn" data-id="{{ user.utilisateur_id }}" title="Supprimer" style="background:none;border:none;cursor:pointer;">
                            <i class="fas fa-trash" style="color:#ef4444;font-size:18px;"></i>
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="4" style="padding:20px;color:#64748b;">Aucun utilisateur enregistré.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal pour ajout utilisateur (partiel commun) -->
{% include 'partials/admin/_add_user_modal.html' %}

<script>
$(function() {
  $(document).on('click', '.delete-user-btn', function(e) {
    e.preventDefault();
    const userId = $(this).data('id');
    Swal.fire({
      title: 'Êtes-vous sûr ?',
      text: "Cette action est irréversible !",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Oui, supprimer',
      cancelButtonText: 'Annuler'
    }).then((result) => {
      if (result.isConfirmed) {
      $.ajax({
        url: '/admin/supprimer_utilisateur_ajax/' + userId,
        method: 'POST',
        success: function(resp) {
          if (resp.success) {
            location.reload();
          } else {
            alert(resp.message || 'Erreur lors de la suppression');
          }
        },
        error: function() {
          alert('Erreur lors de la suppression');
        }
      });
    }
  });
  });

  // Ouverture de la modale d'ajout d'utilisateur
  $('#openAddUserModal').on('click', function(e) {
    e.preventDefault();
    $('#addUserModal').addClass('show');
    // Init champs chauffeur selon rôle sélectionné et auto-login
    setTimeout(function(){
      toggleChauffeurFields();
      // réinitialiser le flag d'édition manuelle du login
      $('#addUserForm input[name="login"]').data('userEdited', false);
      updateLoginFromName();
    }, 0);
  });
  // Fermeture de la modale
  $('#closeAddUserModal').on('click', function() {
    $('#addUserModal').removeClass('show');
  });
  $('#addUserModal').on('click', function(e) {
    if (e.target === this) {
      $(this).removeClass('show');
    }
  });
  // Toggle champs Chauffeur selon rôle
  function toggleChauffeurFields() {
    const role = $('#roleSelectAddUser').val();
    const isPermisRole = (role === 'CHAUFFEUR' || role === 'MECANICIEN');
    const $container = $('#addUserForm');
    const $permis = $container.find('.permis-only');
    const $num = $container.find('input[name="numero_permis"]');
    const $del = $container.find('input[name="date_delivrance_permis"]');
    const $exp = $container.find('input[name="date_expiration_permis"]');
    if (isPermisRole) {
      $permis.show();
      $num.attr('required', true);
      $del.attr('required', true);
      $exp.attr('required', true);
    } else {
      $permis.hide();
      $num.removeAttr('required');
      $del.removeAttr('required');
      $exp.removeAttr('required');
    }
  }
  $(document).on('change', '#roleSelectAddUser', toggleChauffeurFields);
  // --- Auto-génération du login depuis nom + prénom ---
  function slugify(str) {
    return (str || '')
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .toLowerCase()
      .replace(/[^a-z0-9\.]+/g, '')
      .replace(/\.+/g, '.')
      .replace(/^\.|\.$/g, '');
  }
  function updateLoginFromName() {
    const $login = $('#addUserForm input[name="login"]');
    if ($login.data('userEdited')) return; // ne pas écraser si l'utilisateur a saisi
    const nom = ($('#addUserForm input[name="nom"]').val() || '').trim();
    const prenom = ($('#addUserForm input[name="prenom"]').val() || '').trim();
    if (!nom && !prenom) return;
    const base = [prenom, nom].filter(Boolean).join('.');
    const candidate = slugify(base);
    if (candidate) { $login.val(candidate); }
  }
  $(document).on('input', '#addUserForm input[name="nom"], #addUserForm input[name="prenom"]', updateLoginFromName);
  $(document).on('input', '#addUserForm input[name="login"]', function(){
    $(this).data('userEdited', true);
  });
  // Soumission du formulaire d'ajout d'utilisateur
  $('#addUserForm').on('submit', function(e) {
    e.preventDefault();
    $.ajax({
      url: '/admin/ajouter_utilisateur_ajax',
      method: 'POST',
      data: $(this).serialize(),
      success: function(resp) {
        $('#addUserModal').removeClass('show');
        $('body').append('<div class="flash-message success">' + resp.message + '</div>');
        setTimeout(function() { $('.flash-message.success').fadeOut(500, function() { $(this).remove(); }); }, 3000);
        location.reload();
      },
      error: function(xhr) {
        let msg = xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : 'Erreur lors de l\'ajout';
        $('body').append('<div class="flash-message danger">' + msg + '</div>');
        setTimeout(function() { $('.flash-message.danger').fadeOut(500, function() { $(this).remove(); }); }, 3000);
      }
    });
  });
});
</script>
{% endblock %}
