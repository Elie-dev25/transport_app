{% extends "_base_admin.html" %}
{% block title %}Chauffeurs{% endblock %}

{% set active_page = 'chauffeurs' %}
{% set page_title = 'Liste des Chauffeurs' %}

{% block extra_head %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Styles spécifiques pour les modales chauffeurs */
        .info-box {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
        }
        .info-box h4 {
            margin: 0 0 5px 0;
            color: #1e40af;
            font-size: 16px;
        }
        .info-box p {
            margin: 0;
            font-weight: 500;
            color: #374151;
        }

        /* Raccourcis de dates */
        .date-shortcuts {
            margin-bottom: 20px;
            padding: 15px;
            background: #f1f5f9;
            border-radius: 8px;
        }
        .date-shortcuts h5 {
            margin: 0 0 10px 0;
            color: #475569;
            font-size: 14px;
        }
        .shortcuts-grid {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .shortcut-btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        /* Détails statut */
        .detail-item {
            margin-bottom: 15px;
        }
        .detail-item strong {
            color: #374151;
        }
        .status-badge {
            margin-left: 10px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        .period-info {
            margin-top: 8px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        .period-date {
            margin-bottom: 5px;
        }
        .period-date:last-child {
            margin-bottom: 0;
        }
        .text-success {
            color: #10b981;
            margin-right: 8px;
        }
        .text-danger {
            color: #ef4444;
            margin-right: 8px;
        }
        .other-statuts {
            margin-top: 8px;
            color: #374151;
        }
        .loading-text {
            color: #6b7280;
        }

        /* Boutons */
        .btn-secondary {
            background: #e2e8f0;
            border: 1px solid #cbd5e1;
            color: #475569;
        }
        .btn-secondary:hover {
            background: #cbd5e1;
        }
        .statut-badge {
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .statut-conge {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
        }
        .statut-permanence {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }
        .statut-service_weekend {
            background-color: #f3e8ff;
            color: #7c3aed;
            border: 1px solid #8b5cf6;
        }
        .statut-service_semaine {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
    </style>
{% endblock %}

{% block dashboard_content %}

        
        <table style="width:100%;background:#fff;border-radius:16px;box-shadow:0 4px 24px rgba(30,64,175,0.07);overflow:hidden;">
            <thead style="background:linear-gradient(90deg,#1e3a8a,#2563eb);color:#fff;">
                <tr>
                    <th style="padding:14px;">Nom</th>
                    <th>Prénom</th>
                    <th>Numéro de permis</th>
                    <th>Téléphone</th>
                    <th>Statut</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for chauffeur in chauffeur_list %}
                <tr style="text-align:center;">
                    <td style="padding:10px 0;">{{ chauffeur.nom }}</td>
                    <td>{{ chauffeur.prenom }}</td>
                    <td>{{ chauffeur.numero_permis }}</td>
                    <td>{{ chauffeur.telephone }}</td>
                    <td style="padding:5px;">
                        {% if chauffeur.statuts_actuels %}
                            {% for statut in chauffeur.statuts_actuels %}
                                <button class="statut-btn statut-{{ statut.statut.lower() }}" 
                                        style="display:inline-block;margin:2px;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:500;border:none;cursor:pointer;"
                                        data-statut="{{ statut.statut }}"
                                        data-chauffeur-id="{{ chauffeur.chauffeur_id }}"
                                        data-date-debut="{{ statut.date_debut|date_fr }}"
                                        data-date-fin="{{ statut.date_fin|date_fr }}"
                                        data-chauffeur-nom="{{ chauffeur.nom }} {{ chauffeur.prenom }}"
                                        onclick="showStatutDetails(this)">
                                    {% if statut.statut == 'CONGE' %}Congé
                                    {% elif statut.statut == 'PERMANENCE' %}Permanence
                                    {% elif statut.statut == 'SERVICE_WEEKEND' %}Week-end
                                    {% elif statut.statut == 'SERVICE_SEMAINE' %}Semaine
                                    {% endif %}
                                </button>
                            {% endfor %}
                        {% else %}
                            <span style="color:#6b7280;font-style:italic;font-size:12px;">Disponible</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="edit-statut-btn" data-id="{{ chauffeur.chauffeur_id }}" data-nom="{{ chauffeur.nom }}" data-prenom="{{ chauffeur.prenom }}" title="Modifier le statut" style="background:none;border:none;cursor:pointer;margin-right:10px;">
                            <i class="fas fa-calendar-alt" style="color:#3b82f6;font-size:18px;"></i>
                        </button>
                        <button class="delete-chauffeur-btn" data-id="{{ chauffeur.chauffeur_id }}" title="Supprimer" style="background:none;border:none;cursor:pointer;">
                            <i class="fas fa-trash" style="color:#ef4444;font-size:18px;"></i>
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="6" style="padding:20px;color:#64748b;">Aucun chauffeur enregistré.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<!-- Inclure la modale de modification de statut -->
{% include 'partials/admin/_edit_statut_chauffeur_modal.html' %}

<!-- Inclure la modale des détails de statut -->
{% include 'partials/admin/_statut_details_modal.html' %}


{% endblock %}

{% block extra_scripts %}
<script>
// Fonction pour afficher les détails du statut
function showStatutDetails(button) {
  const statut = button.getAttribute('data-statut');
  const dateDebut = button.getAttribute('data-date-debut');
  const dateFin = button.getAttribute('data-date-fin');
  const chauffeurNom = button.getAttribute('data-chauffeur-nom');
  const chauffeurId = button.getAttribute('data-chauffeur-id');

  // Remplir les informations dans la modale
  document.getElementById('detailChauffeurNom').textContent = chauffeurNom;
  document.getElementById('detailDateDebut').textContent = dateDebut;
  document.getElementById('detailDateFin').textContent = dateFin;

  // Définir le texte et le style du statut
  const detailStatutElement = document.getElementById('detailStatut');
  let statutText = '';
  let statutClass = '';

  switch(statut) {
    case 'CONGE':
      statutText = 'Congé';
      statutClass = 'statut-conge';
      break;
    case 'PERMANENCE':
      statutText = 'Permanence';
      statutClass = 'statut-permanence';
      break;
    case 'SERVICE_WEEKEND':
      statutText = 'Service Week-end';
      statutClass = 'statut-service_weekend';
      break;
    case 'SERVICE_SEMAINE':
      statutText = 'Service Semaine';
      statutClass = 'statut-service_semaine';
      break;
  }

  detailStatutElement.textContent = statutText;
  detailStatutElement.className = statutClass;

  // Afficher la modale
  document.getElementById('statutDetailsModal').classList.add('show');

  // Charger autres statuts via AJAX
  const listEl = document.getElementById('autresStatutsList');
  if (listEl) {
    listEl.innerHTML = '<span style="color:#6b7280;">Chargement...</span>';
    fetch(`/admin/get_statuts_chauffeur_ajax/${chauffeurId}`)
      .then(r => r.json())
      .then(data => {
        if (!data || !data.success) {
          listEl.innerHTML = '<span style="color:#ef4444;">Impossible de charger les statuts.</span>';
          return;
        }
        const statuts = data.statuts || [];
        if (statuts.length === 0) {
          listEl.innerHTML = '<span style="color:#6b7280;">Aucun autre statut enregistré.</span>';
          return;
        }
        const container = document.createElement('div');
        container.style.display = 'flex';
        container.style.flexDirection = 'column';
        container.style.gap = '8px';
        statuts.forEach(s => {
          const item = document.createElement('div');
          item.style.padding = '8px 10px';
          item.style.border = '1px solid #e5e7eb';
          item.style.borderRadius = '8px';
          item.style.background = '#ffffff';
          const start = s.date_debut_formatted || s.date_debut;
          const end = s.date_fin_formatted || s.date_fin;
          let label = s.statut;
          if (label === 'CONGE') label = 'Congé';
          else if (label === 'PERMANENCE') label = 'Permanence';
          else if (label === 'SERVICE_WEEKEND') label = 'Service Week-end';
          else if (label === 'SERVICE_SEMAINE') label = 'Service Semaine';
          item.textContent = `${label} — du ${start} au ${end}`;
          container.appendChild(item);
        });
        listEl.innerHTML = '';
        listEl.appendChild(container);
      })
      .catch(() => {
        listEl.innerHTML = '<span style="color:#ef4444;">Erreur lors du chargement.</span>';
      });
  }
}

$(function() {
  // Fermeture de la modale des détails du statut
  $('#closeStatutDetailsModal').on('click', function() {
    $('#statutDetailsModal').removeClass('show');
  });

  // Fermeture par clic sur l'overlay
  $('#statutDetailsModal').on('click', function(e) {
    if (e.target === this) {
      $(this).removeClass('show');
    }
  });

  // Gestion du bouton de modification de statut
  $('.edit-statut-btn').on('click', function(e) {
    e.preventDefault();
    const chauffeurId = $(this).data('id');
    const nom = $(this).data('nom');
    const prenom = $(this).data('prenom');

    // Remplir les informations du chauffeur dans la modale
    $('#chauffeurId').val(chauffeurId);
    $('#chauffeurNomPrenom').text(nom + ' ' + prenom);

    // Afficher la modale
    $('#editStatutChauffeurModal').addClass('show');
  });

  // Fermeture de la modale
  $('#closeEditStatutModal, #cancelEditStatut').on('click', function() {
    $('#editStatutChauffeurModal').removeClass('show');
    $('#editStatutChauffeurForm')[0].reset();
  });

  // Fermeture par clic sur l'overlay
  $('#editStatutChauffeurModal').on('click', function(e) {
    if (e.target === this) {
      $(this).removeClass('show');
      $('#editStatutChauffeurForm')[0].reset();
    }
  });

  // Raccourcis de dates
  $('.shortcut-btn').on('click', function() {
    const shortcut = $(this).data('shortcut');
    const now = new Date();
    let startDate, endDate;

    switch(shortcut) {
      case 'today':
        startDate = new Date(now);
        endDate = new Date(now);
        endDate.setHours(23, 59, 59);
        break;
      case 'tomorrow':
        startDate = new Date(now);
        startDate.setDate(now.getDate() + 1);
        startDate.setHours(0, 0, 0);
        endDate = new Date(startDate);
        endDate.setHours(23, 59, 59);
        break;
      case 'this-weekend':
        // Samedi de cette semaine
        startDate = new Date(now);
        const daysToSaturday = 6 - now.getDay();
        startDate.setDate(now.getDate() + daysToSaturday);
        startDate.setHours(0, 0, 0);
        // Dimanche
        endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 1);
        endDate.setHours(23, 59, 59);
        break;
      case 'next-week':
        // Lundi de la semaine prochaine
        startDate = new Date(now);
        const daysToNextMonday = (8 - now.getDay()) % 7;
        startDate.setDate(now.getDate() + daysToNextMonday);
        startDate.setHours(0, 0, 0);
        // Vendredi de la semaine prochaine
        endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 4);
        endDate.setHours(23, 59, 59);
        break;
    }

    // Formater les dates pour les inputs datetime-local
    const formatDateTime = (date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    };

    $('input[name="date_debut"]').val(formatDateTime(startDate));
    $('input[name="date_fin"]').val(formatDateTime(endDate));
  });

  // Soumission du formulaire de modification de statut
  $('#editStatutChauffeurForm').on('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    $.ajax({
      url: '/admin/modifier_statut_chauffeur_ajax',
      method: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: function(resp) {
        if (resp.success) {
          $('#editStatutChauffeurModal').removeClass('show');
          $('#editStatutChauffeurForm')[0].reset();
          // Utiliser SweetAlert2 si disponible
          if (typeof Swal !== 'undefined') {
            Swal.fire('Succès', 'Statut modifié avec succès !', 'success').then(() => {
              location.reload();
            });
          } else {
            alert('Statut modifié avec succès !');
            location.reload();
          }
        } else {
          if (typeof Swal !== 'undefined') {
            Swal.fire('Erreur', resp.message || 'Erreur lors de la modification du statut', 'error');
          } else {
            alert(resp.message || 'Erreur lors de la modification du statut');
          }
        }
      },
      error: function(xhr) {
        try {
          const json = xhr.responseJSON || JSON.parse(xhr.responseText || '{}');
          const msg = (json && (json.message || json.error)) || 'Erreur lors de la modification du statut';
          if (typeof Swal !== 'undefined') {
            Swal.fire('Erreur', msg, 'error');
          } else {
            alert(msg);
          }
        } catch (e) {
          if (typeof Swal !== 'undefined') {
            Swal.fire('Erreur', 'Erreur lors de la modification du statut', 'error');
          } else {
            alert('Erreur lors de la modification du statut');
          }
        }
      }
    });
  });

  // Gestion du bouton de suppression
  $('.delete-chauffeur-btn').on('click', function(e) {
    e.preventDefault();
    const chauffeurId = $(this).data('id');

    // Utiliser SweetAlert2 si disponible
    if (typeof Swal !== 'undefined') {
      Swal.fire({
        title: 'Êtes-vous sûr ?',
        text: "Cette action est irréversible !",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Oui, supprimer',
        cancelButtonText: 'Annuler'
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            url: '/admin/supprimer_chauffeur_ajax/' + chauffeurId,
            method: 'POST',
            success: function(resp) {
              if (resp.success) {
                Swal.fire('Supprimé !', 'Le chauffeur a été supprimé.', 'success').then(() => {
                  location.reload();
                });
              } else {
                Swal.fire('Erreur', resp.message || 'Erreur lors de la suppression', 'error');
              }
            },
            error: function() {
              Swal.fire('Erreur', 'Erreur lors de la suppression', 'error');
            }
          });
        }
      });
    } else {
      if (confirm('Voulez-vous vraiment supprimer ce chauffeur ?')) {
        $.ajax({
          url: '/admin/supprimer_chauffeur_ajax/' + chauffeurId,
          method: 'POST',
          success: function(resp) {
            if (resp.success) {
              alert('Chauffeur supprimé avec succès !');
              location.reload();
            } else {
              alert(resp.message || 'Erreur lors de la suppression');
            }
          },
          error: function() {
            alert('Erreur lors de la suppression');
          }
        });
      }
    }
  });
});
</script>
{% endblock %}
