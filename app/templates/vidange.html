{% extends "layout.html" %}
{% block title %}Vidange{% endblock %}

{% block head %}
 <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
 <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard_admin.css') }}">
 <link rel="stylesheet" href="{{ url_for('static', filename='css/vidange.css') }}">
 <link rel="stylesheet" href="{{ url_for('static', filename='css/modale.css') }}">
 {# Optional: expose CSRF token to JS if you use Flask-WTF or similar #}
 <meta name="csrf-token" content="{{ csrf_token() if csrf_token is defined else '' }}">
 <script src="{{ url_for('static', filename='js/script.js') }}" defer></script>
{% endblock %}

{% block content %}
<!-- Sidebar -->
{% include '_sidebar_admin.html' %}

<div class="main-content vidange-container">
    {% set page_title = 'Gestion des Vidanges' %}
    {% include '_topbar_admin.html' %}
    <div class="dashboard-content">
       
        <div class="vidange-welcome">
            <table class="vidange-table">
                <thead>
                    <tr class="aed-list-title-row">
                        <th style="padding:10px;">Numéro</th>
                        <th>Kilométrage</th>
                        <th>Km Critique Vidange</th>
                        <th>Dernière Vidange</th>
                        <th>État Vidange</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                {% for bus in bus_vidange %}
                    <tr style="text-align:center;" data-bus-id="{{ bus.id }}">
                        <td>{{ bus.numero }}</td>
                        <td>{{ bus.kilometrage or '-' }}</td>
                        <td>{{ bus.km_critique_huile or '-' }}</td>
                        <td>{{ bus.date_derniere_vidange|date_fr or '-' }}</td>
                        <td style="text-align:left;">
                            <span class="indicator {{ bus.voyant }}" aria-hidden="true" style="display:inline-block;width:16px;height:16px;border-radius:50%;margin-right:8px;vertical-align:middle;"></span>
                            <span style="vertical-align:middle;">
                            {% if bus.voyant == 'green' %}OK{% elif bus.voyant == 'orange' %}Bientôt à faire{% else %}À faire !{% endif %}
                            </span>
                        </td>
                        <td>
                            <button class="action-btn" title="Effectuer une vidange" type="button"
                                data-open-vidange="1"
                                data-bus-id="{{ bus.id }}"
                                data-numero="{{ bus.numero|e }}"
                                data-demandeur="{{ (((current_user.nom ~ ' ' ~ current_user.prenom)|trim) or current_user.login)|e }}">
                                <i class="fas fa-oil-can"></i> Effectuer une vidange
                            </button>
                        </td>
                    </tr>
                {% else %}
                    <tr><td colspan="6" style="color:#64748b;padding:16px;">Aucun bus enregistré.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>


{# --- Modales (only once, outside the loop) --- #}
<div id="ficheVidangeModal" class="modal" aria-hidden="true">
    <div class="modal-content">
        <button class="close" aria-label="Fermer" onclick="closeVidangeModal()">&times;</button>
        <h2 style="margin-bottom:18px;">Fiche de Vidange</h2>
        <div id="fiche-vidange-content">
            <div class="fiche-vidange-form">
                <div style="margin-bottom:18px;">
                    <strong>Numéro de demande :</strong> <span id="fiche-numero-demande">-</span>
                </div>
                <div style="margin-bottom:18px;">
                    <strong>Date et heure :</strong> <span id="fiche-date-heure">-</span>
                </div>
                <div style="margin-bottom:18px;">
                    <strong>Demandeur :</strong> <span id="fiche-demandeur">-</span>
                </div>
                <div style="margin-bottom:18px;">
                    <strong>Numéro du véhicule :</strong> <span id="fiche-numero-vehicule">-</span>
                </div>
                <div style="display:flex;gap:32px;margin-top:32px;justify-content:center;">
                    <div style="text-align:center;">
                        <strong>Signature Responsable 1</strong>
                        <div class="signature-line"></div>
                    </div>
                    <div style="text-align:center;">
                        <strong>Signature Responsable 2</strong>
                        <div class="signature-line"></div>
                    </div>
                </div>
            </div>
        </div>
        <div style="display:flex;gap:16px;justify-content:center;margin-top:24px;">
            <button class="action-btn" onclick="printFicheVidange()"><i class="fas fa-print"></i> Imprimer</button>
            <button class="action-btn" onclick="openFormulaireVidange(null)"><i class="fas fa-check"></i> Confirmer la vidange</button>
        </div>
    </div>
</div>

<!-- Modale formulaire de confirmation vidange (single instance) -->
<div id="formulaireVidangeModal" class="modal" aria-hidden="true">
    <div class="modal-content">
        <button class="close" aria-label="Fermer" onclick="closeFormulaireVidangeModal()">&times;</button>
        <h2 style="margin-bottom:18px;">Formulaire de confirmation vidange</h2>
        <form id="formulaire-vidange">
            <input type="hidden" id="aed_id_hidden" name="aed_id_hidden">
            <div style="margin-bottom:18px;">
                <label for="numero_aed">Numéro AED :</label>
                <input type="text" id="numero_aed" name="numero_aed" readonly style="width:100%;padding:8px;border-radius:8px;border:1px solid #e5e7eb;background:#f3f4f6;">
            </div>
            <div style="margin-bottom:18px;">
                <label for="kilometrage">Kilométrage :</label>
                <input type="number" id="kilometrage" name="kilometrage" min="0" required style="width:100%;padding:8px;border-radius:8px;border:1px solid #e5e7eb;">
            </div>
            <div style="margin-bottom:18px;">
                <label for="type_huile">Type d'huile :</label>
                <select id="type_huile" name="type_huile" required style="width:100%;padding:8px;border-radius:8px;border:1px solid #e5e7eb;">
                    <option value="Quartz 5000 20W-50">Quartz 5000 20W-50</option>
                    <option value="Quartz 7000 10W-40">Quartz 7000 10W-40</option>
                    <option value="Quartz 9000 5W-40">Quartz 9000 5W-40</option>
                    <option value="Rubia TIR 7400 15W-40">Rubia TIR 7400 15W-40</option>
                    <option value="Rubia TIR 9900 FE 5W-30">Rubia TIR 9900 FE 5W-30</option>
                    <option value="Rubia Fleet HD 400 15W-40">Rubia Fleet HD 400 15W-40</option>
                </select>
            </div>
            <div style="margin-bottom:18px;">
                <label for="remarque">Remarque :</label>
                <textarea id="remarque" name="remarque" rows="3" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e5e7eb;"></textarea>
            </div>
            <button type="submit" class="action-btn" style="width:100%;margin-top:12px;"><i class="fas fa-save"></i> Enregistrer la vidange</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('formulaire-vidange');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const kilometrage = document.getElementById('kilometrage').value;
        const type_huile = document.getElementById('type_huile').value;
        const remarque = document.getElementById('remarque').value;
        const aed_id = document.getElementById('aed_id_hidden').value;
        if (!aed_id) {
            alert("Erreur : aucun véhicule sélectionné. Veuillez ouvrir la fiche de vidange avant de confirmer.");
            return;
        }

        // Prepare CSRF header if available
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const headers = {
            'Content-Type': 'application/json'
        };
        if (csrfToken) headers['X-CSRFToken'] = csrfToken;

        fetch('{{ post_url }}', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
                aed_id: aed_id,
                kilometrage: kilometrage,
                type_huile: type_huile,
                remarque: remarque
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Vidange enregistrée avec succès !');
                
                // Mettre à jour la ligne du tableau si les données sont retournées
                if (data.bus_updated) {
                    const busRow = document.querySelector(`tr[data-bus-id="${data.bus_updated.id}"]`);
                    if (busRow) {
                        const cells = busRow.querySelectorAll('td');
                        if (cells.length >= 5) {
                            // Mettre à jour kilométrage (colonne 1)
                            cells[1].textContent = data.bus_updated.kilometrage || '-';
                            // Mettre à jour km critique huile (colonne 2)
                            cells[2].textContent = data.bus_updated.km_critique_huile || '-';
                            // Mettre à jour dernière vidange (colonne 3)
                            cells[3].textContent = data.bus_updated.date_derniere_vidange || '-';
                            // Mettre à jour voyant (colonne 4)
                            const indicator = cells[4].querySelector('.indicator');
                            if (indicator) {
                                indicator.className = `indicator ${data.bus_updated.voyant}`;
                            }
                            const statusText = cells[4].querySelector('span:last-child');
                            if (statusText) {
                                if (data.bus_updated.voyant === 'green') {
                                    statusText.textContent = 'OK';
                                } else if (data.bus_updated.voyant === 'orange') {
                                    statusText.textContent = 'Bientôt à faire';
                                } else {
                                    statusText.textContent = 'À faire !';
                                }
                            }
                        }
                    }
                }
                
                closeFormulaireVidangeModal();
                closeVidangeModal();
            } else {
                alert('Erreur lors de l\'enregistrement de la vidange.');
            }
        })
        .catch(() => {
            alert('Erreur serveur.');
        });
    });
});
</script>

{# --- Historique des Vidanges --- #}
<div class="main-content historique-section">
    <div class="dashboard-content">
        <h2 class="section-title"><i class="fas fa-history"></i> Historique des Vidanges</h2>
        <div class="vidange-filter" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <label for="numero_aed"><i class="fas fa-bus"></i> Filtrer :</label>
            <select name="numero_aed" id="numero_aed" onchange="filterHistoriqueVidange(this.value)">
                <option value="">Tous</option>
                {% for numero in numeros_aed %}
                    <option value="{{ numero }}" {% if numero == selected_numero %}selected{% endif %}>{{ numero }}</option>
                {% endfor %}
            </select>
            <input type="date" id="vid_date_debut" value="{{ selected_date_debut or '' }}" onchange="filterHistoriqueVidange(document.getElementById('numero_aed').value)" />
            <span>au</span>
            <input type="date" id="vid_date_fin" value="{{ selected_date_fin or '' }}" onchange="filterHistoriqueVidange(document.getElementById('numero_aed').value)" />
            <button type="button" title="Effacer filtres" aria-label="Effacer filtres" onclick="clearHistoriqueVidangeFilters()" style="border:none;background:transparent;color:#ef4444;width:24px;height:24px;border-radius:4px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;">
                <i class="fas fa-times" style="font-size:14px;"></i>
            </button>
            <span id="vid_loader" style="display:none;align-items:center;gap:6px;color:#6b7280;">
                <i class="fas fa-spinner fa-spin"></i> Chargement...
            </span>
        </div>
        <div class="historique-table-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
            <table class="vidange-table" style="margin: 0;">
                <thead style="position: sticky; top: 0; background: #f9fafb; z-index: 10;">
                    <tr>
                        <th>Numéro AED</th>
                        <th>Date Vidange</th>
                        <th>Kilométrage</th>
                        <th>Type d'huile</th>
                        <th>Remarque</th>
                    </tr>
                </thead>
                <tbody id="historique-vid-body">
                {% for v in historique_vidange %}
                    <tr>
                        <td>{{ v.aed.numero }}</td>
                        <td>{{ v.date_vidange|date_fr }}</td>
                        <td>{{ v.kilometrage }}</td>
                        <td>{{ v.type_huile or '-' }}</td>
                        <td>{{ v.remarque or '-' }}</td>
                    </tr>
                {% else %}
                    <tr><td colspan="5" class="empty-state">Aucune vidange enregistrée.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
