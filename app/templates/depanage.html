{% extends "_base_admin.html" %}
{% block title %}Dépannage{% endblock %}

{% set active_page = 'bus' %}
{% set page_title = 'Gestion des Dépannages' %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/vidanges.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/modals.css') }}">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
.dashboard-content {
    padding: 8px 0 24px 0 !important;
}
.depannage-container {
    padding: 0 24px;
}
.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}
.status-critical { background: #fee2e2; color: #dc2626; }
.status-warning { background: #fef3c7; color: #d97706; }
.status-ok { background: #dcfce7; color: #16a34a; }
.voyant-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 6px;
}
.voyant-green { background-color: #10b981; }
.voyant-orange { background-color: #f59e0b; }
.voyant-red { background-color: #ef4444; }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="depannage-container">
    <div class="vidange-header">
        <h1 class="vidange-title">
            <i class="fas fa-wrench"></i>
            Gestion des Dépannages
        </h1>
    </div>

    <!-- Tableau des pannes -->
    <div class="vidange-table-container">
        <table class="vidange-table">
            <thead>
                <tr>
                    <th>Bus UdM</th>
                    <th>Date/Heure</th>
                    <th>Criticité</th>
                    <th>Immobilisation</th>
                    <th>Description</th>
                    <th>Enregistré par</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for panne, bus in pannes %}
                <tr>
                    <td>
                        <strong>{{ panne.numero_bus_udm }}</strong>
                        {% if bus and bus.marque %}
                            <br><small style="color:#6b7280;">{{ bus.marque }} {{ bus.modele or '' }}</small>
                        {% endif %}
                    </td>
                    <td>{{ panne.date_heure.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td>
                        <span class="voyant-indicator voyant-{% if panne.criticite == 'HAUTE' %}red{% elif panne.criticite == 'MOYENNE' %}orange{% else %}green{% endif %}"></span>
                        {{ panne.criticite }}
                    </td>
                    <td>
                        {% if panne.immobilisation %}
                            <span class="status-badge status-critical">Oui</span>
                        {% else %}
                            <span class="status-badge status-ok">Non</span>
                        {% endif %}
                    </td>
                    <td style="max-width:300px;">{{ panne.description }}</td>
                    <td>{{ panne.enregistre_par }}</td>
                    <td>
                        <button class="btn-action btn-open-depannage"
                                data-panne-id="{{ panne.id }}"
                                data-numero="{{ panne.numero_bus_udm }}"
                                data-immatriculation="{{ panne.immatriculation or (bus and bus.immatriculation) or '' }}">
                            <i class="fas fa-screwdriver-wrench"></i>
                            Réparer
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                        Aucune panne enregistrée pour le moment.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Historique des dépannages -->
    <div class="historique-section">
        <div class="historique-header">
            <h2 class="historique-title">
                <i class="fas fa-history"></i>
                Historique des Dépannages
            </h2>
            <div class="historique-filter">
                <select id="dep_numero_select" onchange="filterHistoriqueDepannage(this.value)">
                    <option value="">Tous les bus</option>
                    {% set bus_list = [] %}
                    {% for dep, bus in depannages %}
                        {% if dep.numero_bus_udm not in bus_list %}
                            {% set _ = bus_list.append(dep.numero_bus_udm) %}
                            <option value="{{ dep.numero_bus_udm }}">Bus {{ dep.numero_bus_udm }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
                <input type="date" id="dep_date_debut" onchange="filterHistoriqueDepannage(document.getElementById('dep_numero_select').value)" />
                <span>au</span>
                <input type="date" id="dep_date_fin" onchange="filterHistoriqueDepannage(document.getElementById('dep_numero_select').value)" />
                <button type="button" title="Effacer filtres" onclick="clearHistoriqueDepannageFilters()" style="border:none;background:transparent;color:#ef4444;width:24px;height:24px;border-radius:4px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;">
                    <i class="fas fa-times" style="font-size:14px;"></i>
                </button>
                <span id="dep_loader" style="display:none;align-items:center;gap:6px;color:#6b7280;">
                    <i class="fas fa-spinner fa-spin"></i> Chargement...
                </span>
            </div>
        </div>
        
        <div class="historique-table-container">
            <table class="historique-table" id="depannages-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Bus UdM</th>
                        <th>Kilométrage</th>
                        <th>Coût (FCFA)</th>
                        <th>Panne</th>
                        <th>Cause</th>
                        <th>Réparé par</th>
                    </tr>
                </thead>
                <tbody id="historique-dep-body">
                    {% for depannage, bus in depannages %}
                    <tr data-bus="{{ depannage.numero_bus_udm }}" data-date="{{ depannage.date_heure.strftime('%Y-%m-%d') }}">
                        <td>{{ depannage.date_heure.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td>
                            <strong>{{ depannage.numero_bus_udm }}</strong>
                            {% if bus and bus.marque %}
                                <br><small style="color:#6b7280;">{{ bus.marque }} {{ bus.modele or '' }}</small>
                            {% endif %}
                        </td>
                        <td>{{ depannage.kilometrage or '-' }}{% if depannage.kilometrage %} km{% endif %}</td>
                        <td>{{ '{:,.0f}'.format(depannage.cout_reparation) if depannage.cout_reparation else '-' }}</td>
                        <td style="max-width:250px;">{{ depannage.description_panne }}</td>
                        <td style="max-width:200px;">{{ depannage.cause_panne or '-' }}</td>
                        <td>{{ depannage.repare_par }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px; color: #6b7280;">
                            Aucun historique de dépannage disponible.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% include 'partials/admin/_depannage_modal.html' %}

{% block extra_js %}
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
<script src="{{ url_for('static', filename='js/depannage.js') }}"></script>
{% endblock %}
