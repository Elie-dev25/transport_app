{% extends "_base_admin.html" %}

{% block title %}Bus UdM{% endblock %}

{% set active_page = 'bus' %}
{% set page_title = 'Liste des Bus UdM' %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkfHcA21fZyMcJ6r0F/YvC3etwFh0qU6V7qX+6lGJ3j1b8d+6K/Y3GZ3g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modals.css') }}">
    <style>
      /* Styles spécifiques à la page Bus UdM */
      #docFormModal, #addBusModal {
        z-index: 10000;
      }

      /* Styles pour les détails de bus */
      .details-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .details-list li {
        margin: 6px 0;
      }

      /* Indicateurs colorés */
      .indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
      }
      .indicator.green { background-color: #10b981; }
      .indicator.orange { background-color: #f59e0b; }
      .indicator.red { background-color: #ef4444; }

      /* Styles pour les alertes */
      .alert-indicator {
        position: relative;
        cursor: pointer;
      }
      .alert-indicator.has-alerts::after {
        content: '!';
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ef4444;
        color: white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    </style>
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-body">
            <div style="display:flex;justify-content:flex-end;margin-bottom:12px;">
                <button id="openAddBusModal" style="width:42px;height:42px;border:none;border-radius:50%;background:#2563eb;color:#fff;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;" title="Ajouter un Bus UdM">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        <table style="width:100%;background:#fff;border-radius:16px;box-shadow:0 4px 24px rgba(30,64,175,0.07);overflow:hidden;">
            <thead style="background:linear-gradient(90deg,#1e3a8a,#2563eb);color:#fff;">
                <tr>
                    <th style="padding:14px;">Numéro</th>
                    <th>Immatriculation</th>
                    <th>Marque</th>
                    
                    <th>Kilométrage</th>
                    <th>État</th>
                    <th>Places</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for bus in bus_list %}
                <tr style="text-align:center;">
                    <td style="padding:10px 0;">{{ bus.numero }}</td>
                    <td>{{ bus.immatriculation if bus.immatriculation else '-' }}</td>
                    <td>{{ bus.marque if bus.marque else '-' }}</td>
                    
                    <td>{{ bus.kilometrage if bus.kilometrage else '-' }} {{ 'km' if bus.kilometrage else '' }}</td>
                    <td>{{ (bus.etat_vehicule|status_label) if bus.etat_vehicule else '-' }}</td>
                    <td>{{ bus.nombre_places }}</td>
                    <td>
                        <div style="display:flex;gap:8px;justify-content:center;">
                            <button onclick="showBusDetails({{ bus.id }})" style="background:#10b981;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;display:inline-flex;align-items:center;" title="Voir la fiche">
                                <!-- Document text icon -->
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6Z" stroke="currentColor" stroke-width="2" fill="none"/>
                                  <path d="M14 2v6h6" stroke="currentColor" stroke-width="2" fill="none"/>
                                  <path d="M8 12h8M8 15h8M8 18h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </button>
                            <button onclick="openPanneModal('{{ bus.numero }}', '{{ bus.immatriculation or '' }}', {{ bus.kilometrage or 0 }})" style="background:#f59e0b;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;display:inline-flex;align-items:center;" title="Déclarer panne">
                                <!-- Warning triangle icon -->
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                  <path d="M12 3l10 18H2L12 3Z" stroke="currentColor" stroke-width="2" fill="none"/>
                                  <path d="M12 9v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                  <circle cx="12" cy="17" r="1" fill="currentColor"/>
                                </svg>
                            </button>
                            <button onclick="openDocModal({{ bus.id }})" style="background:#3b82f6;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;display:inline-flex;align-items:center;gap:6px;" title="Ajouter un document">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z" stroke="currentColor" stroke-width="2" fill="none"/>
                                  <path d="M14 2v6h6" stroke="currentColor" stroke-width="2" fill="none"/>
                                  <path d="M12 11v6M9 14h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                <span style="display:none;">+</span>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="quick-actions" style="margin-top:24px;">
            <h2 class="section-title">
                <i class="fas fa-tools"></i>
                Opérations 
            </h2>
            <div class="actions-grid">
                <a href="{{ url_for('admin.carburation') }}" class="action-btn">
                    <i class="fas fa-gas-pump"></i>
                    <span>Carburation</span>
                </a>
                <a href="{{ url_for('admin.vidange') }}" class="action-btn">
                    <i class="fas fa-oil-can"></i>
                    <span>Vidange</span>
                </a>
                <a href="#" id="declare-panne-btn" class="action-btn">
                    <i class="fas fa-triangle-exclamation"></i>
                    <span>Déclaration de panne</span>
                </a>
                <a href="/admin/depanage" class="action-btn" id="depanage-btn">
                    <i class="fas fa-wrench"></i>
                    <span>Dépannage</span>
                </a>
            </div>
        </div>
        </div>
    </div>
</div>

{% include 'partials/admin/_document_modal.html' %}

<!-- Modal détails bus -->
<div id="busDetailsModal" class="modal">
  <div class="modal-content" style="max-width:500px;">
    <div class="modal-header">
      <h3>Fiche personnel Bus UdM</h3>
      <button type="button" id="closeBusDetailsModal" class="close-btn">&times;</button>
    </div>
    <div class="modal-body" id="busDetailsBody">
      <!-- Contenu injecté via JS -->
    </div>
  </div>
</div>

{% include 'partials/admin/_declaration_panne_modal.html' %}

{% include 'partials/admin/_add_bus_modal.html' %}

{% endblock %}

{% block extra_scripts %}
<script>
// Scripts spécifiques à la page Bus UdM (jQuery déjà chargé dans _base_dashboard.html)
$(document).ready(function() {
  // Ouvrir automatiquement la modale Document si on arrive avec ?open=doc&bus_id=...
  (function(){
    const params = new URLSearchParams(window.location.search);
    if (params.get('open') === 'doc') {
      const bid = params.get('bus_id');
      if (bid) {
        window.selectedBusId = bid;
        $('#docFormModal').addClass('show');
        // Nettoyer l'URL pour éviter ré-ouverture au refresh
        if (window.history && window.history.replaceState) {
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      }
    }
  })();
  // Gestion de la modale d'ajout de Bus UdM
  $('#openAddBusModal').on('click', function(e) {
    e.preventDefault();
    $('#addBusModal').addClass('show');
  });
  
  $('#closeAddBusModal').on('click', function() {
    $('#addBusModal').removeClass('show');
    $('#addBusForm')[0].reset();
  });
  
  // Fermer la modale si on clique en dehors du contenu
  $('#addBusModal').on('click', function(e) {
    if (e.target === this) {
      $(this).removeClass('show');
      $('#addBusForm')[0].reset();
    }
  });
  
  // Soumission du formulaire d'ajout de Bus UdM
  $('#addBusForm').on('submit', function(e) {
    e.preventDefault();
    $.ajax({
      url: '/admin/ajouter_bus_ajax',
      method: 'POST',
      data: $(this).serialize(),
      success: function(resp) {
        $('#addBusModal').removeClass('show');
        $('#addBusForm')[0].reset();
        if (resp.success) {
          Swal.fire('Succès', resp.message, 'success').then(() => {
            location.reload();
          });
        } else {
          Swal.fire('Erreur', resp.message, 'error');
        }
      },
      error: function() {
        Swal.fire('Erreur', 'Impossible d\'ajouter le bus UdM', 'error');
      }
    });
  });

  // Bouton Déclaration de panne
  $(document).on('click', '#declare-panne-btn', function(e){
    e.preventDefault();
    // Pré-remplir si un bus est sélectionné, sinon vider
    if (window.selectedBusData) {
      $('#numero_bus_udm_panne').val(window.selectedBusData.numero || '');
      $('#immatriculation_panne').val(window.selectedBusData.immatriculation || '');
    } else {
      $('#numero_bus_udm_panne').val('');
      $('#immatriculation_panne').val('');
    }
    // Le kilométrage doit toujours être saisi par l'utilisateur
    $('#kilometrage_panne').val('');
    // Ouvrir la modale de déclaration de panne
    $('#panneModal').removeAttr('hidden').addClass('show').attr('aria-hidden','false');
  });

  // Fermeture modale panne
  $('#closePanneModal, #cancelPanneBtn').on('click', function(){
    $('#panneModal').removeClass('show').attr('aria-hidden','true').attr('hidden','');
    $('#panneForm')[0].reset();
  });

  // Variable globale pour stocker les données du bus sélectionné
  window.selectedBusData = null;
  // Index des Bus UdM par numéro pour autocomplétion
  window.busUdMIndexByNumero = {};
  // Charger la liste des Bus UdM pour alimenter le datalist de la modale panne
  function loadBusUdMListForDatalist(){
    $.get('/admin/bus_udm_list_ajax', function(resp){
      if(resp && resp.success){
        const list = resp.bus_udm || [];
        const options = list.map(b=>{
          // Construire un index pour auto-fill
          window.busUdMIndexByNumero[b.numero] = b;
          const label = b.immatriculation ? `${b.numero} — ${b.immatriculation}` : b.numero;
          return `<option value="${b.numero}" label="${label}"></option>`;
        }).join('');
        $('#busUdMNumerosList').html(options);
      }
    });
  }

  loadBusUdMListForDatalist();

  // Auto-remplir l'immatriculation quand on choisit le Numéro Bus UdM (datalist)
  $('#numero_bus_udm_panne').on('input change', function(){
    const numero = $(this).val();
    const b = (window.busUdMIndexByNumero || {})[numero];
    if (b) {
      $('#immatriculation_panne').val(b.immatriculation || '');
    }
  });

  // Soumission formulaire Déclaration de panne
  $(document).off('submit', '#panneForm').on('submit', '#panneForm', function(e){
    e.preventDefault();
    const $submitBtn = $(this).find('button[type="submit"], .submit-btn');
    $submitBtn.prop('disabled', true);
    const formData = {
      numero_bus_udm: $('#numero_bus_udm_panne').val(),
      numero_aed: ($('#numero_bus_udm_panne').val() || ''),
      immatriculation: $('#immatriculation_panne').val(),
      kilometrage: $('#kilometrage_panne').val(),
      description: $('#description_panne').val(),
      criticite: $('#criticite_panne').val(),
      immobilisation: $('#immobilisation_panne').is(':checked')
    };

    const numTrim = (formData.numero_bus_udm || '').trim();
    if (!numTrim) {
      $submitBtn.prop('disabled', false);
      Swal.fire('Erreur', 'Veuillez choisir un Numéro Bus UdM.', 'error');
      return;
    }
    const hasKm = formData.kilometrage !== '' && formData.kilometrage != null;
    const kmVal = hasKm ? Number(formData.kilometrage) : NaN;
    const minAttr = Number($('#kilometrage_panne').attr('min') || 0);
    if (hasKm && Number.isNaN(kmVal)) {
      $submitBtn.prop('disabled', false);
      Swal.fire('Erreur', 'Kilométrage invalide.', 'error');
      return;
    }
    if (hasKm && kmVal < minAttr) {
      $submitBtn.prop('disabled', false);
      Swal.fire('Erreur', `Le kilométrage doit être supérieur ou égal à ${minAttr}.`, 'error');
      return;
    }
    if (!formData.criticite) {
      $submitBtn.prop('disabled', false);
      Swal.fire('Erreur', 'Veuillez sélectionner la criticité.', 'error');
      return;
    }

    $.ajax({
      url: '/admin/declarer_panne',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(formData),
      success: function(resp){
        if(resp.success){
          Swal.fire('Succès', resp.message, 'success');
          $('#panneModal').removeClass('show').attr('aria-hidden','true').attr('hidden','');
          $('#panneForm')[0].reset();
          setTimeout(() => location.reload(), 1200);
        } else {
          Swal.fire('Erreur', resp.message, 'error');
        }
        $submitBtn.prop('disabled', false);
      },
      error: function(xhr){
        $submitBtn.prop('disabled', false);
        let msg = 'Impossible d\'enregistrer la panne';
        try { if (xhr && xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message; } catch(e){}
        Swal.fire('Erreur', msg, 'error');
      }
    });
  });

  // Fonction pour afficher les détails d'un bus (redirige vers la page serveur)
  window.showBusDetails = function(busId) {
    window.location.href = '/admin/bus/details/' + busId;
  };

  // Fonction pour ouvrir la modale de document
  window.openDocModal = function(busId) {
    window.selectedBusId = busId;
    $('#docFormModal').addClass('show');
  };

  // Fonction pour ouvrir la modale de panne avec des données pré-remplies
  window.openPanneModal = function(numero, immatriculation, kilometrage) {
    $('#numero_bus_udm_panne').val(numero);
    $('#immatriculation_panne').val(immatriculation || '');
    $('#kilometrage_panne').val(kilometrage || '');
    const minKm = (typeof kilometrage !== 'undefined' && kilometrage !== null && kilometrage !== '') ? Number(kilometrage) : 0;
    $('#kilometrage_panne').attr('min', isNaN(minKm) ? 0 : minKm);
    $('#panneModal').removeAttr('hidden').addClass('show').attr('aria-hidden','false');
  };

  // Fermeture des modales
  $('#closeDocFormModal').on('click', function(){ $('#docFormModal').removeClass('show'); });
  $('#closeBusDetailsModal').on('click', function(){ $('#busDetailsModal').removeClass('show'); });
  $('#busDetailsModal').on('click', function(e){ if(e.target === this){ $(this).removeClass('show'); }});

  // Soumission formulaire document
  $('#docForm').on('submit', function(e){
    e.preventDefault();
    const formData = $(this).serialize();
    $.post('/admin/ajouter_document_udm_ajax/'+window.selectedBusId, formData, function(resp){
      if(resp.success){
        Swal.fire('Succès', resp.message, 'success');
        $('#docFormModal').removeClass('show');
      }else{
        Swal.fire('Erreur', resp.message, 'error');
      }
    });
  });
});
</script>
{% endblock %}
