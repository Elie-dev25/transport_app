<!-- Modal Déclaration de Panne -->
{% from 'shared/macros/form_macros.html' import error_container %}

<div id="panneModal" class="modal">
  <div class="modal-content">
    <button type="button" id="closePanneModal" class="close-btn"><i class="fas fa-times"></i></button>
    <div class="modal-header">
      <h3><i class="fas fa-triangle-exclamation"></i> Déclaration de Panne</h3>
    </div>

<script>
// Helpers universels pour la modale Déclaration de Panne
document.addEventListener('DOMContentLoaded', function() {
  // Index global réutilisable entre pages
  window.busUdMIndexByNumero = window.busUdMIndexByNumero || {};

  function populateUdMNumbersIfNeeded() {
    const dl = document.getElementById('busUdMNumerosList');
    // Si déjà peuplé, ne pas recharger
    if (dl && dl.options && dl.options.length > 0) return;
    // Si jQuery est dispo, utiliser $.get, sinon fallback fetch
    const onData = (list) => {
      if (!dl) return;
      const frag = document.createDocumentFragment();
      (list || []).forEach(b => {
        window.busUdMIndexByNumero[b.numero] = b;
        const opt = document.createElement('option');
        opt.value = b.numero;
        opt.label = b.immatriculation ? `${b.numero} — ${b.immatriculation}` : b.numero;
        frag.appendChild(opt);
      });
      dl.innerHTML = '';
      dl.appendChild(frag);
    };

    if (window.$ && $.get) {
      $.get('/admin/bus_udm_list_ajax', function(resp){
        if (resp && resp.success) onData(resp.bus_udm || []);
      });
    } else {
      fetch('/admin/bus_udm_list_ajax')
        .then(r => r.json())
        .then(resp => { if (resp && resp.success) onData(resp.bus_udm || []); })
        .catch(()=>{});
    }
  }

  // Auto-fill et readonly sur immatriculation selon le numéro choisi
  function bindNumeroChangeBehavior() {
    const numeroInput = document.getElementById('numero_bus_udm_panne');
    const immatInput = document.getElementById('immatriculation_panne');
    if (!numeroInput || !immatInput) return;

    const updateImmat = () => {
      const numero = (numeroInput.value || '').trim();
      const b = window.busUdMIndexByNumero ? window.busUdMIndexByNumero[numero] : null;
      if (numero && b) {
        immatInput.value = b.immatriculation || '';
        immatInput.setAttribute('readonly', 'readonly');
      } else if (!numero) {
        immatInput.value = '';
        immatInput.removeAttribute('readonly');
      } else {
        // Numéro saisi non listé: on laisse éditable pour ne pas bloquer l'utilisateur
        immatInput.removeAttribute('readonly');
      }
    };

    numeroInput.addEventListener('input', updateImmat);
    numeroInput.addEventListener('change', updateImmat);
  }

  populateUdMNumbersIfNeeded();
  bindNumeroChangeBehavior();
});
</script>

        <div class="modal-body">
            {{ error_container('panneError') }}
            <form id="panneForm" action="/admin/declarer_panne" method="POST">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="numero_bus_udm_panne">Numéro Bus UdM *</label>
                        <input type="text" id="numero_bus_udm_panne" name="numero_bus_udm" placeholder="Ex: UDM-1234" list="busUdMNumerosList" autocomplete="off">
                        <datalist id="busUdMNumerosList"></datalist>
                    </div>
                    <div class="form-group">
                        <label for="immatriculation_panne">Immatriculation</label>
                        <input type="text" id="immatriculation_panne" name="immatriculation" placeholder="Ex: AB-123-CD">
                    </div>
                    <div class="form-group">
                        <label for="kilometrage_panne">Kilométrage actuel</label>
                        <input type="number" id="kilometrage_panne" name="kilometrage" step="0.1" placeholder="Ex: 152340" required>
                    </div>
                    <div class="form-group">
                        <label for="criticite_panne">Criticité *</label>
                        <select id="criticite_panne" name="criticite" required>
                            <option value="">-- Sélectionner --</option>
                            <option value="FAIBLE">Faible</option>
                            <option value="MOYENNE">Moyenne</option>
                            <option value="HAUTE">Haute</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="description_panne">Description de la panne *</label>
                        <textarea id="description_panne" name="description" rows="4" required
                                  placeholder="Décrivez la panne observée..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label>
                            <input type="checkbox" id="immobilisation_panne" name="immobilisation" value="1">
                            Bus immobilisé (ne peut plus circuler)
                        </label>
                    </div>
                    <div class="form-group full-width">
                        <label for="enregistre_par_panne">Enregistré par</label>
                        <input type="text" id="enregistre_par_panne" name="enregistre_par" readonly
                               value="{{ ((current_user.nom ~ ' ' ~ current_user.prenom)|trim) or current_user.login }}">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-save"></i> Enregistrer la panne
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Initialisation du gestionnaire unifié -->
{% from 'shared/macros/form_macros.html' import init_modal_form %}
{{ init_modal_form('panneForm', 'panneModal', 'panneError', 'Panne déclarée avec succès.') }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestionnaire pour le bouton de fermeture
    const closeBtn = document.getElementById('closePanneModal');
    if (closeBtn) {
        closeBtn.addEventListener('click', function() {
            FormModalManager.closeModal('panneModal');
        });
    }
});
</script>
