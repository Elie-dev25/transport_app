{% extends "layout.html" %}
{% block title %}Carburation{% endblock %}

{% block head %}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- CSS Modulaire - Architecture optimisée pour la maintenance -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-main.css') }}?v=20250821">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/vidanges.css') }}">
    <script src="{{ url_for('static', filename='js/script.js') }}" defer></script>
{% endblock %}

{% block content %}
<!-- Sidebar -->
{% include '_sidebar_admin.html' %}

<div class="main-content">
    {% set page_title = 'Gestion de la Carburation' %}
    {% include '_topbar_admin.html' %}
    
    <div class="vidange-container">
        <div class="vidange-header">
            <h1 class="vidange-title">
                <i class="fas fa-gas-pump"></i>
                Gestion de la Carburation
            </h1>
        </div>

        <!-- Tableau des AED -->
        <div class="vidange-table-container">
            <table class="vidange-table">
                <thead>
                    <tr>
                        <th>Numéro AED</th>
                        <th>Kilométrage Actuel</th>
                        <th>État Réservoir</th>
                        <th>Km Restant</th>
                        <th>Niveau carburant (L)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bus in bus_carburation %}
                    <tr>
                        <td><strong>{{ bus.numero }}</strong></td>
                        <td>{{ bus.kilometrage if bus.kilometrage else '-' }} km</td>
                        <td>
                            <span class="voyant-indicator voyant-{{ bus.voyant }}"></span>
                            {% if bus.voyant == 'green' %}Bon
                            {% elif bus.voyant == 'orange' %}Attention
                            {% else %}Critique
                            {% endif %}
                        </td>
                        <td>
                            {% if bus.km_restant_carburant is not none %}
                                {% if bus.km_restant_carburant <= 0 %}
                                    <span class="status-badge status-critical">URGENT</span>
                                {% elif bus.km_restant_carburant <= 100 %}
                                    <span class="status-badge status-warning">{{ bus.km_restant_carburant }} km</span>
                                {% else %}
                                    <span class="status-badge status-ok">{{ bus.km_restant_carburant }} km</span>
                                {% endif %}
                            {% else %}
                                <span style="color:#94a3b8;">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ bus.niveau_carburant_litres if bus.niveau_carburant_litres is not none else '-' }}
                            {% if bus.niveau_carburant_litres is not none %} L{% endif %}
                        </td>
                        <td>
                            <button class="btn-action btn-carburation"
                                    data-aed-id="{{ bus.id }}"
                                    data-numero="{{ bus.numero|e }}"
                                    data-immatriculation="{{ bus.immatriculation|default('', true)|e }}"
                                    data-effectue-par="{{ (((current_user.nom ~ ' ' ~ current_user.prenom)|trim) or current_user.login)|e }}">
                                <i class="fas fa-gas-pump"></i>
                                Effectuer Carburation
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">
                            Aucun bus AED enregistré.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Historique des carburations -->
        <div class="historique-section">
            <div class="historique-header">
                <h2 class="historique-title">
                    <i class="fas fa-history"></i>
                    Historique des Carburations
                </h2>
                <div class="historique-filter" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                    <select id="carb_numero_select" onchange="filterHistorique(this.value)">
                        <option value="">Tous les bus</option>
                        {% for numero in numeros_aed %}
                        <option value="{{ numero }}" {% if selected_numero == numero %}selected{% endif %}>
                            AED {{ numero }}
                        </option>
                        {% endfor %}
                    </select>
                    <input type="date" id="carb_date_debut" value="{{ selected_date_debut or '' }}" onchange="filterHistorique(document.getElementById('carb_numero_select').value)" />
                    <span>au</span>
                    <input type="date" id="carb_date_fin" value="{{ selected_date_fin or '' }}" onchange="filterHistorique(document.getElementById('carb_numero_select').value)" />
                    <button type="button" title="Effacer filtres" aria-label="Effacer filtres" onclick="clearHistoriqueFilters()" style="border:none;background:transparent;color:#ef4444;width:24px;height:24px;border-radius:4px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;">
                        <i class="fas fa-times" style="font-size:14px;"></i>
                    </button>
                    <span id="carb_loader" style="display:none;align-items:center;gap:6px;color:#6b7280;">
                        <i class="fas fa-spinner fa-spin"></i> Chargement...
                    </span>
                </div>
            </div>
            
            <div class="historique-table-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                <table class="historique-table" style="margin: 0;">
                    <thead style="position: sticky; top: 0; background: #f9fafb; z-index: 10;">
                        <tr>
                            <th>Date</th>
                            <th>Numéro AED</th>
                            <th>Kilométrage</th>
                            <th>Quantité (L)</th>
                            <th>Prix Unitaire</th>
                            <th>Coût Total</th>
                            <th>Remarque</th>
                        </tr>
                    </thead>
                    <tbody id="historique-carb-body">
                        {% for carburation in historique_carburation %}
                        <tr>
                            <td>{{ carburation.date_carburation|date_fr }}</td>
                            <td><strong>{{ carburation.aed.numero }}</strong></td>
                            <td>{{ carburation.kilometrage }} km</td>
                            <td>{{ carburation.quantite_litres }} L</td>
                            <td>{{ carburation.prix_unitaire }} FCFA/L</td>
                            <td><strong>{{ carburation.cout_total }} FCFA</strong></td>
                            <td>{{ carburation.remarque if carburation.remarque else '-' }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 20px; color: #6b7280;">
                                Aucun historique de carburation disponible.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{# --- Modales (2 étapes) --- #}
<!-- 1) Fiche de carburation -->
<div id="ficheCarburationModal" class="modal" aria-hidden="true">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-gas-pump"></i> Fiche de Carburation</h3>
            <button type="button" class="close-btn" onclick="closeCarburationFiche()">&times;</button>
        </div>
        <div class="modal-body">
        <div id="fiche-carburation-content">
            <div class="fiche-vidange-form">
                <div style="margin-bottom:12px;">
                    <strong>Date et heure :</strong> <span id="fiche-carburation-date-heure">-</span>
                </div>
                <div style="margin-bottom:12px;">
                    <strong>Opérateur :</strong> <span id="fiche-carburation-operateur">-</span>
                </div>
                <div style="margin-bottom:12px;">
                    <strong>Numéro du véhicule :</strong> <span id="fiche-carburation-numero">-</span>
                </div>
                <div style="margin-bottom:12px;">
                    <strong>Immatriculation :</strong> <span id="fiche-carburation-immatriculation">-</span>
                </div>
                <div style="display:flex;gap:32px;margin-top:24px;justify-content:center;">
                    <div style="text-align:center;">
                        <strong>Signature Responsable 1</strong>
                        <div class="signature-line"></div>
                    </div>
                    <div style="text-align:center;">
                        <strong>Signature Responsable 2</strong>
                        <div class="signature-line"></div>
                    </div>
                </div>
            </div>
        </div>
            <div style="display:flex;gap:12px;justify-content:center;margin-top:20px;">
                <button class="action-btn" onclick="openFormulaireCarburation()"><i class="fas fa-check"></i> Confirmer la carburation</button>
                <button class="action-btn" style="background:#6b7280;" onclick="printCarburationFiche()"><i class="fas fa-print"></i> Imprimer</button>
            </div>
        </div>
    </div>
    
    <!-- Variables cachées pour transfert -->
    <input type="hidden" id="carburation_aed_id_hidden" />
    <input type="hidden" id="carburation_numero_hidden" />
    <input type="hidden" id="carburation_operateur_hidden" />
</div>

<!-- 2) Formulaire de confirmation carburation -->
<div id="formulaireCarburationModal" class="modal" aria-hidden="true">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-gas-pump"></i> Formulaire de confirmation carburation</h3>
            <button type="button" class="close-btn" onclick="closeFormulaireCarburation()">&times;</button>
        </div>
        <div class="modal-body">
        <form id="formulaire-carburation">
            <input type="hidden" id="aed_id_hidden" name="aed_id_hidden">
            <div style="margin-bottom:12px;">
                <label for="numero_aed">Numéro AED :</label>
                <input type="text" id="numero_aed" name="numero_aed" readonly style="width:100%;padding:8px;border-radius:8px;border:1px solid #e5e7eb;background:#f3f4f6;">
            </div>
            <div style="margin-bottom:12px;">
                <label for="kilometrage_input">Kilométrage :</label>
                <input type="number" id="kilometrage_input" name="kilometrage_input" min="0" required style="width:100%;padding:8px;border-radius:8px;border:1px solid #e5e7eb;">
            </div>
            <div style="margin-bottom:12px;display:flex;gap:12px;">
                <div style="flex:1;">
                    <label for="quantite_input">Quantité (L) :</label>
                    <input type="number" id="quantite_input" name="quantite_input" step="0.1" min="0" required style="width:100%;padding:8px;border-radius:8px;border:1px solid #e5e7eb;">
                </div>
                <div style="flex:1;">
                    <label for="prix_unitaire_input">Prix unitaire (FCFA/L) :</label>
                    <input type="number" id="prix_unitaire_input" name="prix_unitaire_input" step="0.01" min="0" required style="width:100%;padding:8px;border-radius:8px;border:1px solid #e5e7eb;">
                </div>
            </div>
            <div style="margin-bottom:12px;">
                <label for="cout_total_input">Coût total (FCFA) :</label>
                <input type="number" id="cout_total_input" name="cout_total_input" readonly style="width:100%;padding:8px;border-radius:8px;border:1px solid #e5e7eb;background:#f3f4f6;">
            </div>
            <div style="margin-bottom:12px;">
                <label for="remarque_input">Remarque :</label>
                <textarea id="remarque_input" name="remarque_input" rows="3" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e5e7eb;"></textarea>
            </div>
            <button type="submit" class="action-btn" style="width:100%;margin-top:8px;"><i class="fas fa-save"></i> Enregistrer la carburation</button>
        </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Ouvrir la fiche à partir du tableau
    document.querySelectorAll('.btn-carburation').forEach(btn => {
        btn.addEventListener('click', function() {
            const aedId = this.getAttribute('data-aed-id');
            const numero = this.getAttribute('data-numero');
            const immat = this.getAttribute('data-immatriculation');
            const operateur = this.getAttribute('data-effectue-par');

            // Remplir la fiche
            document.getElementById('fiche-carburation-numero').textContent = numero || '-';
            document.getElementById('fiche-carburation-immatriculation').textContent = immat || '-';
            document.getElementById('fiche-carburation-operateur').textContent = operateur || '-';
            const now = new Date();
            const formatted = now.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' + now.toLocaleTimeString('fr-FR');
            document.getElementById('fiche-carburation-date-heure').textContent = formatted;

            // Stocker pour le formulaire
            document.getElementById('carburation_aed_id_hidden').value = aedId || '';
            document.getElementById('carburation_numero_hidden').value = numero || '';
            document.getElementById('carburation_operateur_hidden').value = operateur || '';

            openCarburationFiche();
        });
    });

    // Auto-calcul du coût total
    const recalcCout = () => {
        const q = parseFloat(document.getElementById('quantite_input').value || '0');
        const p = parseFloat(document.getElementById('prix_unitaire_input').value || '0');
        const total = (isNaN(q) ? 0 : q) * (isNaN(p) ? 0 : p);
        document.getElementById('cout_total_input').value = total ? total.toFixed(2) : '';
    };
    ['quantite_input','prix_unitaire_input'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', recalcCout);
    });

    // Soumission du formulaire de confirmation
    const form = document.getElementById('formulaire-carburation');
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const aed_id = document.getElementById('aed_id_hidden').value;
        if (!aed_id) {
            alert("Erreur : aucun véhicule sélectionné. Veuillez ouvrir la fiche avant de confirmer.");
            return;
        }
        const data = {
            aed_id: aed_id,
            kilometrage: document.getElementById('kilometrage_input').value,
            quantite_litres: document.getElementById('quantite_input').value,
            prix_unitaire: document.getElementById('prix_unitaire_input').value,
            cout_total: document.getElementById('cout_total_input').value,
            remarque: document.getElementById('remarque_input').value
        };

        fetch('{{ post_url }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // MAJ de la ligne correspondante
                if (data.bus_updated) updateBusRow(data.bus_updated);
                closeFormulaireCarburation();
                closeCarburationFiche();
                // Recharger pour MAJ de l'historique
                location.reload();
            } else {
                alert('Erreur: ' + (data.message || 'enregistrement'));
            }
        })
        .catch(() => alert('Erreur serveur.'));
    });
});

// Helpers d'ouverture/fermeture
function openCarburationFiche() {
    const m = document.getElementById('ficheCarburationModal');
    if (m) m.setAttribute('aria-hidden', 'false');
}
function closeCarburationFiche() {
    const m = document.getElementById('ficheCarburationModal');
    if (m) m.setAttribute('aria-hidden', 'true');
}
function openFormulaireCarburation() {
    // Alimenter le formulaire depuis les hidden de la fiche
    const aedId = document.getElementById('carburation_aed_id_hidden').value;
    const numero = document.getElementById('carburation_numero_hidden').value;
    document.getElementById('aed_id_hidden').value = aedId || '';
    document.getElementById('numero_aed').value = numero || '';
    const m = document.getElementById('formulaireCarburationModal');
    if (m) m.setAttribute('aria-hidden', 'false');
}
function closeFormulaireCarburation() {
    const m = document.getElementById('formulaireCarburationModal');
    if (m) m.setAttribute('aria-hidden', 'true');
}

function printCarburationFiche() {
    const fiche = document.getElementById('fiche-carburation-content');
    if (!fiche) return;
    const w = window.open('', '_blank', 'width=800,height=600');
    const styles = `
        <style>
            body{font-family: Arial, sans-serif; padding: 20px;}
            .signature-line{border-top:1px solid #000; width:220px; height:40px; margin-top:6px;}
            h2{margin:0 0 12px 0;}
            .meta div{margin-bottom:8px;}
        </style>
    `;
    const header = '<h2>Fiche de Carburation</h2>';
    w.document.write(`<!doctype html><html><head><meta charset="utf-8">${styles}</head><body>${header}${fiche.innerHTML}</body></html>`);
    w.document.close();
    w.focus();
    w.print();
    w.close();
}

function updateBusRow(bus) {
    // Mise à jour similaire à vidange.html mais pour les colonnes carburation
    const rows = document.querySelectorAll('.vidange-table tbody tr');
    rows.forEach(row => {
        const numeroCell = row.querySelector('td:first-child strong');
        if (numeroCell && numeroCell.textContent === bus.numero) {
            const cells = row.querySelectorAll('td');
            // Colonne 2 (index 1): Kilométrage Actuel
            if (cells[1]) cells[1].textContent = (bus.kilometrage ?? '-') + ' km';
            // Colonne 3 (index 2): État Réservoir (voyant)
            if (cells[2]) {
                const spanVoyant = cells[2].querySelector('.voyant-indicator');
                if (spanVoyant) {
                    spanVoyant.className = 'voyant-indicator voyant-' + (bus.voyant || 'green');
                }
                const textNode = cells[2].childNodes[1];
                if (textNode) {
                    if (bus.voyant === 'green') textNode.textContent = 'Bon';
                    else if (bus.voyant === 'orange') textNode.textContent = 'Attention';
                    else textNode.textContent = 'Critique';
                }
            }
            // Colonne 4 (index 3): Km Restant
            if (cells[3]) {
                const v = bus.km_restant_carburant;
                if (v === null || v === undefined) {
                    cells[3].innerHTML = '<span style="color:#94a3b8;">-</span>';
                } else if (v <= 0) {
                    cells[3].innerHTML = '<span class="status-badge status-critical">URGENT</span>';
                } else if (v <= 100) {
                    cells[3].innerHTML = '<span class="status-badge status-warning">' + v + ' km</span>';
                } else {
                    cells[3].innerHTML = '<span class="status-badge status-ok">' + v + ' km</span>';
                }
            }
            // Colonne 5 (index 4): Niveau carburant (L)
            if (cells[4]) {
                const n = bus.niveau_carburant_litres;
                if (n === null || n === undefined) {
                    cells[4].textContent = '-';
                } else {
                    cells[4].textContent = n + ' L';
                }
            }
        }
    });
}
</script>
{% endblock %}
