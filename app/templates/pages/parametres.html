{% if base_template is defined %}
{% extends base_template %}
{% elif use_responsable_base %}
{% extends "roles/responsable/_base_responsable.html" %}
{% elif current_user.role == 'SUPERVISEUR' %}
{% extends "roles/superviseur/_base_superviseur.html" %}
{% else %}
{% extends "roles/admin/_base_admin.html" %}
{% endif %}

{% block title %}Paramètres - TransportUdM{% endblock %}

{% set page_title = 'Paramètres Système' %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/parametres.css') }}?v=20250921">
<script src="{{ url_for('static', filename='js/parametres.js') }}?v=20250921" defer></script>
{% endblock %}

{% block dashboard_content %}
<div class="parametres-container">
    <!-- Header avec gradient moderne -->
    <div class="parametres-header">
        <div class="header-content">
            <div class="header-icon">
                <i class="fas fa-cogs"></i>
            </div>
            <div class="header-text">
                <h1>Paramètres Système</h1>
                <p>Gestion des audits, utilisateurs et configuration système</p>
            </div>
        </div>
        <div class="header-decoration">
            <div class="decoration-circle circle-1"></div>
            <div class="decoration-circle circle-2"></div>
            <div class="decoration-circle circle-3"></div>
        </div>
    </div>

    <!-- Navigation moderne avec glassmorphism -->
    <div class="settings-navigation">
        <nav class="nav-container">
            <div class="nav-item active" data-section="audit">
                <div class="nav-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="nav-content">
                    <span class="nav-title">Audit & Traçabilité</span>
                    <span class="nav-subtitle">Logs système</span>
                </div>
                <div class="nav-indicator"></div>
            </div>

            {% if current_user.role in ['ADMIN', 'RESPONSABLE'] %}
            <div class="nav-item" data-section="users">
                <div class="nav-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="nav-content">
                    <span class="nav-title">Gestion Utilisateurs</span>
                    <span class="nav-subtitle">Création & modification</span>
                </div>
                <div class="permission-tag admin-resp">Admin/Resp</div>
                <div class="nav-indicator"></div>
            </div>
            {% endif %}

            {% if current_user.role == 'ADMIN' %}
            <div class="nav-item" data-section="credentials">
                <div class="nav-icon">
                    <i class="fas fa-key"></i>
                </div>
                <div class="nav-content">
                    <span class="nav-title">Identifiants</span>
                    <span class="nav-subtitle">Modification sécurisée</span>
                </div>
                <div class="permission-tag admin-only">Admin</div>
                <div class="nav-indicator"></div>
            </div>
            {% endif %}

            <div class="nav-item" data-section="session">
                <div class="nav-icon">
                    <i class="fas fa-sign-out-alt"></i>
                </div>
                <div class="nav-content">
                    <span class="nav-title">Session</span>
                    <span class="nav-subtitle">Informations & déconnexion</span>
                </div>
                <div class="nav-indicator"></div>
            </div>
        </nav>
    </div>

    <!-- Contenu des sections -->
    <div class="settings-content">
        <!-- Section Audit & Traçabilité -->
        <div id="audit-section" class="settings-section active">
            <!-- Statistiques avec design moderne -->
            <div class="stats-grid">
                <div class="stat-card admin">
                    <div class="stat-icon">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="admin-count">-</div>
                        <div class="stat-label">Actions Admin</div>
                    </div>
                    <div class="stat-trend">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                </div>

                <div class="stat-card responsable">
                    <div class="stat-icon">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="responsable-count">-</div>
                        <div class="stat-label">Actions Responsable</div>
                    </div>
                    <div class="stat-trend">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                </div>

                <div class="stat-card superviseur">
                    <div class="stat-icon">
                        <i class="fas fa-user-cog"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="superviseur-count">-</div>
                        <div class="stat-label">Actions Superviseur</div>
                    </div>
                    <div class="stat-trend">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                </div>

                <div class="stat-card total">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="total-count">-</div>
                        <div class="stat-label">Total Actions</div>
                    </div>
                    <div class="stat-trend">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                </div>
            </div>

            <!-- Filtres avec design moderne -->
            <div class="modern-card filters-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-filter"></i>
                        <span>Filtres d'Audit</span>
                    </div>
                </div>
                <div class="card-content">
                    <form id="audit-filters" class="filters-form">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label class="filter-label">Rôle</label>
                                <select name="role" class="modern-select">
                                    <option value="">Tous les rôles</option>
                                    <option value="ADMIN">Admin</option>
                                    <option value="RESPONSABLE">Responsable</option>
                                    <option value="SUPERVISEUR">Superviseur</option>
                                    <option value="CHARGE">Chargé Transport</option>
                                    <option value="CHAUFFEUR">Chauffeur</option>
                                    <option value="MECANICIEN">Mécanicien</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">Type d'action</label>
                                <select name="action" class="modern-select">
                                    <option value="">Toutes les actions</option>
                                    <option value="CONSULTATION">Consultation</option>
                                    <option value="CREATION">Création</option>
                                    <option value="MODIFICATION">Modification</option>
                                    <option value="SUPPRESSION">Suppression</option>
                                    <option value="ACTION_ADMIN">Action Admin</option>
                                    <option value="ACTION_METIER">Action Métier</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">Limite</label>
                                <select name="limit" class="modern-select">
                                    <option value="50">50</option>
                                    <option value="100" selected>100</option>
                                    <option value="200">200</option>
                                    <option value="500">500</option>
                                </select>
                            </div>

                            <div class="filter-actions">
                                <button type="submit" class="btn-modern btn-primary">
                                    <i class="fas fa-search"></i>
                                    <span>Filtrer</span>
                                </button>
                                <button type="button" id="reset-filters" class="btn-modern btn-outline">
                                    <i class="fas fa-undo"></i>
                                    <span>Reset</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Logs d'audit avec design moderne -->
            <div class="modern-card logs-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-list"></i>
                        <span>Logs d'Audit</span>
                        <span id="logs-count" class="count-badge">0</span>
                    </div>
                    <button id="refresh-logs" class="btn-icon">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-content">
                    <div id="audit-logs" class="logs-container">
                        <div class="loading-state">
                            <div class="loading-spinner"></div>
                            <p>Chargement des logs...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Gestion Utilisateurs -->
        {% if current_user.role in ['ADMIN', 'RESPONSABLE'] %}
        <div id="users-section" class="settings-section">
            <div class="section-actions">
                <button type="button" class="btn-modern btn-success" data-bs-toggle="modal" data-bs-target="#createUserModal">
                    <i class="fas fa-plus"></i>
                    <span>Créer un utilisateur</span>
                </button>
            </div>

            <div class="modern-card users-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-users"></i>
                        <span>Liste des Utilisateurs</span>
                        <span id="users-count" class="count-badge">0</span>
                    </div>
                    <button id="refresh-users" class="btn-icon">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-content">
                    <div class="table-container">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>Login</th>
                                    <th>Nom Complet</th>
                                    <th>Rôle</th>
                                    <th>Statut</th>
                                    <th>Dernière Connexion</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <tr>
                                    <td colspan="6" class="loading-cell">
                                        <div class="loading-state">
                                            <div class="loading-spinner"></div>
                                            <p>Chargement des utilisateurs...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Section Identifiants -->
        {% if current_user.role == 'ADMIN' %}
        <div id="credentials-section" class="settings-section">
            <div class="modern-card credentials-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-key"></i>
                        <span>Gestion des Identifiants</span>
                    </div>
                </div>
                <div class="card-content">
                    <div class="search-section">
                        <label class="filter-label">Rechercher un utilisateur</label>
                        <div class="search-input-group">
                            <input type="text" id="search-user-credentials" class="modern-input" placeholder="Login ou nom...">
                            <button class="btn-search" type="button" id="search-credentials-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <div id="credentials-search-results" class="search-results hidden">
                        <div class="modern-card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-user"></i>
                                    <span>Utilisateur sélectionné</span>
                                </div>
                            </div>
                            <div class="card-content">
                                <form id="credentials-form" class="credentials-form">
                                    <input type="hidden" id="user-id-credentials" name="user_id">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Login actuel</label>
                                            <input type="text" id="current-login" class="modern-input" readonly>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Nouveau login</label>
                                            <input type="text" id="new-login" name="new_login" class="modern-input" required>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Nouveau mot de passe</label>
                                            <input type="password" id="new-password" name="new_password" class="modern-input" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Confirmer mot de passe</label>
                                            <input type="password" id="confirm-password" name="confirm_password" class="modern-input" required>
                                        </div>
                                    </div>
                                    <div class="form-actions">
                                        <button type="submit" class="btn-modern btn-warning">
                                            <i class="fas fa-key"></i>
                                            <span>Modifier les identifiants</span>
                                        </button>
                                        <button type="button" class="btn-modern btn-outline" id="cancel-credentials">
                                            <i class="fas fa-times"></i>
                                            <span>Annuler</span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Section Session -->
        <div id="session-section" class="settings-section">
            <div class="session-grid">
                <div class="modern-card session-info-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-user"></i>
                            <span>Session Actuelle</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="session-details">
                            <div class="detail-item">
                                <span class="detail-label">Utilisateur:</span>
                                <span class="detail-value">{{ current_user.login }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Nom:</span>
                                <span class="detail-value">{{ current_user.nom }} {{ current_user.prenom }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Rôle:</span>
                                <span class="role-badge {{ current_user.role.lower() }}">{{ current_user.role }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Connexion:</span>
                                <span class="detail-value" id="session-time">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">IP:</span>
                                <span class="detail-value" id="session-ip">{{ request.remote_addr }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modern-card security-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-shield-alt"></i>
                            <span>Sécurité</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="session-details">
                            <div class="detail-item">
                                <span class="detail-label">Dernière activité:</span>
                                <span class="detail-value" id="last-activity">Maintenant</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Sessions actives:</span>
                                <span class="detail-value" id="active-sessions">1</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Tentatives échouées:</span>
                                <span class="detail-value" id="failed-attempts">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modern-card logout-card danger">
                <div class="card-header danger">
                    <div class="card-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Zone de Déconnexion</span>
                    </div>
                </div>
                <div class="card-content">
                    <p class="logout-description">
                        La déconnexion terminera votre session actuelle et vous redirigera vers la page de connexion.
                    </p>
                    <button type="button" class="btn-modern btn-danger" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Se déconnecter</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    {% if current_user.role in ['ADMIN', 'RESPONSABLE'] %}
    <!-- Modal Créer Utilisateur -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content modern-modal">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus"></i>
                        <span>Créer un Utilisateur</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="create-user-form">
                    <div class="modal-body">
                        <div class="form-grid">
                            <div class="form-column">
                                <div class="form-group">
                                    <label class="form-label">Login *</label>
                                    <input type="text" name="login" class="modern-input" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Mot de passe *</label>
                                    <input type="password" name="password" class="modern-input" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Confirmer mot de passe *</label>
                                    <input type="password" name="confirm_password" class="modern-input" required>
                                </div>
                            </div>
                            <div class="form-column">
                                <div class="form-group">
                                    <label class="form-label">Nom *</label>
                                    <input type="text" name="nom" class="modern-input" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Prénom *</label>
                                    <input type="text" name="prenom" class="modern-input" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" name="email" class="modern-input" placeholder="Optionnel">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Téléphone</label>
                                    <input type="tel" name="telephone" class="modern-input" placeholder="Optionnel">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Rôle *</label>
                                    <select name="role" class="modern-select" required>
                                        <option value="">Sélectionner un rôle</option>
                                        <option value="ADMIN">Administrateur</option>
                                        <option value="RESPONSABLE">Responsable</option>
                                        <option value="SUPERVISEUR">Superviseur</option>
                                        <option value="CHARGE">Chargé de Transport</option>
                                        <option value="CHAUFFEUR">Chauffeur</option>
                                        <option value="MECANICIEN">Mécanicien</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-modern btn-outline" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i>
                            <span>Annuler</span>
                        </button>
                        <button type="submit" class="btn-modern btn-success">
                            <i class="fas fa-plus"></i>
                            <span>Créer l'utilisateur</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Modifier Rôle -->
    <div class="modal fade" id="editRoleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content modern-modal">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-tag"></i>
                        <span>Modifier le Rôle</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="edit-role-form">
                    <div class="modal-body">
                        <input type="hidden" name="user_id" id="edit-role-user-id">
                        <div class="form-group">
                            <label class="form-label">Utilisateur</label>
                            <input type="text" id="edit-role-user-name" class="modern-input" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Rôle actuel</label>
                            <input type="text" id="edit-role-current" class="modern-input" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nouveau rôle *</label>
                            <select name="new_role" id="edit-role-new" class="modern-select" required>
                                <option value="">Sélectionner un rôle</option>
                                <option value="ADMIN">Administrateur</option>
                                <option value="RESPONSABLE">Responsable</option>
                                <option value="SUPERVISEUR">Superviseur</option>
                                <option value="CHARGE">Chargé de Transport</option>
                                <option value="CHAUFFEUR">Chauffeur</option>
                                <option value="MECANICIEN">Mécanicien</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-modern btn-outline" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i>
                            <span>Annuler</span>
                        </button>
                        <button type="submit" class="btn-modern btn-warning">
                            <i class="fas fa-user-tag"></i>
                            <span>Modifier le rôle</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}