{% if base_template is defined %}
{% extends base_template %}
{% elif use_responsable_base %}
{% extends "roles/responsable/_base_responsable.html" %}
{% elif current_user.role == 'SUPERVISEUR' %}
{% extends "roles/superviseur/_base_superviseur.html" %}
{% else %}
{% extends "roles/admin/_base_admin.html" %}
{% endif %}

{% block title %}Paramètres - TransportUdM{% endblock %}

{% set page_title = 'Paramètres Système' %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/parametres.css') }}?v=20250921">
<script src="{{ url_for('static', filename='js/main.js') }}?v=20250921" defer></script>
<script src="{{ url_for('static', filename='js/parametres.js') }}?v=20250921" defer></script>
{% endblock %}

{% block dashboard_content %}
<div class="parametres-container" data-user-role="{{ current_user.role }}">
    <!-- Header avec gradient moderne -->
    <div class="parametres-header">
        <div class="header-content">
            <div class="header-icon">
                <i class="fas fa-cogs"></i>
            </div>
            <div class="header-text">
                <h1>Paramètres Système</h1>
                <p>Gestion des audits, utilisateurs et configuration système</p>
            </div>
        </div>
        <div class="header-decoration">
            <div class="decoration-circle circle-1"></div>
            <div class="decoration-circle circle-2"></div>
            <div class="decoration-circle circle-3"></div>
        </div>
    </div>

    <!-- Navigation moderne avec glassmorphism -->
    <div class="settings-navigation">
        <nav class="nav-container">
            <div class="nav-item active" data-section="audit">
                <div class="nav-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="nav-content">
                    <span class="nav-title">Audit & Traçabilité</span>
                    <span class="nav-subtitle">Logs système</span>
                </div>
                <div class="nav-indicator"></div>
            </div>

            {% if current_user.role in ['ADMIN', 'RESPONSABLE', 'SUPERVISEUR'] %}
            <div class="nav-item" data-section="users">
                <div class="nav-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="nav-content">
                    <span class="nav-title">Gestion Utilisateurs</span>
                    <span class="nav-subtitle">{% if current_user.role == 'SUPERVISEUR' %}Consultation{% else %}Création & modification{% endif %}</span>
                </div>

                <div class="nav-indicator"></div>
            </div>
            {% endif %}

            {% if current_user.role in ['ADMIN', 'RESPONSABLE', 'SUPERVISEUR'] %}
            <div class="nav-item" data-section="prestataires">
                <div class="nav-icon">
                    <i class="fas fa-truck"></i>
                </div>
                <div class="nav-content">
                    <span class="nav-title">Prestataires</span>
                    <span class="nav-subtitle">{% if current_user.role == 'SUPERVISEUR' %}Consultation{% else %}Gestion des prestataires{% endif %}</span>
                </div>

                <div class="nav-indicator"></div>
            </div>
            {% endif %}

            {% if current_user.role == 'ADMIN' %}
            <div class="nav-item" data-section="credentials">
                <div class="nav-icon">
                    <i class="fas fa-key"></i>
                </div>
                <div class="nav-content">
                    <span class="nav-title">Identifiants</span>
                    <span class="nav-subtitle">Modification sécurisée</span>
                </div>
                
                <div class="nav-indicator"></div>
            </div>
            {% endif %}

            <div class="nav-item" data-section="session">
                <div class="nav-icon">
                    <i class="fas fa-sign-out-alt"></i>
                </div>
                <div class="nav-content">
                    <span class="nav-title">Session</span>
                    <span class="nav-subtitle">Informations & déconnexion</span>
                </div>
                <div class="nav-indicator"></div>
            </div>
        </nav>
    </div>

    <!-- Contenu des sections -->
    <div class="settings-content">
        <!-- Section Audit & Traçabilité -->
        <div id="audit-section" class="settings-section active">
            <!-- En-tête de section amélioré -->
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-shield-alt"></i>
                    <h2>Système d'Audit Intelligent</h2>
                </div>
                <div class="section-subtitle">
                    <p>Traçabilité complète des actions critiques - 6 rôles surveillés</p>
                </div>
            </div>

            <!-- Statistiques avec design moderne pour les 6 rôles -->
            <div class="stats-grid-6">
                <div class="stat-card admin">
                    <div class="stat-icon">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="admin-count">-</div>
                        <div class="stat-label">Admin</div>
                        <div class="stat-success-rate" id="admin-success">100%</div>
                    </div>
                    <div class="stat-level-indicator">
                        <div class="level-bar" id="admin-critical-bar"></div>
                    </div>
                </div>

                <div class="stat-card responsable">
                    <div class="stat-icon">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="responsable-count">-</div>
                        <div class="stat-label">Responsable</div>
                        <div class="stat-success-rate" id="responsable-success">100%</div>
                    </div>
                    <div class="stat-level-indicator">
                        <div class="level-bar" id="responsable-critical-bar"></div>
                    </div>
                </div>

                <div class="stat-card superviseur">
                    <div class="stat-icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="superviseur-count">-</div>
                        <div class="stat-label">Superviseur</div>
                        <div class="stat-success-rate" id="superviseur-success">100%</div>
                    </div>
                    <div class="stat-level-indicator">
                        <div class="level-bar" id="superviseur-critical-bar"></div>
                    </div>
                </div>

                <div class="stat-card charge">
                    <div class="stat-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="charge-count">-</div>
                        <div class="stat-label">Chargé Transport</div>
                        <div class="stat-success-rate" id="charge-success">100%</div>
                    </div>
                    <div class="stat-level-indicator">
                        <div class="level-bar" id="charge-critical-bar"></div>
                    </div>
                </div>

                <div class="stat-card chauffeur">
                    <div class="stat-icon">
                        <i class="fas fa-steering-wheel"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="chauffeur-count">-</div>
                        <div class="stat-label">Chauffeur</div>
                        <div class="stat-success-rate" id="chauffeur-success">100%</div>
                    </div>
                    <div class="stat-level-indicator">
                        <div class="level-bar" id="chauffeur-critical-bar"></div>
                    </div>
                </div>

                <div class="stat-card mecanicien">
                    <div class="stat-icon">
                        <i class="fas fa-wrench"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="mecanicien-count">-</div>
                        <div class="stat-label">Mécanicien</div>
                        <div class="stat-success-rate" id="mecanicien-success">100%</div>
                    </div>
                    <div class="stat-level-indicator">
                        <div class="level-bar" id="mecanicien-critical-bar"></div>
                    </div>
                </div>
            </div>

            <!-- Alertes critiques -->
            <div class="modern-card alerts-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Alertes Critiques (24h)</span>
                        <span id="alerts-count" class="count-badge critical">0</span>
                    </div>
                    <button id="refresh-alerts" class="btn-icon">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-content">
                    <div id="critical-alerts" class="alerts-container">
                        <div class="no-alerts">
                            <i class="fas fa-check-circle"></i>
                            <p>Aucune alerte critique</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtres avec design moderne -->
            <div class="modern-card filters-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-filter"></i>
                        <span>Filtres d'Audit</span>
                    </div>
                </div>
                <div class="card-content">
                    <form id="audit-filters" class="filters-form">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label class="filter-label">Rôle</label>
                                <select name="role" class="modern-select">
                                    <option value="">Tous les rôles</option>
                                    <option value="ADMIN">Admin</option>
                                    <option value="RESPONSABLE">Responsable</option>
                                    <option value="SUPERVISEUR">Superviseur</option>
                                    <option value="CHARGE">Chargé Transport</option>
                                    <option value="CHAUFFEUR">Chauffeur</option>
                                    <option value="MECANICIEN">Mécanicien</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">Type d'action</label>
                                <select name="action" class="modern-select">
                                    <option value="">Toutes les actions</option>
                                    <option value="LOGIN_SUCCESS">Connexion réussie</option>
                                    <option value="LOGIN_FAILED">Connexion échouée</option>
                                    <option value="LOGOUT">Déconnexion</option>
                                    <option value="CREATE">Création</option>
                                    <option value="UPDATE">Modification</option>
                                    <option value="DELETE">Suppression</option>
                                    <option value="USER_CREATED">Utilisateur créé</option>
                                    <option value="USER_ROLE_CHANGED">Rôle modifié</option>
                                    <option value="SENSITIVE_ACCESS">Accès sensible</option>
                                    <option value="UNAUTHORIZED_ACCESS">Accès refusé</option>
                                    <option value="SYSTEM_ERROR">Erreur système</option>
                                    <option value="SECURITY_VIOLATION">Violation sécurité</option>
                                    <option value="CONFIG_CHANGED">Config modifiée</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">Niveau</label>
                                <select name="level" class="modern-select">
                                    <option value="">Tous les niveaux</option>
                                    <option value="CRITICAL">Critique</option>
                                    <option value="HIGH">Élevé</option>
                                    <option value="MEDIUM">Moyen</option>
                                    <option value="LOW">Faible</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">Limite</label>
                                <select name="limit" class="modern-select">
                                    <option value="50">50</option>
                                    <option value="100" selected>100</option>
                                    <option value="200">200</option>
                                    <option value="500">500</option>
                                </select>
                            </div>

                            <div class="filter-actions">
                                <button type="submit" class="btn-modern btn-primary">
                                    <i class="fas fa-search"></i>
                                    <span>Filtrer</span>
                                </button>
                                <button type="button" id="reset-filters" class="btn-modern btn-outline">
                                    <i class="fas fa-undo"></i>
                                    <span>Reset</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Logs d'audit avec design moderne -->
            <div class="modern-card logs-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-list"></i>
                        <span>Logs d'Audit</span>
                        <span id="logs-count" class="count-badge">0</span>
                    </div>
                    <button id="refresh-logs" class="btn-icon">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-content">
                    <div id="audit-logs" class="logs-container">
                        <div class="loading-state">
                            <div class="loading-spinner"></div>
                            <p>Chargement des logs...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Gestion Utilisateurs -->
        {% if current_user.role in ['ADMIN', 'RESPONSABLE', 'SUPERVISEUR'] %}
        <div id="users-section" class="settings-section">
            {% if current_user.role in ['ADMIN', 'RESPONSABLE'] %}
            <div class="section-actions">
                <button type="button" class="btn-modern btn-success" onclick="openAddUserModal()">
                    <i class="fas fa-plus"></i>
                    <span>Créer un utilisateur</span>
                </button>
            </div>
            {% endif %}

            <div class="modern-card users-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-users"></i>
                        <span>Liste des Utilisateurs</span>
                        <span id="users-count" class="count-badge">0</span>
                    </div>
                    <button id="refresh-users" class="btn-icon">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-content">
                    <div class="table-container">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>Login</th>
                                    <th>Nom</th>
                                    <th>Prénom</th>
                                    <th>Rôle</th>
                                    <th>Statut</th>
                                    <th>Dernière Connexion</th>
                                    {% if current_user.role in ['ADMIN', 'RESPONSABLE'] %}
                                    <th>Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <tr>
                                    <td colspan="{% if current_user.role in ['ADMIN', 'RESPONSABLE'] %}7{% else %}6{% endif %}" class="loading-cell">
                                        <div class="loading-state">
                                            <div class="loading-spinner"></div>
                                            <p>Chargement des utilisateurs...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Section Gestion Prestataires -->
        {% if current_user.role in ['ADMIN', 'RESPONSABLE', 'SUPERVISEUR'] %}
        <div id="prestataires-section" class="settings-section">
            {% if current_user.role in ['ADMIN', 'RESPONSABLE'] %}
            <div class="section-actions">
                <button type="button" class="btn-modern btn-success" onclick="openCreatePrestataireModal()">
                    <i class="fas fa-plus"></i>
                    <span>Créer un prestataire</span>
                </button>
            </div>
            {% endif %}

            <div class="modern-card prestataires-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-truck"></i>
                        <span>Liste des Prestataires</span>
                        <span id="prestataires-count" class="count-badge">0</span>
                    </div>
                    <button id="refresh-prestataires" class="btn-icon">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-content">
                    <div class="table-container">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>Nom du Prestataire</th>
                                    <th>Téléphone</th>
                                    <th>Email</th>
                                    <th>Localisation</th>
                                    {% if current_user.role in ['ADMIN', 'RESPONSABLE'] %}
                                    <th>Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody id="prestataires-table-body">
                                <tr>
                                    <td colspan="{% if current_user.role in ['ADMIN', 'RESPONSABLE'] %}5{% else %}4{% endif %}" class="loading-cell">
                                        <div class="loading-state">
                                            <div class="loading-spinner"></div>
                                            <p>Chargement des prestataires...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Section Identifiants -->
        {% if current_user.role == 'ADMIN' %}
        <div id="credentials-section" class="settings-section">
            <div class="modern-card credentials-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-key"></i>
                        <span>Gestion des Identifiants</span>
                    </div>
                </div>
                <div class="card-content">
                    <div class="search-section">
                        <label class="filter-label">Rechercher un utilisateur</label>
                        <div class="search-input-group">
                            <input type="text" id="search-user-credentials" class="modern-input" placeholder="Login ou nom...">
                            <button class="btn-search" type="button" id="search-credentials-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <div id="credentials-search-results" class="search-results hidden">
                        <div class="modern-card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-user"></i>
                                    <span>Utilisateur sélectionné</span>
                                </div>
                            </div>
                            <div class="card-content">
                                <form id="credentials-form" class="credentials-form">
                                    <input type="hidden" id="user-id-credentials" name="user_id">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Login actuel</label>
                                            <input type="text" id="current-login" class="modern-input" readonly>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Nouveau login</label>
                                            <input type="text" id="new-login" name="new_login" class="modern-input" required>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Nouveau mot de passe</label>
                                            <input type="password" id="new-password" name="new_password" class="modern-input" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Confirmer mot de passe</label>
                                            <input type="password" id="confirm-password" name="confirm_password" class="modern-input" required>
                                        </div>
                                    </div>
                                    <div class="form-actions">
                                        <button type="submit" class="btn-modern btn-warning">
                                            <i class="fas fa-key"></i>
                                            <span>Modifier les identifiants</span>
                                        </button>
                                        <button type="button" class="btn-modern btn-outline" id="cancel-credentials">
                                            <i class="fas fa-times"></i>
                                            <span>Annuler</span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Section Session -->
        <div id="session-section" class="settings-section">
            <div class="session-grid">
                <div class="modern-card session-info-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-user"></i>
                            <span>Session Actuelle</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="session-details">
                            <div class="detail-item">
                                <span class="detail-label">Utilisateur:</span>
                                <span class="detail-value">{{ current_user.login }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Nom:</span>
                                <span class="detail-value">{{ current_user.nom }} {{ current_user.prenom }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Rôle:</span>
                                <span class="role-badge {{ current_user.role.lower() }}">{{ current_user.role }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Connexion:</span>
                                <span class="detail-value" id="session-time">-</span>
                            </div>
                           
                        </div>
                    </div>
                </div>

                <div class="modern-card security-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-shield-alt"></i>
                            <span>Sécurité</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="session-details">
                            <div class="detail-item">
                                <span class="detail-label">Dernière activité:</span>
                                <span class="detail-value" id="last-activity">Maintenant</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Sessions actives:</span>
                                <span class="detail-value" id="active-sessions">1</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Tentatives échouées:</span>
                                <span class="detail-value" id="failed-attempts">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modern-card logout-card danger">
                <div class="card-header danger">
                    <div class="card-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Zone de Déconnexion</span>
                    </div>
                </div>
                <div class="card-content">
                    <p class="logout-description">
                        La déconnexion terminera votre session actuelle et vous redirigera vers la page de connexion.
                    </p>
                    <button type="button" class="btn-modern btn-danger" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Se déconnecter</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include des modals existants -->
    {% if current_user.role in ['ADMIN', 'RESPONSABLE'] %}
    {% include 'shared/modals/_add_user_modal.html' %}
    {% include 'shared/modals/_create_prestataire_modal.html' %}
    {% endif %}
</div>
{% endblock %}