{% if base_template is defined %}
{% extends base_template %}
{% elif superviseur_mode %}
{% extends "roles/superviseur/_base_superviseur.html" %}
{% else %}
{% extends "roles/admin/_base_admin.html" %}
{% endif %}
{% from 'shared/macros/tableaux_components.html' import table_container, status_badge, icon_cell, date_cell %}

{% block title %}Utilisateurs{% endblock %}

{% set active_page = 'utilisateurs' %}
{% set page_title = 'Liste des Utilisateurs' %}
{% set readonly = readonly or superviseur_mode %}

{% block extra_head %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tableaux.css') }}">
    <script src="{{ url_for('static', filename='js/tableaux.js') }}"></script>
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
    <!-- Bouton d'ajout -->
    <div class="d-flex justify-content-end mb-3">
        <button id="openAddUserModal" class="btn btn-primary rounded-circle" style="width:50px;height:50px;" title="Ajouter un utilisateur">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Tableau des utilisateurs -->
    {% call table_container('Liste des Utilisateurs', 'users', search=true, subtitle='Gestion des comptes et accès système', table_id='usersTable') %}
        <table class="table table-striped table-hover sortable">
            <thead>
                <tr>
                    <th>Nom d'utilisateur</th>
                    <th>Login</th>
                    <th>Rôle</th>
                    <th>Statut</th>
                    {% if not readonly %}
                    <th class="no-sort">Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for user in user_list %}
                <tr>
                    <td>
                        {% if user.prenom or user.nom %}
                            <strong>{{ ((user.prenom ~ ' ' ~ user.nom)|trim) }}</strong>
                        {% else %}
                            <span class="text-muted">{{ user.login }}</span>
                        {% endif %}
                    </td>
                    <td>{{ icon_cell('user', user.login) }}</td>
                    <td>
                        {% if user.role == 'ADMIN' %}
                            {{ status_badge('Administrateur', 'danger', 'user-shield') }}
                        {% elif user.role == 'SUPERVISEUR' %}
                            {{ status_badge('Superviseur', 'info', 'user-tie') }}
                        {% elif user.role == 'CHAUFFEUR' %}
                            {{ status_badge('Chauffeur', 'primary', 'user') }}
                        {% elif user.role == 'MECANICIEN' %}
                            {{ status_badge('Mécanicien', 'warning', 'wrench') }}
                        {% elif user.role == 'CHARGE' %}
                            {{ status_badge('Chargé', 'secondary', 'clipboard') }}
                        {% else %}
                            {{ status_badge(user.role or 'Utilisateur', 'secondary') }}
                        {% endif %}
                    </td>
                    <td>
                        {% if user.actif %}
                            {{ status_badge('Actif', 'success', 'check-circle') }}
                        {% else %}
                            {{ status_badge('Inactif', 'secondary', 'times-circle') }}
                        {% endif %}
                    </td>
                    {% if not readonly %}
                    <td>
                        <div class="table-actions">
                            <button class="table-btn delete delete-user-btn" data-id="{{ user.utilisateur_id }}" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="table-empty">
                        <i class="fas fa-users"></i>
                        <h5>Aucun utilisateur enregistré</h5>
                        <p>Cliquez sur le bouton + pour ajouter votre premier utilisateur.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endcall %}
</div>

<!-- Modal pour ajout utilisateur (partiel commun) -->
{% include 'shared/modals/_add_user_modal.html' %}

{% endblock %}

{% block extra_scripts %}
<script>
$(function() {
  $(document).on('click', '.delete-user-btn', function(e) {
    e.preventDefault();
    const userId = $(this).data('id');
    Swal.fire({
      title: 'Êtes-vous sûr ?',
      text: "Cette action est irréversible !",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Oui, supprimer',
      cancelButtonText: 'Annuler'
    }).then((result) => {
      if (result.isConfirmed) {
      $.ajax({
        url: '/admin/supprimer_utilisateur_ajax/' + userId,
        method: 'POST',
        success: function(resp) {
          if (resp.success) {
            // Supprimer la ligne du tableau au lieu de recharger
            $('tr[data-user-id="' + userId + '"]').fadeOut(300, function() {
              $(this).remove();
            });
          } else {
            alert(resp.message || 'Erreur lors de la suppression');
          }
        },
        error: function() {
          alert('Erreur lors de la suppression');
        }
      });
    }
  });
  });

  // Ouverture de la modale d'ajout d'utilisateur
  $('#openAddUserModal').on('click', function(e) {
    e.preventDefault();
    $('#addUserModal').addClass('show');
    // Init champs chauffeur selon rôle sélectionné et auto-login
    setTimeout(function(){
      toggleChauffeurFields();
      // réinitialiser le flag d'édition manuelle du login
      $('#addUserForm input[name="login"]').data('userEdited', false);
      updateLoginFromName();
    }, 0);
  });
  // Fermeture de la modale
  $('#closeAddUserModal').on('click', function() {
    $('#addUserModal').removeClass('show');
  });
  $('#addUserModal').on('click', function(e) {
    if (e.target === this) {
      $(this).removeClass('show');
    }
  });
  // Toggle champs Chauffeur selon rôle
  function toggleChauffeurFields() {
    const role = $('#roleSelectAddUser').val();
    const isPermisRole = (role === 'CHAUFFEUR' || role === 'MECANICIEN');
    const $container = $('#addUserForm');
    const $permis = $container.find('.permis-only');
    const $num = $container.find('input[name="numero_permis"]');
    const $del = $container.find('input[name="date_delivrance_permis"]');
    const $exp = $container.find('input[name="date_expiration_permis"]');
    if (isPermisRole) {
      $permis.show();
      $num.attr('required', true);
      $del.attr('required', true);
      $exp.attr('required', true);
    } else {
      $permis.hide();
      $num.removeAttr('required');
      $del.removeAttr('required');
      $exp.removeAttr('required');
    }
  }
  $(document).on('change', '#roleSelectAddUser', toggleChauffeurFields);
  // --- Auto-génération du login depuis nom + prénom ---
  function slugify(str) {
    return (str || '')
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .toLowerCase()
      .replace(/[^a-z0-9\.]+/g, '')
      .replace(/\.+/g, '.')
      .replace(/^\.|\.$/g, '');
  }
  function updateLoginFromName() {
    const $login = $('#addUserForm input[name="login"]');
    if ($login.data('userEdited')) return; // ne pas écraser si l'utilisateur a saisi
    const nom = ($('#addUserForm input[name="nom"]').val() || '').trim();
    const prenom = ($('#addUserForm input[name="prenom"]').val() || '').trim();
    if (!nom && !prenom) return;
    const base = [prenom, nom].filter(Boolean).join('.');
    const candidate = slugify(base);
    if (candidate) { $login.val(candidate); }
  }
  $(document).on('input', '#addUserForm input[name="nom"], #addUserForm input[name="prenom"]', updateLoginFromName);
  $(document).on('input', '#addUserForm input[name="login"]', function(){
    $(this).data('userEdited', true);
  });
  // Soumission du formulaire d'ajout d'utilisateur
  $('#addUserForm').on('submit', function(e) {
    e.preventDefault();
    $.ajax({
      url: '/admin/ajouter_utilisateur_ajax',
      method: 'POST',
      data: $(this).serialize(),
      success: function(resp) {
        $('#addUserModal').removeClass('show');
        $('body').append('<div class="flash-message success">' + resp.message + '</div>');
        setTimeout(function() { $('.flash-message.success').fadeOut(500, function() { $(this).remove(); }); }, 3000);
        location.reload();
      },
      error: function(xhr) {
        let msg = xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : 'Erreur lors de l\'ajout';
        $('body').append('<div class="flash-message danger">' + msg + '</div>');
        setTimeout(function() { $('.flash-message.danger').fadeOut(500, function() { $(this).remove(); }); }, 3000);
      }
    });
  });
});
</script>
{% endblock %}