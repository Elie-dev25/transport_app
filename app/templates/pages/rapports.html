{% extends 'roles/superviseur/_base_superviseur.html' if superviseur_mode else "roles/admin/_base_admin.html" %}
{% from 'shared/macros/tableaux_components.html' import table_container, status_badge, icon_cell, date_cell, number_cell %}

{% block title %}Rapports - Gestion Transport{% endblock %}

{% set active_page = 'rapports' %}
{% set page_title = 'Rapports et Analyses' %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tableaux.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/rapports.css') }}">
{% endblock %}

{# Wrap the main body in a macro so we can render it in both base blocks #}
{% macro rapports_body() %}
<div class="rapports-container">
    <!-- Header avec statistiques rapides -->
    <div class="rapports-header">
        <div class="header-content">
            <h1><i class="fas fa-chart-bar"></i> Tableau de Bord</h1>
            <p>Vue d'ensemble des performances du système de transport UdM</p>
        </div>
        <div class="header-actions">
            <button id="refresh-data" class="btn btn-success">
                <i class="fas fa-sync-alt"></i> Actualiser
            </button>
            <button id="export-pdf" class="btn btn-primary">
                <i class="fas fa-file-pdf"></i> Export PDF
            </button>
        </div>
    </div>

    <!-- Statistiques Rapides -->
    {% call table_container('Statistiques Rapides', 'chart-bar', search=false, subtitle='Vue d\'ensemble des performances du système de transport', table_id='statsOverview') %}
        <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <!-- Carte Aujourd'hui -->
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-calendar-day"></i>
                    <h4>Aujourd'hui</h4>
                </div>
                <div class="info-card-body">
                    <div class="info-item">
                        <span class="info-label">Trajets :</span>
                        <span class="info-value">{{ icon_cell('route', stats.today.total_trajets|string) }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Passagers :</span>
                        <span class="info-value">{{ icon_cell('users', stats.today.total_passagers|string) }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Étudiants :</span>
                        <span class="info-value">{{ status_badge(stats.today.passagers_etudiants|string, 'info') }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Personnel :</span>
                        <span class="info-value">{{ status_badge(stats.today.passagers_personnel|string, 'success') }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Malades :</span>
                        <span class="info-value">{{ status_badge(stats.today.passagers_malades|string, 'warning') }}</span>
                    </div>
                </div>
            </div>

            <!-- Carte Cette Semaine -->
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-calendar-week"></i>
                    <h4>Cette Semaine</h4>
                </div>
                <div class="info-card-body">
                    <div class="info-item">
                        <span class="info-label">Trajets :</span>
                        <span class="info-value">{{ icon_cell('route', stats.week.total_trajets|string) }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Passagers :</span>
                        <span class="info-value">{{ icon_cell('users', stats.week.total_passagers|string) }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Étudiants :</span>
                        <span class="info-value">{{ status_badge(stats.week.passagers_etudiants|string, 'info') }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Personnel :</span>
                        <span class="info-value">{{ status_badge(stats.week.passagers_personnel|string, 'success') }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Malades :</span>
                        <span class="info-value">{{ status_badge(stats.week.passagers_malades|string, 'warning') }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Période :</span>
                        <span class="info-value">{{ stats.week.jours_periode }} jours</span>
                    </div>
                </div>
            </div>

            <!-- Carte Ce Mois -->
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-calendar-alt"></i>
                    <h4>Ce Mois</h4>
                </div>
                <div class="info-card-body">
                    <div class="info-item">
                        <span class="info-label">Trajets :</span>
                        <span class="info-value">{{ icon_cell('route', stats.month.total_trajets|string) }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Passagers :</span>
                        <span class="info-value">{{ icon_cell('users', stats.month.total_passagers|string) }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Étudiants :</span>
                        <span class="info-value">{{ status_badge(stats.month.passagers_etudiants|string, 'info') }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Personnel :</span>
                        <span class="info-value">{{ status_badge(stats.month.passagers_personnel|string, 'success') }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Malades :</span>
                        <span class="info-value">{{ status_badge(stats.month.passagers_malades|string, 'warning') }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Période :</span>
                        <span class="info-value">{{ stats.month.jours_periode }} jours</span>
                    </div>
                </div>
            </div>

            <!-- Carte Flotte -->
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-bus"></i>
                    <h4>État de la Flotte</h4>
                </div>
                <div class="info-card-body">
                    <div class="info-item">
                        <span class="info-label">Total Bus :</span>
                        <span class="info-value">{{ icon_cell('bus', stats.fleet.total_bus|string) }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Bus Actifs :</span>
                        <span class="info-value">{{ status_badge(stats.fleet.bus_actifs|string, 'success') }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">En Maintenance :</span>
                        <span class="info-value">{{ status_badge(stats.fleet.bus_maintenance|string, 'warning') }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Kilométrage total :</span>
                        <span class="info-value">{{ icon_cell('tachometer-alt', "{:,}".format(stats.fleet.km_total) + ' km') }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Moyenne par bus :</span>
                        <span class="info-value">{{ icon_cell('tachometer-alt', stats.fleet.moyenne_km|string + ' km') }}</span>
                    </div>
                </div>
            </div>
        </div>
    {% endcall %}

    <!-- Section Rapports Détaillés -->
    {% call table_container('Rapports Détaillés', 'file-alt', search=false, subtitle='Accès aux rapports spécialisés et exports', table_id='rapportsDetailles') %}
        {% set base_bp = 'superviseur' if superviseur_mode else 'admin' %}
        <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <!-- Rapport Noblesse -->
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-bus"></i>
                    <h4>Rapport Noblesse</h4>
                </div>
                <div class="info-card-body">
                    <p style="color: #6b7280; margin-bottom: 15px;">Trajets et statistiques des véhicules Noblesse</p>
                    <a href="{{ url_for(base_bp ~ '.rapport_noblesse') }}" class="table-btn action" style="width: 100%;">
                        <i class="fas fa-eye"></i>
                        Consulter le rapport
                    </a>
                </div>
            </div>

            <!-- Rapport Charter -->
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-bus"></i>
                    <h4>Rapport Charter</h4>
                </div>
                <div class="info-card-body">
                    <p style="color: #6b7280; margin-bottom: 15px;">Trajets et statistiques des véhicules Charter</p>
                    <a href="{{ url_for(base_bp ~ '.rapport_charter') }}" class="table-btn action" style="width: 100%;">
                        <i class="fas fa-eye"></i>
                        Consulter le rapport
                    </a>
                </div>
            </div>

            <!-- Rapport Bus UdM -->
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-university"></i>
                    <h4>Rapport Bus UdM</h4>
                </div>
                <div class="info-card-body">
                    <p style="color: #6b7280; margin-bottom: 15px;">Trajets et statistiques des bus universitaires</p>
                    <a href="{{ url_for(base_bp ~ '.rapport_bus_udm') }}" class="table-btn action" style="width: 100%;">
                        <i class="fas fa-eye"></i>
                        Consulter le rapport
                    </a>
                </div>
            </div>
        </div>
    {% endcall %}

    <!-- Section Performances Chauffeurs -->
    {% call table_container('Performances Chauffeurs', 'tachometer-alt', search=false, subtitle='Analyse des performances et statistiques des chauffeurs', table_id='performancesSection') %}

        <!-- Filtres de période -->
        <div class="table-filters" style="margin-bottom: 25px;">
            <div class="filter-group">
                <label class="filter-label">
                    <i class="fas fa-calendar-alt"></i>
                    Période d'analyse
                </label>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-periode="jour" onclick="changePerformancePeriod('jour', this)">
                        <i class="fas fa-calendar-day"></i>
                        Aujourd'hui
                    </button>
                    <button class="filter-btn" data-periode="semaine" onclick="changePerformancePeriod('semaine', this)">
                        <i class="fas fa-calendar-week"></i>
                        Cette semaine
                    </button>
                    <button class="filter-btn" data-periode="mois" onclick="changePerformancePeriod('mois', this)">
                        <i class="fas fa-calendar-alt"></i>
                        Ce mois
                    </button>
                </div>
            </div>

            <!-- Filtre personnalisé -->
            <div class="filter-group">
                <label class="filter-label">
                    <i class="fas fa-calendar-range"></i>
                    Période personnalisée
                </label>
                <div class="date-range-inputs">
                    <div class="date-input-group">
                        <label for="perf_date_debut">Du :</label>
                        <input type="date" id="perf_date_debut" class="date-input">
                    </div>
                    <div class="date-input-group">
                        <label for="perf_date_fin">Au :</label>
                        <input type="date" id="perf_date_fin" class="date-input">
                    </div>
                    <button class="table-btn action" onclick="applyCustomPerformanceFilter()">
                        <i class="fas fa-search"></i>
                        Filtrer
                    </button>
                </div>
            </div>
        </div>

        <!-- Graphique des performances -->
        <div class="chart-container-modern">
            <div class="chart-header-modern">
                <div class="chart-title">
                    <i class="fas fa-chart-bar"></i>
                    <h4>Nombre de trajets par chauffeur</h4>
                </div>
                <div class="chart-info">
                    <span class="period-badge" id="performance-period-label">Aujourd'hui</span>
                </div>
            </div>
            <div class="chart-body">
                <div class="chart-canvas-wrapper" style="height: 400px; position: relative;">
                    <div id="chart-placeholder" class="chart-placeholder">
                        <div class="placeholder-content">
                            <i class="fas fa-chart-bar"></i>
                            <h5>Graphique des performances</h5>
                            <p>Chargement des données en cours...</p>
                            <button onclick="testGraphique()" class="table-btn secondary">
                                <i class="fas fa-play"></i>
                                Test Graphique
                            </button>
                        </div>
                    </div>
                    <canvas id="performanceChart" style="display: none;"></canvas>
                </div>
            </div>
            <div class="chart-footer">
                <div class="chart-legend">
                    <i class="fas fa-info-circle"></i>
                    <span>Affichage du nombre de trajets effectués par chaque chauffeur de bus AED</span>
                </div>
            </div>
        </div>
    {% endcall %}

    <!-- Section Utilisation des Bus UdM -->
    {% call table_container('Utilisation des Bus UdM', 'chart-pie', search=false, subtitle='Analyse de l\'utilisation et répartition des trajets par bus', table_id='busUsageSection') %}

        <!-- Filtres de période -->
        <div class="table-filters" style="margin-bottom: 25px;">
            <div class="filter-group">
                <label class="filter-label">
                    <i class="fas fa-calendar-alt"></i>
                    Période d'analyse
                </label>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-periode="jour" onclick="changeBusUsagePeriod('jour', this)">
                        <i class="fas fa-calendar-day"></i>
                        Aujourd'hui
                    </button>
                    <button class="filter-btn" data-periode="semaine" onclick="changeBusUsagePeriod('semaine', this)">
                        <i class="fas fa-calendar-week"></i>
                        Cette semaine
                    </button>
                    <button class="filter-btn" data-periode="mois" onclick="changeBusUsagePeriod('mois', this)">
                        <i class="fas fa-calendar-alt"></i>
                        Ce mois
                    </button>
                </div>
            </div>

            <!-- Filtre personnalisé -->
            <div class="filter-group">
                <label class="filter-label">
                    <i class="fas fa-calendar-range"></i>
                    Période personnalisée
                </label>
                <div class="date-range-inputs">
                    <div class="date-input-group">
                        <label for="bus_date_debut">Du :</label>
                        <input type="date" id="bus_date_debut" class="date-input">
                    </div>
                    <div class="date-input-group">
                        <label for="bus_date_fin">Au :</label>
                        <input type="date" id="bus_date_fin" class="date-input">
                    </div>
                    <button class="table-btn action" onclick="applyCustomBusUsageFilter()">
                        <i class="fas fa-search"></i>
                        Filtrer
                    </button>
                </div>
            </div>
        </div>

        <!-- Graphique d'utilisation des bus -->
        <div class="chart-container-modern">
            <div class="chart-header-modern">
                <div class="chart-title">
                    <i class="fas fa-chart-pie"></i>
                    <h4>Répartition de l'utilisation par bus</h4>
                </div>
                <div class="chart-info">
                    <span class="period-badge" id="bus-usage-period-label">Aujourd'hui</span>
                </div>
            </div>
            <div class="chart-body">
                <div class="chart-canvas-wrapper" style="height: 400px; position: relative;">
                    <div id="bus-chart-placeholder" class="chart-placeholder">
                        <div class="placeholder-content">
                            <i class="fas fa-chart-pie"></i>
                            <h5>Graphique d'utilisation des bus</h5>
                            <p>Chargement des données en cours...</p>
                            <button onclick="testBusUsageChart()" class="table-btn secondary">
                                <i class="fas fa-play"></i>
                                Test Graphique Bus
                            </button>
                        </div>
                    </div>
                    <canvas id="busUsageChart" style="display: none;"></canvas>
                </div>
            </div>
            <div class="chart-footer">
                <div class="chart-legend">
                    <i class="fas fa-info-circle"></i>
                    <span>Affichage du nombre de trajets effectués par chaque bus UdM</span>
                </div>
            </div>
        </div>
    {% endcall %}





</div>
{% endmacro %}

{# Render the body into both possible base blocks #}
{% block dashboard_content %}{{ rapports_body() }}{% endblock %}
{% block superviseur_content %}{{ rapports_body() }}{% endblock %}
{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Variables globales pour les graphiques
let performanceChart = null;
let busUsageChart = null;

// Fonctions pour changer de période
function changePerformancePeriod(periode, button) {
    // Retirer la classe active des autres boutons de performance
    button.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));

    // Ajouter la classe active au bouton cliqué
    button.classList.add('active');

    // Charger les nouvelles données
    loadPerformanceData(periode);
}

function applyCustomPerformanceFilter() {
    const dateDebut = document.getElementById('perf_date_debut').value;
    const dateFin = document.getElementById('perf_date_fin').value;

    if (dateDebut && dateFin) {
        // Retirer la classe active des boutons de filtre rapide de performance
        document.querySelector('#performancesSection .filter-buttons').querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));

        // Charger les données pour la période personnalisée
        loadPerformanceData('personnalise', dateDebut, dateFin);
    } else {
        alert('Veuillez sélectionner une date de début et une date de fin.');
    }
}

// Charger les données de performance
function loadPerformanceData(periode, dateDebut = null, dateFin = null) {
    const baseUrl = "{{ url_for('admin.api_performances_chauffeurs') }}";
    let url = `${baseUrl}?periode=${periode}`;
    
    if (dateDebut && dateFin) {
        url += `&date_debut=${dateDebut}&date_fin=${dateFin}`;
    }
    
    console.log('Chargement des données depuis:', url);
    
    fetch(url)
        .then(response => {
            console.log('Réponse reçue:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Données reçues:', data);

            if (!performanceChart) {
                console.error('Le graphique n\'est pas initialisé');
                return;
            }

            // Mettre à jour le graphique de manière défensive
            const labels = Array.isArray(data?.labels) ? data.labels : [];
            const ds = (data && data.datasets && Array.isArray(data.datasets) && data.datasets[0]) ? data.datasets[0] : { data: [], backgroundColor: [], borderColor: [] };

            performanceChart.data.labels = labels;
            performanceChart.data.datasets[0].data = Array.isArray(ds.data) ? ds.data : [];
            performanceChart.data.datasets[0].backgroundColor = Array.isArray(ds.backgroundColor) ? ds.backgroundColor : [];
            performanceChart.data.datasets[0].borderColor = Array.isArray(ds.borderColor) ? ds.borderColor : [];
            performanceChart.update();

            console.log('Graphique mis à jour avec', data.labels ? data.labels.length : 0, 'chauffeurs');
            
            // Mettre à jour le label de période
            const periodLabel = document.getElementById('performance-period-label');
            if (dateDebut && dateFin) {
                periodLabel.textContent = `Du ${data.periode_info.start_date} au ${data.periode_info.end_date}`;
            } else {
                const labels = {
                    'jour': 'Aujourd\'hui',
                    'semaine': 'Cette semaine',
                    'mois': 'Ce mois'
                };
                periodLabel.textContent = labels[periode] || 'Période personnalisée';
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des données:', error);
            
            // Afficher un message d'erreur dans le graphique
            if (performanceChart) {
                performanceChart.data.labels = ['Aucune donnée'];
                performanceChart.data.datasets[0].data = [0];
                performanceChart.data.datasets[0].backgroundColor = ['#dc3545'];
                performanceChart.data.datasets[0].borderColor = ['#dc3545'];
                performanceChart.update();
            }
        });
}

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initialisation des performances chauffeurs...');
    
    // Vérifier Chart.js
    if (typeof Chart === 'undefined') {
        console.error('Chart.js non chargé');
        return;
    }
    
    // Initialiser les graphiques immédiatement
    initPerformanceChart();
    initBusUsageChart();
});

// Initialiser le graphique des performances
function initPerformanceChart() {
    const canvas = document.getElementById('performanceChart');
    const placeholder = document.getElementById('chart-placeholder');
    
    if (!canvas) {
        console.error('Canvas performanceChart non trouvé');
        return;
    }
    
    // Masquer le placeholder et afficher le canvas
    if (placeholder) {
        placeholder.style.display = 'none';
    }
    canvas.style.display = 'block';
    
    const ctx = canvas.getContext('2d');
    
    performanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Chargement...'],
            datasets: [{
                label: 'Nombre de trajets',
                data: [0],
                backgroundColor: ['#28a745'],
                borderColor: ['#28a745'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return 'Chauffeur: ' + context[0].label;
                        },
                        label: function(context) {
                            return 'Trajets effectués: ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nombre de trajets'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Chauffeurs'
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
    
    console.log('Graphique créé, chargement des données...');
    
    // Charger les données initiales
    setTimeout(() => {
        loadPerformanceData('jour');
    }, 1000);
}

// Fonction de test pour remplir le graphique avec des données factices
function testGraphique() {
    if (!performanceChart) {
        alert('Graphique non initialisé');
        return;
    }
    const labels = ['Chauffeur A', 'Chauffeur B', 'Chauffeur C', 'Chauffeur D'];
    const data = [5, 8, 2, 10];
    const colors = data.map(v => v >= 10 ? '#28a745' : v >= 5 ? '#34ce57' : v >= 2 ? '#ffc107' : '#dc3545');

    performanceChart.data.labels = labels;
    performanceChart.data.datasets[0].data = data;
    performanceChart.data.datasets[0].backgroundColor = colors;
    performanceChart.data.datasets[0].borderColor = colors;
    performanceChart.update();

    const periodLabel = document.getElementById('performance-period-label');
    if (periodLabel) {
        periodLabel.textContent = 'Données de test';
    }
}

// Fonctions pour le graphique d'utilisation des bus
function changeBusUsagePeriod(periode, button) {
    // Retirer la classe active des autres boutons de bus usage
    button.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));

    // Ajouter la classe active au bouton cliqué
    button.classList.add('active');

    // Charger les nouvelles données
    loadBusUsageData(periode);
}

function applyCustomBusUsageFilter() {
    const dateDebut = document.getElementById('bus_date_debut').value;
    const dateFin = document.getElementById('bus_date_fin').value;

    if (dateDebut && dateFin) {
        // Retirer la classe active des boutons de filtre rapide de bus usage
        document.querySelector('#busUsageSection .filter-buttons').querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));

        // Charger les données pour la période personnalisée
        loadBusUsageData('personnalise', dateDebut, dateFin);
    } else {
        alert('Veuillez sélectionner une date de début et une date de fin.');
    }
}

// Charger les données d'utilisation des bus
function loadBusUsageData(periode, dateDebut = null, dateFin = null) {
    const baseUrl = "{{ url_for('admin.api_bus_usage') }}";
    let url = `${baseUrl}?periode=${periode}`;
    
    if (dateDebut && dateFin) {
        url += `&date_debut=${dateDebut}&date_fin=${dateFin}`;
    }
    
    console.log('Chargement des données bus depuis:', url);
    
    fetch(url)
        .then(response => {
            console.log('Réponse bus reçue:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Données bus reçues:', data);

            if (!busUsageChart) {
                console.error('Le graphique bus n\'est pas initialisé');
                return;
            }

            // Mettre à jour le graphique circulaire de manière défensive
            const labels = Array.isArray(data?.labels) ? data.labels : [];
            const ds = (data && data.datasets && Array.isArray(data.datasets) && data.datasets[0]) ? data.datasets[0] : { data: [], backgroundColor: [], borderColor: [] };

            busUsageChart.data.labels = labels;
            busUsageChart.data.datasets[0].data = Array.isArray(ds.data) ? ds.data : [];
            busUsageChart.data.datasets[0].backgroundColor = Array.isArray(ds.backgroundColor) ? ds.backgroundColor : [];
            busUsageChart.data.datasets[0].borderColor = Array.isArray(ds.borderColor) ? ds.borderColor : [];
            busUsageChart.update();

            console.log('Graphique bus mis à jour avec', data.labels ? data.labels.length : 0, 'bus');
            
            // Mettre à jour le label de période
            const periodLabel = document.getElementById('bus-usage-period-label');
            if (dateDebut && dateFin) {
                periodLabel.textContent = `Du ${data.periode_info.start_date} au ${data.periode_info.end_date}`;
            } else {
                const labels = {
                    'jour': 'Aujourd\'hui',
                    'semaine': 'Cette semaine',
                    'mois': 'Ce mois'
                };
                periodLabel.textContent = labels[periode] || 'Période personnalisée';
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des données bus:', error);
            
            // Afficher un message d'erreur dans le graphique
            if (busUsageChart) {
                busUsageChart.data.labels = ['Aucune donnée'];
                busUsageChart.data.datasets[0].data = [1];
                busUsageChart.data.datasets[0].backgroundColor = ['#dc3545'];
                busUsageChart.data.datasets[0].borderColor = ['#dc3545'];
                busUsageChart.update();
            }
        });
}

// Initialiser le graphique d'utilisation des bus
function initBusUsageChart() {
    const canvas = document.getElementById('busUsageChart');
    const placeholder = document.getElementById('bus-chart-placeholder');
    
    if (!canvas) {
        console.error('Canvas busUsageChart non trouvé');
        return;
    }
    
    // Masquer le placeholder et afficher le canvas
    if (placeholder) {
        placeholder.style.display = 'none';
    }
    canvas.style.display = 'block';
    
    const ctx = canvas.getContext('2d');
    
    busUsageChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Chargement...'],
            datasets: [{
                label: 'Nombre de trajets',
                data: [1],
                backgroundColor: ['#28a745'],
                borderColor: ['#ffffff'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'right'
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return 'Bus: ' + context[0].label;
                        },
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `Trajets: ${context.parsed} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    console.log('Graphique bus créé, chargement des données...');
    
    // Charger les données initiales
    setTimeout(() => {
        loadBusUsageData('jour');
    }, 1000);
}

// Fonction de test pour remplir le graphique bus avec des données factices
function testBusUsageChart() {
    if (!busUsageChart) {
        alert('Graphique bus non initialisé');
        return;
    }
    const labels = ['Bus 001', 'Bus 002', 'Bus 003', 'Bus 004', 'Bus 005'];
    const data = [15, 8, 12, 5, 20];
    const colors = ['#28a745', '#17a2b8', '#ffc107', '#fd7e14', '#6f42c1'];

    busUsageChart.data.labels = labels;
    busUsageChart.data.datasets[0].data = data;
    busUsageChart.data.datasets[0].backgroundColor = colors;
    busUsageChart.data.datasets[0].borderColor = colors.map(() => '#ffffff');
    busUsageChart.update();

    const periodLabel = document.getElementById('bus-usage-period-label');
    if (periodLabel) {
        periodLabel.textContent = 'Données de test';
    }
}
</script>
<script src="{{ url_for('static', filename='js/rapports.js') }}"></script>
{% endblock %}