{% if base_template is defined %}
{% extends base_template %}
{% elif superviseur_mode %}
{% extends "roles/superviseur/_base_superviseur.html" %}
{% elif readonly %}
{% extends "roles/chauffeur/_base_chauffeur.html" %}
{% elif current_user.role == 'MECANICIEN' %}
{% extends "roles/mecanicien/_base_mecanicien.html" %}
{% else %}
{% extends "roles/admin/_base_admin.html" %}
{% endif %}
{% from 'shared/macros/tableaux_components.html' import table_container, status_badge, level_indicator, voyant_indicator, icon_cell, date_cell, money_cell, number_cell %}

{% block title %}Carburation{% endblock %}

{% set active_page = 'carburation' %}
{% set page_title = 'Gestion de la Carburation' %}
{% set readonly = readonly or superviseur_mode %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tableaux.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/form-errors.css') }}">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
/* Styles de base pour les modales */
.modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
}
.modal.show {
    display: flex;
}
</style>
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
    <!-- Tableau des bus pour carburation -->
    {% call table_container('Gestion de la Carburation', 'gas-pump', search=true, subtitle='Suivi du carburant et ravitaillement des véhicules', table_id='carburationTable') %}
        <table class="table table-striped table-hover sortable">
            <thead>
                <tr>
                    <th>Numéro AED</th>
                    <th>Kilométrage</th>
                    <th>État Réservoir</th>
                    <th>Autonomie</th>
                    <th>Niveau (L)</th>
                    {% if not readonly %}
                    <th class="no-sort">Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for bus in bus_carburation %}
                <tr>
                    <td>{{ number_cell(bus.numero if bus is mapping else bus['numero']) }}</td>
                    <td>
                        {% set km = bus.kilometrage if bus is mapping else bus['kilometrage'] %}
                        {% if km %}
                            {{ icon_cell('tachometer-alt', "{:,}".format(km) + ' km') }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% set voyant = bus.voyant if bus is mapping else bus['voyant'] %}
                        {% if voyant == 'green' %}
                            {{ voyant_indicator('green', 'Bon') }}
                        {% elif voyant == 'orange' %}
                            {{ voyant_indicator('orange', 'Attention') }}
                        {% else %}
                            {{ voyant_indicator('red', 'Critique') }}
                        {% endif %}
                    </td>
                    <td>
                        {% set km_restant = bus.km_restant_carburant if bus is mapping else bus['km_restant_carburant'] %}
                        {% if km_restant is not none %}
                            {% if km_restant <= 0 %}
                                {{ status_badge('URGENT', 'danger', 'exclamation-triangle') }}
                            {% elif km_restant <= 100 %}
                                {{ status_badge(km_restant|string + ' km', 'warning', 'gas-pump') }}
                            {% else %}
                                {{ status_badge(km_restant|string + ' km', 'success', 'check-circle') }}
                            {% endif %}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% set niveau = bus.niveau_carburant_litres if bus is mapping else bus['niveau_carburant_litres'] %}
                        {% if niveau is not none %}
                            <strong>{{ niveau }} L</strong>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    {% if not readonly %}
                    <td>
                        <div class="table-actions">
                            <button class="table-btn action btn-carburation-direct"
                                    data-aed-id="{{ bus.id if bus is mapping else bus['id'] }}"
                                    data-numero="{{ (bus.numero if bus is mapping else bus['numero'])|e }}"
                                    data-immatriculation="{{ (bus.immatriculation if bus is mapping else bus['immatriculation'])|default('', true)|e }}"
                                    data-effectue-par="{{ (((current_user.nom ~ ' ' ~ current_user.prenom)|trim) or current_user.login)|e }}"
                                    title="Effectuer Carburation">
                                <i class="fas fa-gas-pump"></i>
                                Carburer
                            </button>
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% else %}
                <tr>
                    <td colspan="{% if readonly %}5{% else %}6{% endif %}" class="table-empty">
                        <i class="fas fa-gas-pump"></i>
                        <h5>Aucun bus AED enregistré</h5>
                        <p>Les véhicules AED apparaîtront ici pour la gestion du carburant.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endcall %}

    <!-- Historique des carburations -->
    <div style="margin-top: 40px;">
        {% call table_container('Historique des Carburations', 'history', search=false, subtitle='Historique complet des carburations effectuées', table_id='historiqueCarbuTable') %}
            <!-- Filtres -->
            <div class="table-filters" style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 10px;">
                <div style="display:flex;gap:15px;align-items:center;flex-wrap:wrap;">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <label for="carb_numero_select" style="font-weight:500;"><i class="fas fa-bus"></i> Véhicule :</label>
                        <select id="carb_numero_select" onchange="filterHistorique(this.value)"
                                style="padding:8px 12px;border:2px solid #e5e7eb;border-radius:8px;background:white;">
                            <option value="">Tous les véhicules</option>
                            {% for numero in numeros_aed %}
                            <option value="{{ numero }}" {% if selected_numero == numero %}selected{% endif %}>
                                AED-{{ numero }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <label style="font-weight:500;"><i class="fas fa-calendar"></i> Période :</label>
                        <input type="date" id="carb_date_debut" value="{{ selected_date_debut or '' }}"
                               onchange="filterHistorique(document.getElementById('carb_numero_select').value)"
                               style="padding:8px;border:2px solid #e5e7eb;border-radius:8px;" />
                        <span style="color:#6b7280;">au</span>
                        <input type="date" id="carb_date_fin" value="{{ selected_date_fin or '' }}"
                               onchange="filterHistorique(document.getElementById('carb_numero_select').value)"
                               style="padding:8px;border:2px solid #e5e7eb;border-radius:8px;" />
                    </div>
                    <button type="button" title="Effacer filtres" onclick="clearHistoriqueFilters()"
                            class="table-btn delete" style="margin-left:10px;">
                        <i class="fas fa-times"></i>
                    </button>
                    <span id="carb_loader" style="display:none;align-items:center;gap:6px;color:#6b7280;">
                        <i class="fas fa-spinner fa-spin"></i> Chargement...
                    </span>
                </div>
            </div>

            <!-- Tableau historique -->
            <div style="max-height: 400px; overflow-y: auto;">
                <table class="table table-striped table-hover">
                    <thead style="position: sticky; top: 0; z-index: 10;">
                        <tr>
                            <th>Date</th>
                            <th>Véhicule</th>
                            <th>Kilométrage</th>
                            <th>Quantité</th>
                            <th>Prix Unitaire</th>
                            <th>Coût Total</th>
                            <th>Remarque</th>
                        </tr>
                    </thead>
                    <tbody id="historique-carb-body">
                        {% for carburation in historique_carburation %}
                        <tr>
                            <td>{{ date_cell(carburation.date_carburation) }}</td>
                            <td>{{ number_cell(carburation.bus_udm.numero, 'AED-') }}</td>
                            <td>{{ icon_cell('tachometer-alt', "{:,}".format(carburation.kilometrage) + ' km') }}</td>
                            <td>{{ icon_cell('gas-pump', carburation.quantite_litres|string + ' L') }}</td>
                            <td>{{ money_cell(carburation.prix_unitaire, 'FCFA/L') }}</td>
                            <td>{{ money_cell(carburation.cout_total, 'FCFA') }}</td>
                            <td>
                                {% if carburation.remarque %}
                                    <span class="text-muted">{{ carburation.remarque }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="table-empty">
                                <i class="fas fa-history"></i>
                                <h5>Aucune carburation enregistrée</h5>
                                <p>L'historique des carburations apparaîtra ici.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endcall %}
    </div>
</div>

{# --- Modale --- #}
<!-- Formulaire de confirmation carburation -->
{% from 'shared/macros/form_macros.html' import error_container %}

<div id="formulaireCarburationModal" class="modal">
  <div class="modal-content">
    <button type="button" id="closeFormulaireCarburationModal" class="close-btn"><i class="fas fa-times"></i></button>
    <div class="modal-header">
      <h3><i class="fas fa-gas-pump"></i> Carburation</h3>
    </div>
    <div class="modal-body">
      {{ error_container('carburationError') }}
      <form method="POST" id="formulaire-carburation" class="modal-form">
        <input type="hidden" id="bus_udm_id_hidden" name="bus_udm_id_hidden">
        <div class="form-grid">
          <div class="form-group">
            <label for="numero_bus_udm">Numéro Bus UdM</label>
            <input type="text" id="numero_bus_udm" name="numero_bus_udm" readonly>
          </div>
          <div class="form-group">
            <label for="kilometrage_input">Kilométrage</label>
            <input type="number" id="kilometrage_input" name="kilometrage_input" min="0" required>
          </div>
          <div class="form-group">
            <label for="quantite_input">Quantité (L)</label>
            <input type="number" id="quantite_input" name="quantite_input" step="0.1" min="0" required>
          </div>
          <div class="form-group">
            <label for="prix_unitaire_input">Prix unitaire (FCFA/L)</label>
            <input type="number" id="prix_unitaire_input" name="prix_unitaire_input" step="0.01" min="0" required>
          </div>
          <div class="form-group">
            <label for="cout_total_input">Coût total (FCFA)</label>
            <input type="number" id="cout_total_input" name="cout_total_input" readonly>
          </div>
          <div class="form-group">
            <label for="chauffeur_select">Chauffeur</label>
            <select id="chauffeur_select" name="chauffeur_select" required>
              <option value="">-- Sélectionner un chauffeur --</option>
              {% for chauffeur in chauffeurs %}
              <option value="{{ chauffeur.chauffeur_id }}">{{ chauffeur.nom }} {{ chauffeur.prenom }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="superviseur_input">Superviseur</label>
            <input type="text" id="superviseur_input" name="superviseur_input" readonly value="{{ (current_user.nom ~ ' ' ~ current_user.prenom)|trim or current_user.login }}">
            <input type="hidden" id="superviseur_id" name="superviseur_id" value="{{ current_user.utilisateur_id }}">
          </div>
          <div class="form-group full-width">
            <label for="remarque_input">Remarque (optionnel)</label>
            <textarea id="remarque_input" name="remarque_input" rows="3"></textarea>
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" class="submit-btn">
            <i class="fas fa-save"></i> Confirmer la carburation
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal carburation avec gestion spécifique -->
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Ouvrir directement le formulaire de carburation
    document.querySelectorAll('.btn-carburation-direct').forEach(btn => {
        btn.addEventListener('click', function() {
            const aedId = this.getAttribute('data-aed-id');
            const numero = this.getAttribute('data-numero');
            const immat = this.getAttribute('data-immatriculation');
            const operateur = this.getAttribute('data-effectue-par');

            // Remplir directement le formulaire
            document.getElementById('bus_udm_id_hidden').value = aedId || '';
            document.getElementById('numero_bus_udm').value = numero || '';

            openFormulaireCarburation();
        });
    });

    // Auto-calcul du coût total
    const recalcCout = () => {
        const q = parseFloat(document.getElementById('quantite_input').value || '0');
        const p = parseFloat(document.getElementById('prix_unitaire_input').value || '0');
        const total = (isNaN(q) ? 0 : q) * (isNaN(p) ? 0 : p);
        document.getElementById('cout_total_input').value = total ? total.toFixed(2) : '';
    };
    ['quantite_input','prix_unitaire_input'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', recalcCout);
    });

    // Soumission du formulaire de confirmation
    const form = document.getElementById('formulaire-carburation');
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const aed_id = document.getElementById('bus_udm_id_hidden').value;
        if (!aed_id) {
            alert("Erreur : aucun véhicule sélectionné. Veuillez ouvrir la fiche avant de confirmer.");
            return;
        }
        const data = {
            bus_udm_id: aed_id,
            kilometrage: document.getElementById('kilometrage_input').value,
            quantite_litres: document.getElementById('quantite_input').value,
            prix_unitaire: document.getElementById('prix_unitaire_input').value,
            cout_total: document.getElementById('cout_total_input').value,
            chauffeur_id: document.getElementById('chauffeur_select').value,
            superviseur_id: document.getElementById('superviseur_id').value,
            remarque: document.getElementById('remarque_input').value
        };

        fetch('{{ post_url }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // MAJ de la ligne correspondante
                if (data.bus_updated) updateBusRow(data.bus_updated);
                closeFormulaireCarburation();

                // Confirmation avec SweetAlert2
                Swal.fire({
                    title: 'Succès!',
                    text: 'Carburation enregistrée avec succès.',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });

                // Rafraîchir l'historique sans recharger la page
                if (typeof filterHistoriqueCarburation === 'function') {
                    filterHistoriqueCarburation();
                }
            } else {
                // Afficher l'erreur dans le formulaire
                showCarburationError(data.message || 'Erreur lors de l\'enregistrement');
            }
        })
        .catch(() => {
            showCarburationError('Erreur de connexion au serveur.');
        });
    });

    // Gestionnaire pour le bouton de fermeture
    document.getElementById('closeFormulaireCarburationModal').addEventListener('click', closeFormulaireCarburation);

    // Fermer la modal en cliquant en dehors
    document.getElementById('formulaireCarburationModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeFormulaireCarburation();
        }
    });
});

// Fonctions d'ouverture/fermeture de la modal carburation
function openFormulaireCarburation() {
    const modal = document.getElementById('formulaireCarburationModal');
    if (modal) {
        modal.classList.add('show');
        // Effacer les erreurs précédentes
        hideCarburationError();
    }
}

function closeFormulaireCarburation() {
    const modal = document.getElementById('formulaireCarburationModal');
    if (modal) {
        modal.classList.remove('show');
        // Réinitialiser le formulaire
        document.getElementById('formulaire-carburation').reset();
        hideCarburationError();
    }
}

function showCarburationError(message) {
    const errorDiv = document.getElementById('carburationError');
    if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }
}

function hideCarburationError() {
    const errorDiv = document.getElementById('carburationError');
    if (errorDiv) {
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
    }
}

function printCarburationFiche() {
    const fiche = document.getElementById('fiche-carburation-content');
    if (!fiche) return;
    const w = window.open('', '_blank', 'width=800,height=600');
    const styles = `
        <style>
            body{font-family: Arial, sans-serif; padding: 20px;}
            .signature-line{border-top:1px solid #000; width:220px; height:40px; margin-top:6px;}
            h2{margin:0 0 12px 0;}
            .meta div{margin-bottom:8px;}
        </style>
    `;
    const header = '<h2>Fiche de Carburation</h2>';
    w.document.write(`<!doctype html><html><head><meta charset="utf-8">${styles}</head><body>${header}${fiche.innerHTML}</body></html>`);
    w.document.close();
    w.focus();
    w.print();
    w.close();
}

function updateBusRow(bus) {
    // Mise à jour similaire à vidange.html mais pour les colonnes carburation
    const rows = document.querySelectorAll('.vidange-table tbody tr');
    rows.forEach(row => {
        const numeroCell = row.querySelector('td:first-child strong');
        if (numeroCell && numeroCell.textContent === bus.numero) {
            const cells = row.querySelectorAll('td');
            // Colonne 2 (index 1): Kilométrage Actuel
            if (cells[1]) cells[1].textContent = (bus.kilometrage ?? '-') + ' km';
            // Colonne 3 (index 2): État Réservoir (voyant)
            if (cells[2]) {
                const spanVoyant = cells[2].querySelector('.voyant-indicator');
                if (spanVoyant) {
                    spanVoyant.className = 'voyant-indicator voyant-' + (bus.voyant || 'green');
                }
                const textNode = cells[2].childNodes[1];
                if (textNode) {
                    if (bus.voyant === 'green') textNode.textContent = 'Bon';
                    else if (bus.voyant === 'orange') textNode.textContent = 'Attention';
                    else textNode.textContent = 'Critique';
                }
            }
            // Colonne 4 (index 3): Km Restant
            if (cells[3]) {
                const v = bus.km_restant_carburant;
                if (v === null || v === undefined) {
                    cells[3].innerHTML = '<span style="color:#94a3b8;">-</span>';
                } else if (v <= 0) {
                    cells[3].innerHTML = '<span class="status-badge status-critical">URGENT</span>';
                } else if (v <= 100) {
                    cells[3].innerHTML = '<span class="status-badge status-warning">' + v + ' km</span>';
                } else {
                    cells[3].innerHTML = '<span class="status-badge status-ok">' + v + ' km</span>';
                }
            }
            // Colonne 5 (index 4): Niveau carburant (L)
            if (cells[4]) {
                const n = bus.niveau_carburant_litres;
                if (n === null || n === undefined) {
                    cells[4].textContent = '-';
                } else {
                    cells[4].textContent = n + ' L';
                }
            }
        }
    });
}
</script>

{% endblock %}