{% if base_template is defined %}
    {% extends base_template %}
{% elif superviseur_mode is defined and superviseur_mode %}
    {% extends "roles/superviseur/_base_superviseur.html" %}
{% elif current_user and current_user.is_authenticated %}
    {% if current_user.role == 'ADMIN' or current_user.role == 'RESPONSABLE' %}
        {% extends "roles/admin/_base_admin.html" %}
    {% elif current_user.role == 'CHARGE' %}
        {% extends "roles/charge_transport/_base_charge.html" %}
    {% elif current_user.role == 'SUPERVISEUR' %}
        {% extends "roles/superviseur/_base_superviseur.html" %}
    {% elif current_user.role == 'MECANICIEN' %}
        {% extends "roles/mecanicien/_base_mecanicien.html" %}
    {% elif current_user.role == 'CHAUFFEUR' %}
        {% extends "roles/chauffeur/_base_chauffeur.html" %}
    {% else %}
        {% extends "roles/admin/_base_admin.html" %}
    {% endif %}
{% else %}
    {% extends "roles/admin/_base_admin.html" %}
{% endif %}
{% from 'shared/macros/tableaux_components.html' import table_container, status_badge, icon_cell, date_cell, number_cell %}

{% block title %}Chauffeurs{% endblock %}

{% set active_page = 'chauffeurs' %}
{% set page_title = 'Liste des Chauffeurs' %}
{% set readonly = readonly or superviseur_mode %}

{% block extra_head %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tableaux.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/print-header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chauffeurs.css') }}">
    <script src="{{ url_for('static', filename='js/tableaux.js') }}"></script>
    <script src="{{ url_for('static', filename='js/print-header.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chauffeurs_print.js') }}"></script>

{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
    <!-- En-tête du tableau avec bouton d'ajout -->
    <div class="table-container" id="chauffeursTable">
        <div class="table-header">
            <div class="d-flex justify-content-between align-items-center w-100">
                <div>
                    <h3 class="table-title">
                        <i class="fas fa-user-tie"></i>
                        Liste des Chauffeurs
                    </h3>
                    <p class="table-subtitle">Gestion du personnel de conduite</p>
                </div>
            </div>
        </div>

        <div class="table-search">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="form-control search-input" placeholder="Rechercher un chauffeur..." id="searchInput">
            </div>
        </div>
        <table class="table table-striped table-hover sortable">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Prénom</th>
                    <th>Permis</th>
                    <th>Contact</th>
                    <th>Statut</th>
                    <th>Lieu</th>
                    {% if not readonly and current_user.role != 'CHARGE' %}
                    <th class="no-sort">Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for chauffeur in chauffeur_list %}
                <tr data-chauffeur-id="{{ chauffeur.chauffeur_id }}">
                    <td><strong>{{ chauffeur.nom }}</strong></td>
                    <td>{{ chauffeur.prenom }}</td>
                    <td>
                        {% if chauffeur.numero_permis %}
                            {{ icon_cell('id-card', chauffeur.numero_permis) }}
                        {% else %}
                            <span class="text-muted">Non défini</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if chauffeur.telephone %}
                            {{ icon_cell('phone', chauffeur.telephone) }}
                        {% else %}
                            <span class="text-muted">Non défini</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if chauffeur.statuts_actuels %}
                            {% for statut in chauffeur.statuts_actuels %}
                                <span class="statut-clickable"
                                      data-chauffeur-id="{{ chauffeur.chauffeur_id }}"
                                      data-chauffeur-nom="{{ chauffeur.nom }}"
                                      data-chauffeur-prenom="{{ chauffeur.prenom }}"
                                      data-statut-id="{{ statut.id }}"
                                      data-statut="{{ statut.statut }}"
                                      data-date-debut="{{ statut.date_debut.strftime('%Y-%m-%d') if statut.date_debut else '' }}"
                                      data-date-fin="{{ statut.date_fin.strftime('%Y-%m-%d') if statut.date_fin else '' }}"
                                      style="cursor: pointer;"
                                      title="Cliquez pour voir les détails">
                                    {% if statut.statut == 'CONGE' %}
                                        {{ status_badge('Congé', 'warning', 'calendar-times') }}
                                    {% elif statut.statut == 'PERMANENCE' %}
                                        {{ status_badge('Permanence', 'info', 'clock') }}
                                    {% elif statut.statut == 'SERVICE_WEEKEND' %}
                                        {{ status_badge('Week-end', 'secondary', 'calendar-week') }}
                                    {% elif statut.statut == 'SERVICE_SEMAINE' %}
                                        {{ status_badge('Semaine', 'primary', 'calendar-day') }}
                                    {% else %}
                                        {{ status_badge(statut.statut, 'secondary') }}
                                    {% endif %}
                                </span>
                            {% endfor %}
                        {% else %}
                            <span class="statut-clickable"
                                  data-chauffeur-id="{{ chauffeur.chauffeur_id }}"
                                  data-chauffeur-nom="{{ chauffeur.nom }}"
                                  data-chauffeur-prenom="{{ chauffeur.prenom }}"
                                  style="cursor: pointer;"
                                  title="Cliquez pour voir les détails">
                                {{ status_badge('Attente', 'secondary', 'question-circle') }}
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if chauffeur.statuts_actuels %}
                            {% for statut in chauffeur.statuts_actuels %}
                                {% if statut.lieu %}
                                    {% if statut.lieu == 'CUM' %}
                                        {{ icon_cell('building', 'CUM') }}
                                    {% elif statut.lieu == 'CAMPUS' %}
                                        {{ icon_cell('university', 'Campus') }}
                                    {% elif statut.lieu == 'CONJOINTEMENT' %}
                                        <span>Conjointement</span>
                                    {% else %}
                                        <span class="text-muted">{{ statut.lieu }}</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">Attente</span>
                                {% endif %}
                                {% if not loop.last %}<br>{% endif %}
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">Attente</span>
                        {% endif %}
                    </td>
                    {% if not readonly and current_user.role != 'CHARGE' %}
                    <td>
                        <div class="table-actions">
                            <button class="table-btn edit edit-statut-btn"
                                    data-id="{{ chauffeur.chauffeur_id }}"
                                    data-nom="{{ chauffeur.nom }}"
                                    data-prenom="{{ chauffeur.prenom }}"
                                    title="Modifier le statut">
                                <i class="fas fa-calendar-alt"></i>
                            </button>
                            <button class="table-btn delete delete-chauffeur-btn"
                                    data-id="{{ chauffeur.chauffeur_id }}"
                                    title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% else %}
                <tr>
                    <td colspan="{% if readonly or current_user.role == 'CHARGE' %}6{% else %}7{% endif %}" class="table-empty">
                        <i class="fas fa-user-tie"></i>
                        <h5>Aucun chauffeur enregistré</h5>
                        {% if not readonly %}
                        <p>Cliquez sur le bouton + pour ajouter votre premier chauffeur.</p>
                        {% else %}
                        <p>Aucun chauffeur n'est actuellement enregistré dans le système.</p>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Boutons d'impression parfaitement centrés -->
    <div class="row mt-4 mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-center align-items-center" style="width: 100%; text-align: center;">
                <div class="d-flex gap-3">
                    <button id="printChauffeursList" class="btn btn-outline-primary d-flex align-items-center gap-2">
                        <i class="fas fa-print"></i>
                        <span>Imprimer la liste des chauffeurs</span>
                    </button>
                    <button id="printChauffeursPlanning" class="btn btn-outline-success d-flex align-items-center gap-2">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Imprimer la planification des chauffeurs</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Zone d'impression cachée pour la liste des chauffeurs -->
<div id="printListeArea" class="d-none">
    <div class="print-header">
        <h1>Liste des Chauffeurs</h1>
        <p>Transport UdM - Imprimé le <span id="printDate"></span></p>
    </div>
    <table class="print-table">
        <thead>
            <tr>
                <th>Nom</th>
                <th>Prénom</th>
                <th>Numéro de Permis</th>
                <th>Contact</th>
            </tr>
        </thead>
        <tbody>
            {% for chauffeur in chauffeur_list %}
            <tr>
                <td>{{ chauffeur.nom or 'Non défini' }}</td>
                <td>{{ chauffeur.prenom or 'Non défini' }}</td>
                <td>{{ chauffeur.numero_permis or 'Non défini' }}</td>
                <td>{{ chauffeur.telephone or 'Non défini' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Zone d'impression cachée pour la planification -->
<div id="printPlanningArea" class="d-none">
    <div class="print-header">
        <h1>Planification des Chauffeurs</h1>
        <p>Transport UdM - Imprimé le <span id="printPlanningDate"></span></p>
    </div>
    <table class="print-table">
        <thead>
            <tr>
                <th>Chauffeur</th>
                <th>Statut</th>
                <th>Date de début</th>
                <th>Date de fin</th>
                <th>Durée</th>
            </tr>
        </thead>
        <tbody id="planningTableBody">
            <!-- Contenu généré dynamiquement -->
        </tbody>
    </table>
</div>

<!-- Inclure la modale de modification de statut -->
{% include 'shared/modals/_edit_statut_chauffeur_modal.html' %}

<!-- Inclure la modale des détails de statut -->
{% include 'shared/modals/_statut_details_modal.html' %}

<!-- Inclure la modale de modification de statut individuel -->
{% include 'shared/modals/_edit_individual_statut_modal.html' %}


{% endblock %}

{% block extra_scripts %}
<script>
// Fonction pour afficher les détails du statut
function showStatutDetails(button) {
  const statut = button.getAttribute('data-statut');
  const dateDebut = button.getAttribute('data-date-debut');
  const dateFin = button.getAttribute('data-date-fin');
  const chauffeurNom = button.getAttribute('data-chauffeur-nom');
  const chauffeurId = button.getAttribute('data-chauffeur-id');

  // Remplir les informations dans la modale
  document.getElementById('detailChauffeurNom').textContent = chauffeurNom;
  document.getElementById('detailDateDebut').textContent = dateDebut;
  document.getElementById('detailDateFin').textContent = dateFin;

  // Définir le texte et le style du statut
  const detailStatutElement = document.getElementById('detailStatut');
  let statutText = '';
  let statutClass = '';

  switch(statut) {
    case 'CONGE':
      statutText = 'Congé';
      statutClass = 'statut-conge';
      break;
    case 'PERMANENCE':
      statutText = 'Permanence';
      statutClass = 'statut-permanence';
      break;
    case 'SERVICE_WEEKEND':
      statutText = 'Service Week-end';
      statutClass = 'statut-service_weekend';
      break;
    case 'SERVICE_SEMAINE':
      statutText = 'Service Semaine';
      statutClass = 'statut-service_semaine';
      break;
  }

  detailStatutElement.textContent = statutText;
  detailStatutElement.className = statutClass;

  // Afficher la modale
  document.getElementById('statutDetailsModal').classList.add('show');

  // Charger autres statuts via AJAX
  const listEl = document.getElementById('autresStatutsList');
  if (listEl) {
    listEl.innerHTML = '<span style="color:#6b7280;">Chargement...</span>';
    fetch(`/admin/get_statuts_chauffeur_ajax/${chauffeurId}`)
      .then(r => r.json())
      .then(data => {
        if (!data || !data.success) {
          listEl.innerHTML = '<span style="color:#ef4444;">Impossible de charger les statuts.</span>';
          return;
        }
        const statuts = data.statuts || [];
        if (statuts.length === 0) {
          listEl.innerHTML = '<span style="color:#6b7280;">Aucun autre statut enregistré.</span>';
          return;
        }
        const container = document.createElement('div');
        container.style.display = 'flex';
        container.style.flexDirection = 'column';
        container.style.gap = '8px';
        statuts.forEach(s => {
          const item = document.createElement('div');
          item.style.padding = '8px 10px';
          item.style.border = '1px solid #e5e7eb';
          item.style.borderRadius = '8px';
          item.style.background = '#ffffff';
          const start = s.date_debut_formatted || s.date_debut;
          const end = s.date_fin_formatted || s.date_fin;
          let label = s.statut;
          if (label === 'CONGE') label = 'Congé';
          else if (label === 'PERMANENCE') label = 'Permanence';
          else if (label === 'SERVICE_WEEKEND') label = 'Service Week-end';
          else if (label === 'SERVICE_SEMAINE') label = 'Service Semaine';
          item.textContent = `${label} — du ${start} au ${end}`;
          container.appendChild(item);
        });
        listEl.innerHTML = '';
        listEl.appendChild(container);
      })
      .catch(() => {
        listEl.innerHTML = '<span style="color:#ef4444;">Erreur lors du chargement.</span>';
      });
  }
}

$(function() {
  // Gestion des clics sur les statuts pour afficher les détails avec délégation d'événements
  $(document).on('click', '.statut-clickable', function(e) {
    e.preventDefault();

    const chauffeurId = $(this).data('chauffeur-id');
    const chauffeurNom = $(this).data('chauffeur-nom');
    const chauffeurPrenom = $(this).data('chauffeur-prenom');
    const statutId = $(this).data('statut-id');
    const statut = $(this).data('statut');
    const dateDebut = $(this).data('date-debut');
    const dateFin = $(this).data('date-fin');

    // Remplir les informations dans la modale
    $('#detailChauffeurNom').text(chauffeurNom + ' ' + chauffeurPrenom).data('chauffeur-id', chauffeurId);

    // Afficher le statut avec le bon style
    const statutBadge = $('#detailStatut');
    statutBadge.removeClass().addClass('status-badge');

    if (statut === 'CONGE') {
      statutBadge.addClass('status-warning').html('<i class="fas fa-calendar-times"></i> Congé');
    } else if (statut === 'PERMANENCE') {
      statutBadge.addClass('status-info').html('<i class="fas fa-clock"></i> Permanence');
    } else if (statut === 'SERVICE_WEEKEND') {
      statutBadge.addClass('status-secondary').html('<i class="fas fa-calendar-week"></i> Week-end');
    } else if (statut === 'SERVICE_SEMAINE') {
      statutBadge.addClass('status-primary').html('<i class="fas fa-calendar-day"></i> Semaine');
    } else if (!statut || statut === 'Disponible') {
      statutBadge.addClass('status-secondary').html('<i class="fas fa-question-circle"></i> Attente');
    } else {
      statutBadge.addClass('status-secondary').text(statut);
    }

    // Afficher les dates si disponibles
    if (dateDebut) {
      $('#detailDateDebut').text(new Date(dateDebut).toLocaleDateString('fr-FR'));
    } else {
      $('#detailDateDebut').text('Non définie');
    }

    if (dateFin) {
      $('#detailDateFin').text(new Date(dateFin).toLocaleDateString('fr-FR'));
    } else {
      $('#detailDateFin').text('Non définie');
    }

    // Charger les autres statuts du chauffeur
    loadAutresStatuts(chauffeurId);

    // Afficher la modale
    const modal = $('#statutDetailsModal');
    modal.addClass('show');
    modal.css('display', 'flex');
  });

  // Fermeture de la modale des détails du statut avec délégation d'événements
  $(document).on('click', '#closeStatutDetailsModal', function() {
    const modal = $('#statutDetailsModal');
    modal.removeClass('show');
    modal.css('display', 'none');
  });

  // Fermeture par clic sur l'overlay
  $('#statutDetailsModal').on('click', function(e) {
    if (e.target === this) {
      $(this).removeClass('show');
    }
  });

  // Gestion du bouton de modification de statut avec délégation d'événements
  // Cela permet de gérer les boutons ajoutés dynamiquement après AJAX
  $(document).on('click', '.edit-statut-btn', function(e) {
    e.preventDefault();
    const chauffeurId = $(this).data('id');
    const chauffeurNom = $(this).data('nom');
    const chauffeurPrenom = $(this).data('prenom');

    console.log('Ouverture modal statut pour chauffeur:', chauffeurId, chauffeurNom, chauffeurPrenom);

    // Remplir l'ID du chauffeur dans la modale
    $('#chauffeurId').val(chauffeurId);

    // Réinitialiser le formulaire pour éviter les données résiduelles
    $('#editStatutChauffeurForm')[0].reset();
    $('#chauffeurId').val(chauffeurId); // Remettre l'ID après reset

    // Afficher la modale avec toutes les propriétés nécessaires
    const modal = $('#editStatutChauffeurModal');
    modal.removeClass('show').addClass('show'); // Force refresh
    modal.css('display', 'flex');
    modal.removeAttr('hidden');
    modal.attr('aria-hidden', 'false');

    // Focus sur le premier champ pour améliorer l'UX
    setTimeout(() => {
      modal.find('select[name="statut"]').focus();
    }, 100);
  });

  // Fermeture de la modale avec délégation d'événements
  $(document).on('click', '#closeEditStatutModal, #cancelEditStatut', function() {
    const modal = $('#editStatutChauffeurModal');
    modal.removeClass('show');
    modal.css('display', 'none');
    modal.attr('hidden', '');
    modal.attr('aria-hidden', 'true');
    $('#editStatutChauffeurForm')[0].reset();

    console.log('Modal statut fermée');
  });

  // Fermeture par clic sur l'overlay
  $('#editStatutChauffeurModal').on('click', function(e) {
    if (e.target === this) {
      $(this).removeClass('show');
      $('#editStatutChauffeurForm')[0].reset();
    }
  });

  // Raccourcis de dates
  $('.shortcut-btn').on('click', function() {
    const shortcut = $(this).data('shortcut');
    const now = new Date();
    let startDate, endDate;

    switch(shortcut) {
      case 'today':
        startDate = new Date(now);
        endDate = new Date(now);
        endDate.setHours(23, 59, 59);
        break;
      case 'tomorrow':
        startDate = new Date(now);
        startDate.setDate(now.getDate() + 1);
        startDate.setHours(0, 0, 0);
        endDate = new Date(startDate);
        endDate.setHours(23, 59, 59);
        break;
      case 'this-weekend':
        // Samedi de cette semaine
        startDate = new Date(now);
        const daysToSaturday = 6 - now.getDay();
        startDate.setDate(now.getDate() + daysToSaturday);
        startDate.setHours(0, 0, 0);
        // Dimanche
        endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 1);
        endDate.setHours(23, 59, 59);
        break;
      case 'next-week':
        // Lundi de la semaine prochaine
        startDate = new Date(now);
        const daysToNextMonday = (8 - now.getDay()) % 7;
        startDate.setDate(now.getDate() + daysToNextMonday);
        startDate.setHours(0, 0, 0);
        // Vendredi de la semaine prochaine
        endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 4);
        endDate.setHours(23, 59, 59);
        break;
    }

    // Formater les dates pour les inputs datetime-local
    const formatDateTime = (date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    };

    $('input[name="date_debut"]').val(formatDateTime(startDate));
    $('input[name="date_fin"]').val(formatDateTime(endDate));
  });



  // Gestion du bouton de suppression
  $('.delete-chauffeur-btn').on('click', function(e) {
    e.preventDefault();
    const chauffeurId = $(this).data('id');

    // Utiliser SweetAlert2 si disponible
    if (typeof Swal !== 'undefined') {
      Swal.fire({
        title: 'Êtes-vous sûr ?',
        text: "Cette action est irréversible !",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Oui, supprimer',
        cancelButtonText: 'Annuler'
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            url: '/admin/supprimer_chauffeur_ajax/' + chauffeurId,
            method: 'POST',
            success: function(resp) {
              if (resp.success) {
                Swal.fire('Supprimé !', 'Le chauffeur a été supprimé.', 'success').then(() => {
                  // Supprimer la ligne du tableau
                  $('tr[data-chauffeur-id="' + chauffeurId + '"]').fadeOut(300, function() {
                    $(this).remove();
                  });
                });
              } else {
                Swal.fire('Erreur', resp.message || 'Erreur lors de la suppression', 'error');
              }
            },
            error: function() {
              Swal.fire('Erreur', 'Erreur lors de la suppression', 'error');
            }
          });
        }
      });
    } else {
      if (confirm('Voulez-vous vraiment supprimer ce chauffeur ?')) {
        $.ajax({
          url: '/admin/supprimer_chauffeur_ajax/' + chauffeurId,
          method: 'POST',
          success: function(resp) {
            if (resp.success) {
              alert('Chauffeur supprimé avec succès !');
              // Supprimer la ligne du tableau
              $('tr[data-chauffeur-id="' + chauffeurId + '"]').fadeOut(300, function() {
                $(this).remove();
              });
            } else {
              alert(resp.message || 'Erreur lors de la suppression');
            }
          },
          error: function() {
            alert('Erreur lors de la suppression');
          }
        });
      }
    }
  });

  // Gestion de l'impression de la liste des chauffeurs (identique vidange/carburation)
  $('#printChauffeursList').on('click', function() {
    printChauffeursListeStandardized();
  });

  // Gestion de l'impression de la planification (identique vidange/carburation)
  $('#printChauffeursPlanning').on('click', function() {
    // Récupérer les données de planification via AJAX
    $.ajax({
      url: '/admin/get_chauffeurs_planning_ajax',
      method: 'GET',
      success: function(response) {
        if (response.success && response.planning) {
          generatePlanningTableFromAjax(response.planning);
          printPlanningTableStandardized();
        } else {
          // Si pas d'endpoint AJAX, générer à partir des données de la page
          generatePlanningFromPage();
          printPlanningTableStandardized();
        }
      },
      error: function() {
        // Fallback: générer à partir des données de la page
        generatePlanningFromPage();
        printPlanningTableStandardized();
      }
    });
  });
});

// ANCIENNES FONCTIONS SUPPRIMÉES - Remplacées par les fonctions dans chauffeurs_print.js

// Fonction pour charger les autres statuts du chauffeur
function loadAutresStatuts(chauffeurId) {
  const container = $('#autresStatutsList');
  container.html('<div class="loading-text"><i class="fas fa-spinner fa-spin"></i> Chargement des statuts...</div>');

  $.ajax({
    url: `/admin/get_statuts_chauffeur_ajax/${chauffeurId}`,
    method: 'GET',
    success: function(response) {
      if (response.success && response.statuts) {
        if (response.statuts.length === 0) {
          container.html('<div style="color:#6b7280; text-align: center; padding: 20px;">Aucun statut trouvé.</div>');
        } else {
          let html = '';
          response.statuts.forEach(function(statut) {
            const dateDebut = statut.date_debut ? new Date(statut.date_debut).toLocaleDateString('fr-FR') : 'Non définie';
            const dateFin = statut.date_fin ? new Date(statut.date_fin).toLocaleDateString('fr-FR') : 'Non définie';

            let statutLabel = statut.statut;
            let statutClass = 'secondary';
            let statutIcon = 'question-circle';

            if (statut.statut === 'CONGE') {
              statutLabel = 'Congé';
              statutClass = 'warning';
              statutIcon = 'calendar-times';
            } else if (statut.statut === 'PERMANENCE') {
              statutLabel = 'Permanence';
              statutClass = 'info';
              statutIcon = 'clock';
            } else if (statut.statut === 'SERVICE_WEEKEND') {
              statutLabel = 'Week-end';
              statutClass = 'secondary';
              statutIcon = 'calendar-week';
            } else if (statut.statut === 'SERVICE_SEMAINE') {
              statutLabel = 'Semaine';
              statutClass = 'primary';
              statutIcon = 'calendar-day';
            }

            // Déterminer le lieu
            let lieuDisplay = 'Attente';
            if (statut.lieu === 'CUM') {
              lieuDisplay = '<i class="fas fa-building"></i> CUM';
            } else if (statut.lieu === 'CAMPUS') {
              lieuDisplay = '<i class="fas fa-university"></i> Campus';
            } else if (statut.lieu === 'CONJOINTEMENT') {
              lieuDisplay = 'Conjointement';
            }

            html += `
              <div class="statut-item" data-statut-id="${statut.id}">
                <div class="statut-item-content">
                  <div>
                    <span class="status-badge ${statutClass}">
                      <i class="fas fa-${statutIcon}"></i> ${statutLabel}
                    </span>
                    <span style="margin-left: 10px; color: #6b7280;">${lieuDisplay}</span>
                  </div>
                  <div class="text-small">
                    <i class="fas fa-calendar"></i> ${dateDebut} → ${dateFin}
                  </div>
                </div>
                <div class="statut-item-actions">
                  <button class="statut-action-btn edit"
                          onclick="editIndividualStatut(${statut.id}, ${chauffeurId}, '${statut.statut}', '${statut.lieu}', '${statut.date_debut}', '${statut.date_fin}')"
                          title="Modifier ce statut">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="statut-action-btn delete"
                          onclick="deleteIndividualStatut(${statut.id}, '${statutLabel}')"
                          title="Supprimer ce statut">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            `;
          });
          container.html(html);
        }
      } else {
        container.html('<div style="color:#ef4444; text-align: center; padding: 20px;">Erreur lors du chargement des statuts.</div>');
      }
    },
    error: function() {
      container.html('<div style="color:#ef4444; text-align: center; padding: 20px;">Erreur lors du chargement des statuts.</div>');
    }
  });
}

function formatDateTime(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${year}-${month}-${day}T${hours}:${minutes}`;
}

// Fonction pour modifier un statut individuel
function editIndividualStatut(statutId, chauffeurId, statut, lieu, dateDebut, dateFin) {
  // Remplir le formulaire
  $('#individualStatutId').val(statutId);
  $('#individualChauffeurId').val(chauffeurId);
  $('#individualStatut').val(statut);
  $('#individualLieu').val(lieu);

  // Convertir les dates au format datetime-local
  const formatDateForInput = (dateStr) => {
    const date = new Date(dateStr);
    return date.toISOString().slice(0, 16);
  };

  $('#individualDateDebut').val(formatDateForInput(dateDebut));
  $('#individualDateFin').val(formatDateForInput(dateFin));

  // Ouvrir la modal
  $('#editIndividualStatutModal').addClass('show');
}

// Fonction pour supprimer un statut individuel
function deleteIndividualStatut(statutId, statutLabel) {
  // Fermer la modal de détails avant d'afficher la confirmation
  const detailsModal = document.getElementById('statutDetailsModal');
  if (detailsModal) {
    detailsModal.classList.remove('show');
    detailsModal.style.display = 'none';
  }

  // Attendre un peu pour que la modal se ferme complètement
  setTimeout(() => {
    if (typeof Swal !== 'undefined') {
      Swal.fire({
        title: 'Confirmer la suppression',
        text: `Voulez-vous vraiment supprimer ce statut "${statutLabel}" ?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3b82f6', // Couleur bleue pour le titre
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Oui, supprimer',
        cancelButtonText: 'Annuler',
        customClass: {
          confirmButton: 'swal-confirm-delete',
          title: 'swal-title-blue'
        }
      }).then((result) => {
        if (result.isConfirmed) {
          performDeleteStatut(statutId);
        } else {
          // Si annulé, rouvrir la modal de détails
          if (detailsModal) {
            detailsModal.classList.add('show');
            detailsModal.style.display = 'flex';
          }
        }
      });
    } else {
      if (confirm(`Voulez-vous vraiment supprimer ce statut "${statutLabel}" ?`)) {
        performDeleteStatut(statutId);
      } else {
        // Si annulé, rouvrir la modal de détails
        if (detailsModal) {
          detailsModal.classList.add('show');
          detailsModal.style.display = 'flex';
        }
      }
    }
  }, 200);
}

// Fonction pour effectuer la suppression
function performDeleteStatut(statutId) {
  const formData = new FormData();
  formData.append('statut_id', statutId);

  fetch('/admin/supprimer_statut_individuel_ajax', {
    method: 'POST',
    body: formData,
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      if (typeof Swal !== 'undefined') {
        Swal.fire('Supprimé!', data.message, 'success');
      } else {
        alert(data.message);
      }

      // Recharger la liste des statuts dans la modal de détails
      const modal = document.getElementById('statutDetailsModal');
      if (modal && modal.classList.contains('show')) {
        const chauffeurId = $('#detailChauffeurNom').data('chauffeur-id');
        if (chauffeurId) {
          loadAutresStatuts(chauffeurId);
        }
      }

      // Rafraîchir les données de la page
      if (typeof FormModalManager !== 'undefined' && FormModalManager.refreshPageData) {
        FormModalManager.refreshPageData();
        FormModalManager.reattachEventListeners();
      }
    } else {
      if (typeof Swal !== 'undefined') {
        Swal.fire('Erreur', data.message, 'error');
      } else {
        alert('Erreur: ' + data.message);
      }
    }
  })
  .catch(error => {
    console.error('Erreur:', error);
    if (typeof Swal !== 'undefined') {
      Swal.fire('Erreur', 'Erreur de communication avec le serveur', 'error');
    } else {
      alert('Erreur de communication avec le serveur');
    }
  });
}
</script>
{% endblock %}
