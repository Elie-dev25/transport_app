{% extends "roles/admin/_base_admin.html" %}

{% block title %}Bus AED{% endblock %}

{% set active_page = 'bus' %}
{% set page_title = 'Liste des Bus AED' %}

{% block extra_head %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      /* Styles spécifiques à la page Bus AED */
      #docFormModal, #addBusModal {
        z-index: 10000;
      }

      /* Styles pour les détails de bus */
      .details-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .details-list li {
        margin: 6px 0;
      }

      /* Indicateurs colorés */
      .indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
      }
      .green { background: #10b981; }
      .orange { background: #f59e0b; }
      .red { background: #ef4444; }

      /* Bouton fermeture personnalisé si nécessaire */
      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
      }
    </style>
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-body">
            <div style="display:flex;justify-content:flex-end;margin-bottom:12px;">
                <button id="openAddBusModal" style="width:42px;height:42px;border:none;border-radius:50%;background:#2563eb;color:#fff;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;" title="Ajouter un AED">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        <table style="width:100%;background:#fff;border-radius:16px;box-shadow:0 4px 24px rgba(30,64,175,0.07);overflow:hidden;">
            <thead style="background:linear-gradient(90deg,#1e3a8a,#2563eb);color:#fff;">
                <tr>
                    <th style="padding:14px;">Numéro</th>
                    <th>Kilométrage</th>
                    <!-- <th>Type Huile</th> -->
                    <!-- <th>Km Critique Huile</th> -->
                    <!-- <th>Km Critique Carburant</th> -->
                    <!-- <th>Dernière Vidange</th> -->
                    <th>État</th>
                    <th>Places</th>
                    <!-- <th>Dernière maintenance</th> -->
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for bus in bus_list %}
                <tr style="text-align:center;">
                    <td style="padding:10px 0;">
                        {{ bus.numero }}
                        {% if not bus.kilometrage or not bus.type_huile or not bus.km_critique_huile or not bus.km_critique_carburant or not bus.date_derniere_vidange %}
                            <i class="fas fa-exclamation-triangle" style="color:#f59e0b;margin-left:5px;" title="Données incomplètes - Nécessite mise à jour"></i>
                        {% endif %}
                    </td>
                    <td>{{ bus.kilometrage if bus.kilometrage else '-' }} {{ 'km' if bus.kilometrage else '' }}</td>
                    <!-- <td>{{ bus.type_huile if bus.type_huile else '-' }}</td> -->
                    <!-- <td>{{ bus.km_critique_huile if bus.km_critique_huile else '-' }} {{ 'km' if bus.km_critique_huile else '' }}</td> -->
                    <!-- <td>{{ bus.km_critique_carburant if bus.km_critique_carburant else '-' }} {{ 'km' if bus.km_critique_carburant else '' }}</td> -->
                    <!-- <td>{{ bus.date_derniere_vidange.strftime('%d/%m/%Y') if bus.date_derniere_vidange else '-' }}</td> -->
                    <td>{{ bus.etat_vehicule|status_label }}</td>
                    <td>{{ bus.nombre_places }}</td>
                    <!-- <td>{{ bus.derniere_maintenance.strftime('%d/%m/%Y') if bus.derniere_maintenance else '' }}</td> -->
                    <td>
                        <button class="view-bus-btn" data-id="{{ bus.id }}" title="Détails" style="background:none;border:none;cursor:pointer;margin-right:6px;">
                            <i class="fas fa-eye" style="color:#2563eb;font-size:18px;"></i>
                        </button>
                        <button class="delete-bus-btn" data-id="{{ bus.id }}" title="Supprimer" style="background:none;border:none;cursor:pointer;">
                            <i class="fas fa-trash" style="color:#ef4444;font-size:18px;"></i>
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="10" style="padding:20px;color:#64748b;">Aucun bus enregistré.</td></tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="quick-actions" style="margin-top:24px;">
            <h2 class="section-title">
                <i class="fas fa-tools"></i>
                Opérations 
            </h2>
            <div class="actions-grid">
                <a href="{{ url_for('admin.carburation') }}" class="action-btn">
                    <i class="fas fa-gas-pump"></i>
                    <span>Carburation</span>
                </a>
                <a href="{{ url_for('admin.vidange') }}" class="action-btn">
                    <i class="fas fa-oil-can"></i>
                    <span>Vidange</span>
                </a>
                <a href="#" id="declare-panne-btn" class="action-btn">
                    <i class="fas fa-triangle-exclamation"></i>
                    <span>Déclaration de panne</span>
                </a>
                <a href="/admin/depanage" class="action-btn" id="depanage-btn">
                    <i class="fas fa-wrench"></i>
                    <span>Dépannage</span>
                </a>
                
            </div>
        </div>
    </div>
</div>

<!-- Modal formulaire document -->
<div id="docFormModal" class="modal">
  <div class="modal-content" style="max-width:500px;">
    <div class="modal-header"><h3>Ajouter un document administratif</h3><button type="button" id="closeDocFormModal" class="close-btn">&times;</button></div>
    <div class="modal-body">
      <form id="docForm">
        <div class="form-group">
          <label>Type de document</label>
          <select name="type_document" required>
            <option value="">-- Choisir --</option>
            <option value="ASSURANCE">Assurance</option>
            <option value="VISITE_TECHNIQUE">Visite Technique</option>
            <option value="VIGNETTE">Vignette</option>
            <option value="FICHE_TECHNIQUE">Fiche Technique</option>
            <option value="CARTE_GRISE">Carte Grise</option>
          </select>
        </div>
        <div class="form-group"><label>Date début</label><input type="date" name="date_debut" required></div>
        <div class="form-group" id="dateExpGroup"><label>Date expiration</label><input type="date" name="date_expiration"></div>
        <div style="text-align:right;margin-top:12px;">
          <button type="submit" class="submit-btn">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal détails bus -->
<div id="busDetailsModal" class="modal">
  <div class="modal-content" style="max-width:500px;">
    <div class="modal-header">
      <h3>Détails du Bus</h3>
      <button type="button" id="closeBusDetailsModal" class="close-btn">&times;</button>
    </div>
    <div class="modal-body" id="busDetailsBody">
      <!-- Contenu injecté via JS -->
    </div>
  </div>
</div>

{% include 'shared/modals/_declaration_panne_modal.html' %}

{% include 'shared/modals/_add_bus_modal.html' %}

<!-- Réutilise la modale d'ajout de bus du dashboard -->
<script>

$(function() {
  // Gestion de la modale d'ajout d'AED
  $('#openAddBusModal').on('click', function(e) {
    e.preventDefault();
    $('#addBusModal').addClass('show');
  });
  
  $('#closeAddBusModal').on('click', function() {
    $('#addBusModal').removeClass('show');
    $('#addBusForm')[0].reset();
  });
  
  // Fermer la modale si on clique en dehors du contenu
  $('#addBusModal').on('click', function(e) {
    if (e.target === this) {
      $(this).removeClass('show');
      $('#addBusForm')[0].reset();
    }
  });
  
  // Soumission du formulaire d'ajout d'AED
  $('#addBusForm').on('submit', function(e) {
    e.preventDefault();
    $.ajax({
      url: '/admin/ajouter_bus_ajax',
      method: 'POST',
      data: $(this).serialize(),
      success: function(resp) {
        $('#addBusModal').removeClass('show');
        $('#addBusForm')[0].reset();
        if (resp.success) {
          Swal.fire('Succès', resp.message, 'success').then(() => {
            location.reload();
          });
        } else {
          Swal.fire('Erreur', resp.message, 'error');
        }
      },
      error: function() {
        Swal.fire('Erreur', 'Impossible d\'ajouter le bus AED', 'error');
      }
    });
  });

  // Gestion des alertes de documents
  function refreshAlerts(){
      $.get('/admin/documents_alerts_ajax', function(resp){
          if(resp.success){
              const alerts = resp.alerts || [];
              $('#alertCount').text(alerts.length);
              if(alerts.length){
                  $('#alertCount').show();
                  const items = alerts.map(a=>{
                      const cls = a.status==='RED' ? 'red' : 'orange';
                      return `<li style="margin:8px 0;font-size:14px;"><span class='indicator ${cls}'></span>Bus ${a.numero_bus_udm} – ${a.type_document}<br><small style='color:#64748b'>${a.reste} restant (exp. ${a.date_expiration})</small></li>`;
                  }).join('');
                  $('#alertList').html(items);
              }else{
                  $('#alertCount').hide();
                  $('#alertList').html('<li style="padding:10px;color:#64748b">Aucune alerte</li>');
              }
          }
      });

  // Variable globale pour stocker les données du bus sélectionné
  window.selectedBusData = null;
  // Index des AED par numéro pour autocomplétion
  window.busUdMIndexByNumero = {};
  // Charger la liste des AED pour alimenter le datalist de la modale panne
  function loadAedListForDatalist(){
    $.get('/admin/bus_udm_list_ajax', function(resp){
      if(resp && resp.success){
        const list = resp.bus_udm || [];
        const options = list.map(b=>{
          // Construire un index pour auto-fill
          window.busUdMIndexByNumero[b.numero] = b;
          const label = b.immatriculation ? `${b.numero} — ${b.immatriculation}` : b.numero;
          return `<option value="${b.numero}" label="${label}"></option>`;
        }).join('');
        // Datalist du partiel: #busUdMNumerosList
        $('#busUdMNumerosList').html(options);
      }
    });
  }
  loadAedListForDatalist();

  // Quand le numéro Bus UdM est saisi/sélectionné, auto-remplir immatriculation et borne min km
  $(document).on('input change', '#numero_bus_udm_panne', function(){
    const num = $(this).val();
    const b = window.busUdMIndexByNumero[num];
    if(b){
      $('#immatriculation_panne').val(b.immatriculation || '');
      // Définir la borne minimale pour le kilométrage
      const minKm = (b.kilometrage != null && b.kilometrage !== '') ? Number(b.kilometrage) : 0;
      $('#kilometrage_panne').attr('min', minKm);
    }
    else{
      // Si numéro inconnu, pas de contrainte spécifique (min=0)
      $('#immatriculation_panne').val('');
      $('#kilometrage_panne').attr('min', 0);
    }
  });

  // Bouton Déclaration de panne
  $(document).on('click', '#declare-panne-btn', function(e){
    e.preventDefault();
    // Pré-remplir si un bus est sélectionné, sinon vider
    if (window.selectedBusData) {
      $('#numero_bus_udm_panne').val(window.selectedBusData.numero || '');
      $('#immatriculation_panne').val(window.selectedBusData.immatriculation || '');
    } else {
      $('#numero_bus_udm_panne').val('');
      $('#immatriculation_panne').val('');
    }
    // Le kilométrage doit toujours être saisi par l'utilisateur
    $('#kilometrage_panne').val('');
    // Initialiser min selon numéro sélectionné (si déjà présent)
    const num = $('#numero_bus_udm_panne').val();
    const b = window.busUdMIndexByNumero[num];
    const minKm = b && (b.kilometrage != null && b.kilometrage !== '') ? Number(b.kilometrage) : 0;
    $('#kilometrage_panne').attr('min', minKm);
    // Ouvrir la modale de déclaration de panne
    $('#panneModal').removeAttr('hidden').addClass('show').attr('aria-hidden','false');
  });

  // Fermeture modale panne
  $('#closePanneModal, #cancelPanneBtn').on('click', function(){
    $('#panneModal').removeClass('show');
    $('#panneForm')[0].reset();
  });

  // Soumission formulaire panne
  $('#panneForm').on('submit', function(e){
    e.preventDefault();
    const formData = {
      numero_bus_udm: $('#numero_bus_udm_panne').val(),
      immatriculation: $('#immatriculation_panne').val(),
      kilometrage: $('#kilometrage_panne').val(),
      description: $('#description_panne').val(),
      criticite: $('#criticite_panne').val(),
      immobilisation: $('#immobilisation_panne').is(':checked')
    };

    // Validation client: numéro AED doit exister dans la liste
    const numTrim = (formData.numero_bus_udm || '').trim();
    if (!numTrim || !window.busUdMIndexByNumero[numTrim]) {
      Swal.fire('Erreur', 'Numéro Bus UdM inconnu. Veuillez sélectionner un numéro existant.', 'error');
      return;
    }

    // Validation client: kilometrage >= min si un AED est reconnu
    const selected = window.busUdMIndexByNumero[formData.numero_bus_udm];
    const kmVal = formData.kilometrage !== '' ? Number(formData.kilometrage) : NaN;
    const minAttr = Number($('#kilometrage_panne').attr('min') || 0);
    if (Number.isNaN(kmVal)) {
      Swal.fire('Erreur', 'Veuillez renseigner le kilométrage.', 'error');
      return;
    }
    if (kmVal < minAttr) {
      Swal.fire('Erreur', `Le kilométrage doit être supérieur ou égal à ${minAttr}.`, 'error');
      return;
    }

    $.ajax({
      url: '/admin/declarer_panne',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(formData),
      success: function(resp){
        if(resp.success){
          Swal.fire('Succès', resp.message, 'success');
          $('#panneModal').removeClass('show').attr('aria-hidden','true').attr('hidden','');
          $('#panneForm')[0].reset();
          // Rafraîchir la page pour voir les changements d'état
          setTimeout(() => location.reload(), 1500);
        } else {
          Swal.fire('Erreur', resp.message, 'error');
        }
      },
      error: function(){
        Swal.fire('Erreur', 'Impossible d\'enregistrer la panne', 'error');
      }
    });
  });
  }
  refreshAlerts();
  setInterval(refreshAlerts, 30000);
  $('.notification-bell').on('click', function(){ $('#alertPanel').toggle(); });
  $(document).on('click', '.delete-bus-btn', function(e) {
    e.preventDefault();
    const busId = $(this).data('id');
    Swal.fire({
      title: 'Êtes-vous sûr ?',
      text: "Cette action est irréversible !",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Oui, supprimer',
      cancelButtonText: 'Annuler'
    }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          url: '/admin/supprimer_bus_ajax/' + busId,
          method: 'POST',
          success: function(resp) {
            if (resp.success) {
              location.reload();
            } else {
              alert(resp.message || 'Erreur lors de la suppression');
            }
          },
          error: function() {
            alert('Erreur lors de la suppression');
          }
        });
      }
    });
  });

  $(document).on('click', '.view-bus-btn', function(e) {
    e.preventDefault();
    const busId = $(this).data('id');
    window.selectedBusId = busId;
    $.ajax({
      url: '/admin/details_bus_ajax/' + busId,
      method: 'GET',
      success: function(resp) {
        if (resp.success) {
          const b = resp.bus;
          // Stocker les données du bus sélectionné pour la déclaration de panne
          window.selectedBusData = {
            numero: b.numero,
            immatriculation: b.immatriculation || '',
            kilometrage: b.kilometrage || ''
          };
          let docsHtml = '';
          if(resp.documents && resp.documents.length){
            docsHtml = '<h4 style="margin-top:12px;">Documents administratifs</h4>'+
                        '<table style="width:100%;border-collapse:collapse;font-size:14px;margin-top:6px;">'+
                        '<thead><tr style="background:#f3f4f6;"><th style="padding:6px 8px;text-align:left;">Type</th><th style="padding:6px 8px;text-align:left;">Début</th><th style="padding:6px 8px;text-align:left;">Expiration</th></tr></thead><tbody>'+
                        resp.documents.map(d=>{
                            let cls='green';
                            if(d.status==='ORANGE') cls='orange';
                            else if(d.status==='RED') cls='red';
                            return `<tr><td style='padding:6px 8px;'><span class='indicator ${cls}'></span>${d.type_document}</td><td style='padding:6px 8px;'>${d.date_debut}</td><td style='padding:6px 8px;'>${d.date_expiration}</td></tr>`;
                        }).join('')+
                        '</tbody></table>';
          }else{
            docsHtml = '<p style="margin-top:12px;color:#64748b;">Aucun document administratif enregistré.</p>';
          }
          const html = `<ul class="details-list">
              <li><strong>Numéro :</strong> ${b.numero}</li>
              <li><strong>Kilométrage :</strong> ${b.kilometrage || '-'} ${b.kilometrage ? 'km' : ''}</li>
              <li><strong>Type d'huile :</strong> ${b.type_huile || '-'}</li>
              <li><strong>Km critique huile :</strong> ${b.km_critique_huile || '-'} ${b.km_critique_huile ? 'km' : ''}</li>
              <li><strong>Km critique carburant :</strong> ${b.km_critique_carburant || '-'} ${b.km_critique_carburant ? 'km' : ''}</li>
              <li><strong>Capacité réservoir :</strong> ${b.capacite_reservoir_litres != null ? b.capacite_reservoir_litres + ' L' : '-'}</li>
              <li><strong>Niveau carburant actuel :</strong>
                <input type="number" step="0.1" id="niveauCarbInput" value="${b.niveau_carburant_litres != null ? b.niveau_carburant_litres : ''}" style="width:120px;"> L
                <button id="saveNiveauCarbBtn" class="submit-btn" style="padding:4px 8px;margin-left:8px;">Mettre à jour</button>
              </li>
              <li><strong>Dernière vidange :</strong> ${b.date_derniere_vidange || '-'}</li>
              <li><strong>État :</strong> ${b.etat_vehicule === 'DEFAILLANT' ? 'HORS_SERVICE' : b.etat_vehicule}</li>
              <li><strong>Places :</strong> ${b.nombre_places}</li>
              <li><strong>Dernière maintenance :</strong> ${b.derniere_maintenance || '-'}</li>
            </ul>${docsHtml}
            <div style="text-align:right;margin-top:16px;">
              <button id="updateAdminBtn" class="submit-btn" style="padding:8px 16px;">Mettre à jour</button>
            </div>`;
          $('#busDetailsBody').html(html);
          // attach click after injection
          $('#updateAdminBtn').on('click', function(){
            $('#busDetailsModal').removeClass('show');
            $('#docFormModal').addClass('show');
          });
          // update fuel level
          $('#saveNiveauCarbBtn').on('click', function(){
            const val = $('#niveauCarbInput').val();
            $.ajax({
              url: '/admin/mettre_a_jour_niveau_carburant_ajax/' + busId,
              method: 'POST',
              data: { niveau_carburant_litres: val },
              success: function(resp){
                if(resp.success){
                  Swal.fire('Succès', 'Niveau carburant mis à jour.', 'success');
                }else{
                  Swal.fire('Erreur', resp.message || 'Mise à jour impossible', 'error');
                }
              },
              error: function(){
                Swal.fire('Erreur', 'Mise à jour impossible', 'error');
              }
            });
          });
          $('#busDetailsModal').addClass('show');
        } else {
          Swal.fire('Erreur', resp.message || 'Impossible de charger les détails', 'error');
        }
      },
      error: function() {
        Swal.fire('Erreur', 'Impossible de charger les détails', 'error');
      }
    });
  });
  // Soumission formulaire document
  // Masquer la date de fin si Carte Grise
$('select[name="type_document"]').on('change', function(){
  if($(this).val()==='CARTE_GRISE'){
    $('#dateExpGroup').hide();
    $('#dateExpGroup input').val('');
  }else{
    $('#dateExpGroup').show();
  }
}).trigger('change');

$('#docForm').on('submit', function(e){
    e.preventDefault();
    const formData = $(this).serialize();
    $.post('/admin/ajouter_document_aed_ajax/'+window.selectedBusId, formData, function(resp){
      if(resp.success){
        Swal.fire('Succès', resp.message, 'success');
        $('#docFormModal').removeClass('show');
      }else{
        Swal.fire('Erreur', resp.message, 'error');
      }
    });
  });

  $('#closeDocFormModal').on('click', function(){ $('#docFormModal').removeClass('show'); });

  // Gestion de la fermeture du modal détails
  $('#closeBusDetailsModal').on('click', function(){ $('#busDetailsModal').removeClass('show'); });
  $('#busDetailsModal').on('click', function(e){ if(e.target === this){ $(this).removeClass('show'); }});
});
</script>
{% endblock %}

{% block extra_scripts %}
<script>
$(function() {
  // Gestion de la modale d'ajout d'AED
  $('#openAddBusModal').on('click', function(e) {
    e.preventDefault();
    $('#addBusModal').addClass('show');
  });

  $('#closeAddBusModal').on('click', function() {
    $('#addBusModal').removeClass('show');
    $('#addBusForm')[0].reset();
  });

  // Fermer la modale si on clique en dehors du contenu
  $('#addBusModal').on('click', function(e) {
    if (e.target === this) {
      $(this).removeClass('show');
      $('#addBusForm')[0].reset();
    }
  });

  // Soumission du formulaire d'ajout d'AED
  $('#addBusForm').on('submit', function(e) {
    e.preventDefault();
    $.ajax({
      url: '/admin/ajouter_bus_ajax',
      method: 'POST',
      data: $(this).serialize(),
      success: function(resp) {
        $('#addBusModal').removeClass('show');
        $('#addBusForm')[0].reset();
        if (resp.success) {
          Swal.fire('Succès', resp.message, 'success').then(() => {
            location.reload();
          });
        } else {
          Swal.fire('Erreur', resp.message, 'error');
        }
      },
      error: function() {
        Swal.fire('Erreur', 'Impossible d\'ajouter le bus AED', 'error');
      }
    });
  });

  // Autres scripts de la page (alertes, détails, etc.)
  function refreshAlerts(){
    $('.alert-indicator').each(function(){
      const $indicator = $(this);
      const busId = $indicator.data('bus-id');
      if (!busId) return;

      $.get('/admin/bus_alerts/' + busId, function(data){
        const hasAlerts = data.vidange_due || data.assurance_expire || data.visite_due;
        $indicator.toggleClass('has-alerts', hasAlerts);

        let tooltip = '';
        if (data.vidange_due) tooltip += 'Vidange due\\n';
        if (data.assurance_expire) tooltip += 'Assurance expire\\n';
        if (data.visite_due) tooltip += 'Visite technique due\\n';

        $indicator.attr('title', tooltip.trim());
      }).fail(function(){
        console.warn('Impossible de récupérer les alertes pour le bus', busId);
      });
    });
  }

  refreshAlerts();
  setInterval(refreshAlerts, 300000);

  // Gestion des détails de bus
  $(document).on('click', '.view-details-btn', function(e){
    e.preventDefault();
    const busId = $(this).data('id');

    $.get('/admin/bus_details/' + busId, function(data){
      if (data.success) {
        const bus = data.bus;
        $('#busDetailsModal .modal-body').html(`
          <div class="details-grid">
            <div class="detail-item">
              <strong>Numéro:</strong> ${bus.numero || '-'}
            </div>
            <div class="detail-item">
              <strong>Immatriculation:</strong> ${bus.immatriculation || '-'}
            </div>
            <div class="detail-item">
              <strong>Marque:</strong> ${bus.marque || '-'}
            </div>
            <div class="detail-item">
              <strong>Modèle:</strong> ${bus.modele || '-'}
            </div>
            <div class="detail-item">
              <strong>Kilométrage:</strong> ${bus.kilometrage || '-'} km
            </div>
            <div class="detail-item">
              <strong>État:</strong> <span class="indicator ${bus.etat === 'OPERATIONNEL' ? 'green' : 'orange'}"></span> ${bus.etat || '-'}
            </div>
          </div>
        `);
        $('#busDetailsModal').addClass('show');
      } else {
        Swal.fire('Erreur', data.message || 'Impossible de charger les détails', 'error');
      }
    }).fail(function(){
      Swal.fire('Erreur', 'Erreur de connexion', 'error');
    });
  });

  // Fermeture des modales
  $('#closeDocFormModal').on('click', function(){ $('#docFormModal').removeClass('show'); });
  $('#closeBusDetailsModal').on('click', function(){ $('#busDetailsModal').removeClass('show'); });
  $('#busDetailsModal').on('click', function(e){ if(e.target === this){ $(this).removeClass('show'); }});

  // Scripts Déclaration de Panne
  $(document).off('click', '#declare-panne-btn').on('click', '#declare-panne-btn', function(e){
    e.preventDefault();
    // Pré-remplir si un bus est sélectionné, sinon vider
    if (window.selectedBusData) {
      $('#numero_bus_udm_panne').val(window.selectedBusData.numero || '');
      $('#immatriculation_panne').val(window.selectedBusData.immatriculation || '');
    } else {
      $('#numero_bus_udm_panne').val('');
      $('#immatriculation_panne').val('');
    }
    // Définir le kilométrage minimum
    const b = window.selectedBusData;
    const minKm = b && (b.kilometrage != null && b.kilometrage !== '') ? Number(b.kilometrage) : 0;
    $('#kilometrage_panne').attr('min', minKm);
    // Ouvrir la modale de déclaration de panne
    $('#panneModal').removeAttr('hidden').addClass('show').attr('aria-hidden','false');
  });

  // Fermeture modale panne
  $('#closePanneModal, #cancelPanneBtn').off('click').on('click', function(){
    $('#panneModal').removeClass('show').attr('aria-hidden','true').attr('hidden','');
    $('#panneForm')[0].reset();
  });

  // Fermer en cliquant en dehors
  $('#panneModal').off('click').on('click', function(e){
    if (e.target === this) {
      $(this).removeClass('show').attr('aria-hidden','true').attr('hidden','');
      $('#panneForm')[0].reset();
    }
  });

  // Soumission formulaire panne
  $(document).off('submit', '#panneForm').on('submit', '#panneForm', function(e){
    e.preventDefault();
    const formData = {
      numero_bus_udm: $('#numero_bus_udm_panne').val(),
      immatriculation: $('#immatriculation_panne').val(),
      kilometrage: $('#kilometrage_panne').val(),
      description: $('#description_panne').val(),
      criticite: $('#criticite_panne').val(),
      immobilisation: $('#immobilisation_panne').is(':checked')
    };

    const numTrim = (formData.numero_bus_udm || '').trim();
    if (!numTrim || !window.busUdMIndexByNumero || !window.busUdMIndexByNumero[numTrim]) {
      Swal.fire('Erreur', 'Numéro Bus UdM inconnu. Veuillez sélectionner un numéro existant.', 'error');
      return;
    }
    const kmVal = formData.kilometrage !== '' ? Number(formData.kilometrage) : NaN;
    const minAttr = Number($('#kilometrage_panne').attr('min') || 0);
    if (Number.isNaN(kmVal)) {
      Swal.fire('Erreur', 'Veuillez renseigner le kilométrage.', 'error');
      return;
    }
    if (kmVal < minAttr) {
      Swal.fire('Erreur', `Le kilométrage doit être supérieur ou égal à ${minAttr}.`, 'error');
      return;
    }

    $.ajax({
      url: '/admin/declarer_panne',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(formData),
      success: function(resp){
        if(resp.success){
          Swal.fire('Succès', resp.message, 'success');
          $('#panneModal').removeClass('show').attr('aria-hidden','true').attr('hidden','');
          $('#panneForm')[0].reset();
          // Rafraîchir la page pour voir les changements d'état
          setTimeout(() => location.reload(), 1200);
        } else {
          Swal.fire('Erreur', resp.message, 'error');
        }
      },
      error: function(){
        Swal.fire('Erreur', 'Erreur lors de la déclaration de panne', 'error');
      }
    });
  });
});
</script>
        </div>
    </div>
</div>
{% endblock %}